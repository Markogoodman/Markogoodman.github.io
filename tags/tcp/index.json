[{"content":"Writting down some notes when tring to understand these 2 things.\nSome prerequisites Optional:\nNeural Networks Visualized Video\nA blog post about LSTM\nThese 2 are the earlier version of AI. It describes what neural network is and how LSTM improves it.\nNot directly related to Attention and Transformer.\nRequired:\nWord embedding. But no need to go deep. Just need to know that a matrix is used to represent a word\u0026rsquo;s meaning in a vector space.\nWhen 2 words are similar, we expect them to be close in the vector space.\nTake 10 minutes to watch the word embedding section: https://www.youtube.com/watch?v=wjZofJX0v4M\nAttention I watched this Attention video: https://www.youtube.com/watch?v=eMlx5fFNoYc\nTo put it simple, attention is a mechanism to update the embeddings of each word(token).\nThe input of an attention is a series of tokens with their embeddings, which represent their meanings.\nAttention will then run a process to update embeddings, so they contain rich-context information.\nEach attention would have a few pre-trained parameters, Query Matrix (Wq), Key Matrix (Wk), Value Matrix (Wv).\nWhen we want to udpate token xi\u0026rsquo;s embedding, the process is\nxi Â· Wq to generate a query Qi for all other xj, calculate xj Â· Wk to generate the Kj find the relevance(weight) between xj and xi by calculating the inner product of the above 2 output matrices (Qi and Kj, j != i) use softmax to normalize the values xj Â· Wv = Vj. sum of Vj * normalized weight (0~1) is what we add back to xi as the update Sementic meaning\nQi (Query) â†’ To update token xi, what information do we need from other tokens?\nKj (Key) â†’ When other tokens ask me to evaluate how relevant I am to them, how do I respond?\nxj Â· Wv = Vj (Value) -\u0026gt; When other tokens want to update themselves using my embedding, what do I give them?\nWq, Wk, Wv are pretrained parameters and are the same for updating all tokens\n[screenshot from 3Blue1Brown]\nThis is roughly how an attention works.\nNoted that the above is called self-attention (in transformer most of stuff is self-attention).\nLet\u0026rsquo;s say we have 2 token sequences (a1~a3, b1~b3) with their own Wq, Wk, Wv.\nIf we calculate the relevance by combining Wqa and Wkb, this is cross attention.\nTransformer Input: Embedding + Positionw\nTransformer layer = (Self-Attention + Feed Forward Networkï¼‰Ã— N\nN layers\nA Transformer layer: 3 things\n1. Multi-Head Self-Attention Each head has its own Query, Key, Value metrices\nAssuming there\u0026rsquo;s 100 dimensions from the input embedding, and there\u0026rsquo;s 5 heads\nThe three metrices would trun the 100 dim into 20 dim\nEach head would do the what attention does to a token xáµ¢:\nUse Wq, Wk, Wv to calculate the updated xi (20 dimensions)\nPlease check Attention section for details\nConcate the results from different heads, then do a transformation to project it back to the original dimension (100)\n2. Add \u0026amp; Norm The output from 1. + original xáµ¢ Do layer normalization (minus average, diveided by std) To avoid the numbers going overflow. Adjust bit by bit.\n3. Feed-Forward Networkï¼ˆFFNï¼‰ Think of it this way\nAttentionï¼šupdate information FFNï¼š It does not act like attention taking context into consideration. Just some business logic transofrmation, independently for each token. Something like FFN(x)=W2Ïƒ(W1x+b1)+b2 ğŸ”¹ 4. Another Add \u0026amp; Norm Stable!\nWhy multiple layers Multiple layers let the model think multiple times about the same sentence.\nSimple example:\nThe book that the student recommended is expensive.\nOne layer can: See that â€œrecommendedâ€ relates to â€œbookâ€\nMix information across tokens\nTwo+ layers can: Resolve who recommended what\nIgnore the distracting phrase â€œthat the studentâ€¦â€\nCorrectly link â€œis expensiveâ€ â†’ â€œbookâ€\nEach layer refines the understanding.\nEncoder / Decoderï¼Ÿ Encoder vs Decoderï¼š can it peek on the future?\nThe visivbility of attention\nEncoderï¼ˆBERT / Embeddingï¼‰ When updating a token, use context from everywhere To understand search / RAG Decoderï¼ˆGPTï¼‰ When updating a token, use context only before this token to generate next token How to use output GPTï¼ˆDecoder-onlyï¼‰ Take updated last token linear + softmax predict token BERTï¼ˆEncoder-onlyï¼‰ to understand classification / search / embedding ","description":"Attention and Transformer!","id":0,"section":"posts","tags":["AI"],"title":"Attention and Transformer","uri":"https://markogoodman.github.io/posts/attention-and-transformer/"},{"content":"Some notes\nReferences:\nhttps://github.com/forthright48/notes/blob/master/books/computer-networking.md\nhttps://blog.yfxie.com/comparison-of-network-gbn-sr-and-tcp/\nä¸­æ–‡ç‰ˆåœ¨ä¸‹é¢\n\u0026mdash; English Version \u0026mdash;\nTransport Layer Two important protocols: UDP and TCP\nThis article will mainly focus on how reliable transmission works.\nTo be reliable\nError checking, checksum Detect lost packets (timeout, etc.) Feedback from receiver to make sure they have received, which might lose as well. Retransmisison It\u0026rsquo;ll be slow if it waits for receiver\u0026rsquo;s feedback after sending every package.\nPipelining mechanism can help. Sender allows to send a few more following packets without receiving the feedback of the current one.\nAutomatic Repeat Request (ARQ) https://blog.yfxie.com/comparison-of-network-gbn-sr-and-tcp/\n2 mechanisms to recover from pipelining error.\nGo-Back-N (GBN) Starting from the unacknowledged packet(base), sender can send n packets -\u0026gt; sliding-window protocol.\nReceiving ack x means packets before x are received.\nWhen timeout, resend packets from the base.\nIf receiver get (n+1)th packet but nth is not arrived, it\u0026rsquo;ll drop it.\nThis allows easier implementation and no need to buffer out of order packets.\nThough there could be more retransmission.\nWhen we lose nth packet, everything after that will need to be resent.\nThe only thing to keep is the number that indicates everything before is received.\nselective repeat\nSender and receiver both have buffer to keep the out of order packets.\nOnly lost packets need to be sent again.\nBut every sent packet needs to have ack(feed). Internet is unreliable\npacket broken packet lost packet order So we need the following mechanisms\nchecksum, error checking ACK, feedback retransmission timer sequence number to handle duplicate and lost packets pipeline to avoid the Stop-and-wait and wasting the bandwidth sliding window to track packet transmission status Go-Back-N for simple implementation selective repeat to reduce retransmission cost TTL for ensuring packet flushing Connection-Oriented Transport: TCP Piggybacking: ack or feedback signal does not go back to sender immediately. Instead, it waits for real data to be transmitted together.\nhttps://notfalse.net/28/tcp-congestion-control#-Fast-Retransmit\nTimeoutInterval usually is EstimatedRTT + 4â‹…DevRTT\nSingle Timer for all unacknowledged packets\nWhen there\u0026rsquo;s timeout, timeout interval is increased, congestion controll. Reset timeout interval when reveiving ack.\nTCP is a combination of GBN and SR\nTCP uses ack like GBN\nTCP\u0026rsquo;s ack mean \u0026ldquo;next-expected-packet\u0026rdquo;, which is slightly different from GBN\nReceiver buffers some unorder packets\nFast retransmission If receiver expects packet x but keeps receiving packets like x+1, x+2 \u0026hellip;, it will buffer these packets. It will also send 3 ack x in a row to let the sender knows that this package might be lost. Sender will resend the packet x before timeout.\nDetails can be found\nhttps://blog.yfxie.com/comparison-of-network-gbn-sr-and-tcp/\nFlow Control To avoid sener sending too much data that receiver cannot handle, sender remembers that the last acknowledged byte and the last sent byte.\nThe unacknowledged packets number will have to be smaller than the window (rwnd, window will be sent to to sender via header)\nCongestion Control To avoid having too many packets on the network causing traffic jam.\nSender maintains a window, the number of unacknowledged packets cannot exceed min(rwnd, cwnd)\nIf there\u0026rsquo;s no traffic jam then increase cwnd, else decrease.\nslow start cwnd starts small, then double when increasing.\nStop when there\u0026rsquo;s tranmission issue, and set ssthresh to cwnd/2.\ncwnd starts from 1 and doules everytime, after reaching ssthresh, it only increases 1 at a time (Congestion Avoidance mode).\nReceiving 3 acks does not mean traffic jame, because other packets arrived correctly. So it\u0026rsquo;s fast recovery mode.\nhttps://github.com/forthright48/notes/blob/master/books/computer-networking.md\n\u0026mdash; ä¸­æ–‡ç‰ˆ \u0026mdash;\nTransport Layer å…©å€‹é‡é» protocol: UDP and TCP\né€™ç¯‡ä¸»è¦è‘—é‡åœ¨å¯é å‚³è¼¸ä¸Š\nå¯é å¿…é ˆè¦\néŒ¯èª¤æª¢æŸ¥ checksum æ‰åŒ…æª¢æŸ¥(timeout, etc.) æ¥æ”¶è€…çš„ feedback (ç¢ºèªæ­£ç¢ºæ¥æ”¶)ï¼Œé€™æ±è¥¿ä¹Ÿæœ‰å¯èƒ½æ‰ é‡å‚³ å¦‚æœ sender å‚³å®Œä¸€å€‹å¾Œå°±ç­‰å›æ‡‰ï¼Œå¤ªæ…¢\næ‰€ä»¥å¯ä»¥ä¸€æ¬¡å‚³å¤šå€‹ï¼ˆpipeliningï¼‰\nå…©æ–¹éƒ½éœ€è¦ buffer ä¸€äº›è³‡æ–™\nAutomatic Repeat Request (ARQ) https://blog.yfxie.com/comparison-of-network-gbn-sr-and-tcp/\nå…©ç¨® pipeline éŒ¯èª¤æ¢å¾©çš„æ©Ÿåˆ¶\nGo-Back-N (GBN) æœ€å¤šå¯ä»¥å‚³é€ n å€‹æ²’è¢« ack çš„ packetsï¼Œå¾æœ€æ—©çš„ unack packet(base) é–‹å§‹ç®— n å€‹ä¹‹å…§æ˜¯å¯ä»¥å‚³é€çš„ -\u0026gt; sliding-window protocol.\nå¾—åˆ° ack xï¼Œä»£è¡¨ x ä¹‹å‰éƒ½æ”¶åˆ°äº†ï¼Œæ‰€ä»¥ sender ä¸æœƒèªçŸ¥åˆ°æœ‰äº¤å‰æ‰ packet çš„æƒ…æ³\ntimeout æ™‚å¾ base é–‹å§‹éƒ½é‡é€\nreceiver æ²’æ”¶åˆ° n å»æ”¶åˆ° n+1 æ™‚ï¼Œæœƒä¸Ÿæ‰ (receive buffer = 1)\nreceiver é€™æ¨£å¯¦ä½œæ¯”è¼ƒç°¡å–®ï¼Œä¸ç”¨ buffer ä¸€å † out of order packetsï¼Œåªè¦è¨˜ä½ä¸‹ä¸€å€‹éœ€è¦å¾—åˆ°çš„ sequence num æ˜¯å•¥å°±å¥½\nç¼ºé»å°±æ˜¯å¯èƒ½é€ æˆæ›´å¤šé‡é€\nç•¶ç¬¬ n å€‹ packet éºå¤±æ™‚ï¼Œä¹‹å¾Œçš„éƒ½è¦é‡é€\nselective repeat æ”¶é€å…©ç«¯éƒ½éœ€è¦æœ‰ bufferï¼Œreceiver å¯ä»¥æš«å­˜ out of order å°åŒ…ï¼Œsender å¯èƒ½åœ¨æ”¶åˆ° n+1 çš„ ack æ™‚ï¼Œé‚„æ²’æ”¶åˆ° n çš„ ackï¼ŒæŸå€‹ packet å£æ‰æˆ–æ‰åŒ…æ™‚åªè¦é‡é€é‚£å€‹å°±å¥½\næ¯å€‹ packet éƒ½è¦å„åˆ¥ ack\nç¸½çµï¼Œä¸å¯é ç¶²è·¯æœƒæœ‰ä¸€äº›å•é¡Œ\nå°åŒ…æå£ å°åŒ…éºå¤± å°åŒ…é †åº\næ‰€ä»¥å¿…é ˆç”¨ä»¥ä¸‹æ©Ÿåˆ¶ä¾†è™•ç†\nchecksum æª¢æŸ¥éŒ¯èª¤ ACK ç¢ºèªæ”¶åˆ°ï¼ˆéºå¤±) é‡é€ timer sequence number è™•ç†é‡è¤‡ã€éºå¤±å°åŒ… pipeline é¿å… Stop-and-wait é€™ç¨®è¶…æ…¢ï¼Œé »å¯¬åˆ©ç”¨ç‡ä¸ä½³ sliding window è¿½è¹¤å°åŒ…æƒ…æ³ ç´¯ç© ackï¼Œgo back n selective retransmission æ¸›å°‘é‡é€æˆæœ¬ TTL for ensuring packet flushing Connection-Oriented Transport: TCP Piggybacking: ack ä¹‹é¡çš„ç¢ºèªè¨Šè™Ÿä¸æœƒé¦¬ä¸Šå‚³å›çµ¦ç™¼é€ç«¯ï¼Œè€Œæ˜¯ç­‰æ¥æ”¶ç«¯ä¹Ÿæƒ³å‚³è³‡æ–™å»ç™¼é€ç«¯æ™‚é †ä¾¿çµ¦\nhttps://notfalse.net/28/tcp-congestion-control#-Fast-Retransmit\nTimeoutInterval é€šå¸¸ç‚º EstimatedRTT+4â‹…DevRTT\nSingle Timer for all unacknowledged packets\nç•¶ timeout å‡ºç¾æ™‚ï¼Œæˆ‘å€‘å¢åŠ  timeout çš„æ™‚é–“ï¼Œcongestion controllï¼Œæ”¶åˆ° ack æ™‚æœƒæ¢å¾©\nTCP æ˜¯ GBN and SR çš„æ··åˆ\nTCP ä¹Ÿæ˜¯ä½¿ç”¨ç´¯è¨ˆå‹çš„ ack (åƒGBN)\nTCP å›æ‡‰çš„ ack ä»£è¡¨ \u0026ldquo;é æœŸæ¥ä¸‹ä¾†æ”¶åˆ°çš„è³‡æ–™\u0026rdquo;ï¼Œèˆ‡ GO back n çš„ \u0026ldquo;ä¹‹å‰çš„éƒ½å·²ç¶“æ”¶åˆ°\u0026rdquo; ç¨å¾®ä¸åŒ\næ¥æ”¶ç«¯æœƒ buffer ä¸€äº› unorder çš„ packetsï¼Œä»¥åŠä¿æŒä¸€å€‹æ¥ä¸‹ä¾†æ‡‰è©²è¦æ”¶åˆ°çš„è³‡æ–™çš„ seq num\nFast retransmission å¦‚æœç›®å‰å¸Œæœ›æ”¶åˆ° xï¼Œä½†æ˜¯ä¸€ç›´æ”¶åˆ°éé æœŸçš„å°åŒ…(x+1, x+2\u0026hellip;)ï¼Œæœƒæš«å­˜é€™äº›å°åŒ…ï¼Œä½†æœƒé€£çºŒç™¼é€ 3 å€‹åŒæ¨£çš„ ack x è·Ÿç™¼é€ç«¯é€šçŸ¥é€™å€‹å°åŒ…å¯èƒ½éºå¤±äº†\nç™¼é€ç«¯çœ‹åˆ°é€™å€‹é‡è¤‡çš„ ackï¼Œå°±æœƒåœ¨ x timeout å‰å°±é‡é€é€™â€œä¸€å€‹â€å°åŒ… ï¼ˆåƒæ˜¯ selective repeatï¼‰\nè£¡é¢è¬›çš„æ»¿æ¸…æ¥šçš„å¯ä»¥çœ‹\nhttps://blog.yfxie.com/comparison-of-network-gbn-sr-and-tcp/\nFlow Control é¿å…ç™¼é€ç«¯é€å¤ªå¿«ï¼Œæ¥æ”¶ç«¯çš„ buffer çˆ†æ‰ï¼Œç¨‹å¼ä¾†ä¸åŠè™•ç†\nç™¼é€ç«¯æœƒè¨˜ä½æœ€å¾Œä¸€å€‹è¢« ack çš„ byte é‚„æœ‰æœ€å¾Œä¸€å€‹é€å‡ºçš„ byte\né€™äº› unacknowledged packets å¿…é ˆå°æ–¼æ¥æ”¶ç«¯çš„ window (rwnd, window æœƒé€é header å‘ŠçŸ¥ç™¼é€ç«¯)\nCongestion Control é¿å…ç¶²è·¯æ“å¡\nç™¼é€ç«¯ä¿æŒä¸€å€‹ windowï¼Œunacknowledged packets ä¸å¯è¶…é min(rwnd, cwnd)\nç¶²è·¯ä¸Šéƒ½æ²’é›å¡ç¾è±¡çš„è©±cwndæœƒå¢åŠ ï¼Œåä¹‹è‹¥æ”¶åˆ°å£…å¡è¨Šè™Ÿï¼ˆä¾‹å¦‚timeoutï¼‰å‰‡æ¸›å°‘\nslow start å‰›é–‹å§‹ cwnd æœƒå¾ˆå°ï¼Œç„¶å¾Œå…©å€å…©å€æˆé•·\nç™¼ç¾å•é¡Œæ™‚å°±åœæ­¢ï¼Œä¸¦è¨­å®šä¸€å€‹ ssthresh ç‚ºç™¼ç¾å•é¡Œæ™‚çš„ cwnd/2\ncwnd å¾ 1 é–‹å§‹ï¼Œä¸€æ¨£å…©å€å…©å€é•·å¤§ï¼Œé”åˆ° ssthreshå°±é–‹å§‹ä¸€æ¬¡åª +1 (Congestion Avoidance mode)\næ”¶åˆ°ä¸‰å€‹é‡è¤‡çš„ ack å‰‡æ˜¯ä¸æœƒè¢«èªç‚ºæ˜¯æ“å¡ï¼Œå› ç‚ºå…¶ä»–å°åŒ…å…¶å¯¦éƒ½æœ‰åˆ°ï¼Œæ‰€ä»¥æœƒé€²å…¥ Fast Recovery mode\nåƒè€ƒä¸‹é¢çš„ï¼Œç´°ç¯€ä¸é‡è¦\nhttps://github.com/forthright48/notes/blob/master/books/computer-networking.md\n","description":"Transport Layer Note!","id":1,"section":"posts","tags":["TCP","Internet"],"title":"Transport Layer Note","uri":"https://markogoodman.github.io/posts/tcp/"},{"content":"Bloom filter Bloom filter æ˜¯ä¸€å€‹æ¦‚å¿µå¾ˆç°¡å–®åˆå¥½ç”¨çš„æ±è¥¿ï¼Œä¹‹å‰çœ‹éå°±æƒ³è¨˜éŒ„ä¸€ä¸‹\nç‚ºä½•è¦ç”¨ Bloom filter å¯ä»¥å¿«é€Ÿç¢ºèªä¸€å€‹ key æ˜¯å¦å­˜åœ¨ä¸€å€‹è³‡æ–™é›†å…§ï¼Œä¸”ä¸éœ€èŠ±å¤ªå¤šç©ºé–“ä¾†å„²å­˜é€™äº›å¤šé¤˜çš„è³‡è¨Šã€‚\nHash table ä¹Ÿå¯ä»¥åšåˆ°å¿«é€ŸæŸ¥è©¢ï¼Œä½†ç©ºé–“ä½¿ç”¨é‡å°±æ˜¯æœƒå¤šä¸å°‘\næ¼”ç®—æ³• ä¸€å€‹ Bloom filter æ˜¯ä¸€å€‹é•·åº¦ç‚º m çš„ bit é™£åˆ—ï¼Œé…ä¸Š k å€‹ hash functionã€‚æ¯å€‹ hash function å¯ä»¥éš¨æ©Ÿçš„æŠŠ key å°æ‡‰åˆ° m æ ¼é™£åˆ—ä¸Šã€‚\nåŠ å…¥è³‡æ–™ ç•¶è¦æŠŠä¸€å€‹ key åŠ å…¥è³‡æ–™é›†æ™‚ï¼Œå°±ç”¨ k å€‹ hash function å°é€™å€‹ key åšè¨ˆç®—ï¼ŒæŠŠå°æ‡‰çš„é™£åˆ—ä½ç½®è¨­æˆ 1\næŸ¥æ‰¾è³‡æ–™ ç•¶è¦ç¢ºèªä¸€å€‹ key æ˜¯å¦åœ¨è³‡æ–™é›†å…§æ™‚ï¼Œä¹Ÿæ˜¯ç”¨ k å€‹ hash function å°é€™å€‹ key åšè¨ˆç®—ã€‚\nå¦‚æœé™£åˆ—å°æ‡‰çš„ä½ç½®æ‰€æœ‰çš„å€¼éƒ½æ˜¯ 1ï¼Œé€™å€‹ key å°±æœ‰\u0026quot;å¯èƒ½\u0026quot;å­˜åœ¨æ­¤è³‡æ–™é›†ï¼Œå°±å¯ä»¥é€²è¡Œæœå°‹ï¼Œå› ç‚ºä¹‹å‰åŠ é€²ä¾†çš„ key å€‘ä¹Ÿæœ‰æ©ŸæœƒæŠŠè©² key å°æ‡‰åˆ°çš„ k å€‹é™£åˆ—ä½ç½®è¨­ç‚º 1ã€‚\nå¦‚æœå…¶ä¸­æŸäº›ä½ç½®æ˜¯ 0ï¼Œå‰‡ key å®Œå…¨ä¸å¯èƒ½å­˜åœ¨æ­¤è³‡æ–™é›†ã€‚\næ‡‰ç”¨å ´æ™¯ Cassandra DB å°±æœ‰ä½¿ç”¨åˆ° Bloom filterã€‚\nCassandra ç”¨çš„æ˜¯é¡ä¼¼ log structured merge tree çš„çµæ§‹ï¼Œå…§éƒ¨æœƒæœ‰å¤šå€‹æ¨¹ï¼Œè³‡æ–™å¯èƒ½å­˜åœ¨ä»»ä½•åœ°æ–¹ï¼Œè¦æ‰¾ä¸€ç­†è³‡æ–™æ™‚å¦‚æœæ¯é¡†æ¨¹éƒ½è¦æœå°‹ä¸€å®šæœƒæ…¢ï¼Œæ‰€ä»¥æ¯é¡†æ¨¹éƒ½æœƒé…ä¸Šä¸€å€‹ bloom filter ä¾†åŠ é€ŸæŸ¥è©¢ï¼Œæ±ºå®šè¦ä¸è¦æœå°‹é€™é¡†æ¨¹ã€‚\nçµè«– å› ç‚º Bloom filter åªæœƒå‡ºç¾ false positive çš„æƒ…æ³ (åˆ¤æ–·è³‡æ–™å­˜åœ¨å»ä¸å­˜åœ¨)ï¼Œä¸æœƒæœ‰ false negative (åˆ¤æ–·è³‡æ–™ä¸å­˜åœ¨å»å­˜åœ¨)ï¼Œæ‰€ä»¥ä¸æœƒæœ‰æ­£ç¢ºæ€§çš„å•é¡Œã€‚å‡ºç¾ false positive æ™‚åªæ˜¯é€²å»æœå°‹æ²’æœå°‹åˆ°è€Œå·²ã€‚\nè¦é”åˆ° 1% çš„ false positive rate åªéœ€è¦å¤§ç´„ 10 bits/elementï¼ŒçœŸçš„æ˜¯è¶…ç´šç¯€çœD\nè©³æƒ…è«‹åƒè€ƒ: https://en.wikipedia.org/wiki/Bloom_filter\n","description":"Blooooooom","id":2,"section":"posts","tags":[],"title":"Bloom Filter","uri":"https://markogoodman.github.io/posts/bloom-filter/"},{"content":"How to solve spark large amout of small files problem It\u0026rsquo;s a technical issue I solved when working.\nProblen Description In our data pipeline, an hourly spark job writes data to AWS S3.\nThe data and directory structure looks like this:\n/job_name_start_time/event_timestamp_minute/data_1\r/job_name_start_time/event_timestamp_minute/data_2\r... At time T the job will process all the events generated between T-1hour ~ T.\nFor example, an event generated by job JobX at 2020-03-04 10:30AM will probably be stored in a file at /JobX_2020-03-04-11:00/2020-03-04-10:30/data_n.\nSounds good? But events never arrive on time.\nUsually in one batch of data there are something like\n/JobX_2020-03-04-11:00/2020-03-04-9:58/data_x\nor even\n/JobX_2020-03-04-11:00/2020-03-03-23:58/data_x.\nUpstream data delay is inevitable.\nBut most of the events in batch JobX_2020-03-04-11:00 are generated between 10:00 and 11:00, others are minorities\nAnd we found that file sizes are skewed,\nfor batch JobX_2020-03-04-11:00 the distribution looks like\n/2020-03-04-10:30/data_1 - 200MB\r/2020-03-04-10:30/data_2 - 200MB\r/2020-03-04-10:30/data_3 - 200MB\r... /2020-03-04-9:30/data_1 - 1MB\r/2020-03-04-9:30/data_2 - 1MB\r/2020-03-04-9:30/data_3 - 1MB\r... But ideally each file should be roughly the same size\n/2020-03-04-10:30/data_1 - 201MB\r/2020-03-04-10:30/data_2 - 201MB\r/2020-03-04-10:30/data_3 - 201MB\r... /2020-03-04-9:30/data_1 - 201MB\r... This was the problem we were facing, large amount of small files in 2020-03-04-9:30 directory is probably decreasing reading performance.\nThough tweaking with repartiion to solve this problem might increase the writing time, we still wanted to give it a try.\nBackground information We used to have this piece of code to handle repartitioning and writting\ndata.repartition(config.repartition_num)\rdata.partitionBy(batch_id, minute(event_time)) // batch_id = job_name_start_time\r... Let\u0026rsquo;s first introduce how spark repartition and partitionedBy work.\npartitionBy partitionBy allows you to organize the physical directory structure when writing to it.\nFor example, partitionBy(col1, col2) will make your structure look like\n/col1=A/col2=X/data...\r/col1=A/col2=Y/data...\r/col1=B/col2=X/data... More detail: https://sparkbyexamples.com/pyspark/pyspark-partitionby-example/\nrepartition repartition allows you to regroup data into partitions in memory, data in one partition will be processed together, increase partition number to parallelly process each partition if you have more machines.\ndata.repartition(n) \u0026lt;- repartitions data randomly to create n partitions\rdata.repartition(col) \u0026lt;- repartitions data with col to create 1 partition for each col value Normally when you write, number of partitions is the number of files you have.\nMore detail: https://sparkbyexamples.com/spark/spark-repartition-vs-coalesce/\nThe abobe seems good, but if the data in one partition is splitted by partitionBy, it will still generate multiple files in different directories.\nSince we used to partitioned data randomly, each partition contained a lot of T-1 ~ T dat and a little bit of everything else like T-5 ~ T6 or T-31 ~ T-30. When lots of partitions like this are written to disk, it creates lots of seprarte small files for data other than T-1 ~ T(lots of large files for T-1~T)\nSo the target was to repartition data to have data with the same batch_id, minute(event_time) in the same partition before writing to disk, and if a partition is too large it also needs to be splitted (hopefully 1 file is 1GB)\nSolution The solution is quite simple. Let\u0026rsquo;s say batch_id, minute(event_time) = partition_key, now we need to find a way to put rows with the same partition_key in the same partition with each partition size controlled.\nFirst we estimate the size of each row by\nrow_size = length(to_json(struct(col(\u0026quot;*\u0026quot;)))),\nthen we can get how many partitions each partition_key needs by doing\npartition_key_total_size = groupBy(partition_key).agg(sum(col(row_size))),\nand\npartition_number = ceil(col(partition_key_total_size)/ max_size_per_partition_key).\nNow we can join the information back to the data with broadcast since split info is probably quite small.\ndf.join(broadcast(split_info), partition_key)\nNow we have dataframe like this\nif we set the max_size_per_partition_key to 10\n+-------------------------------------------------------\r|partition_key|partition_key_total_size|partition_number\r|-------------------------------------------------------\r| x| 10| 1\r| y| 20| 2\r| y| 20| 2\r| z| 30| 3\r| z| 30| 3\r| z| 30| 3 For partition_key = z, we want there to be 3 partitions (0~2).\nAt first I thought we could just evenly distribute the rows into each partition. For example, go through rows and assigning them partition = row_number % 3, but that requires the data to be processed in the same executor (to label the row_number).\nA better approach is to randomly assign each row to partition 0, 1 or 2. When the number of rows is large, it should be quite evenly distributed.\nThen we add another column to indicate which\n.withColumn(\u0026#34;finalDecision\u0026#34;, concat(\rcol(partition_key), lit(\u0026#34;final_partition\u0026#34;),\r(rand()*col(\u0026#34;partition_number\u0026#34;)).cast(\u0026#34;int\u0026#34;)\r)` Finally we can do\ndf.repartition(col(\u0026quot;finalDecision\u0026quot;))\nto repartition the data and have size controled.\nAnd the output file should be what we expected, no large amount of small files.\nAs the implementation completed, we found that compacting the files reduceed data processing time around 3% (slightly increase the writing time, but decrease the data reading)\n","description":"A problem that I had when working and solved","id":3,"section":"posts","tags":["Spark"],"title":"How to solve spark large amount of small files problem","uri":"https://markogoodman.github.io/posts/spark-small-file-problem/"},{"content":"Parquet æœ€è¿‘åœ¨å·¥ä½œä¸Šè¦æŠŠä¸€å † spark app è®€çš„æª”æ¡ˆå¾ json æ›æˆ parquet\nå°±å°å°ç ”ç©¶ä¸€ä¸‹é€™æ±è¥¿åˆ°åº•æ˜¯ä»€éº¼\nparquet å…¶å¯¦å°±æ˜¯ä¸€ç¨®è³‡æ–™å„²å­˜çš„æª”æ¡ˆæ ¼å¼ï¼Œä¸”æ˜¯ binary encodingï¼Œäººçœ¼çœ‹ä¸æ‡‚\nåƒåœ¨ä¹‹å‰æˆ‘å¯«çš„é€™ç¯‡æ–‡ç« ä»‹ç´¹ï¼Œç”¨ç´”æ–‡å­—çš„æ–¹å¼å»å­˜ json é€™ç¨® key value çš„ objectï¼Œåœ¨ deserialize çš„æ™‚å€™è¦èŠ±å¾ˆå¤§çš„åŠ›æ°£ä¸€å€‹ä¸€å€‹å­—å…ƒå»è®€ï¼Œè€Œä¸”è™•å­˜ç©ºé–“èŠ±è²»ä¹Ÿå¾ˆå¤§ï¼Œæ²’æœ‰åšä»»ä½•çš„å£“ç¸®\nparquet ç”¨åœ¨ä¸€å€‹ row group å…§ç”¨ column-oriented çš„æ–¹å¼å»å­˜è³‡æ–™ï¼Œé‚„æœ‰å¤šå­˜äº†ä¸€äº› metadataï¼Œåœ¨åˆ†æç”¨é€”ä¸”è³‡æ–™é‡å¤§çš„æ™‚å€™å°±æœƒå¾ˆæœ‰æ•ˆç‡\nparquet æª”æ¡ˆé•·ç›¸å¦‚ä¸‹\nRef: https://parquet.apache.org/docs/file-format/\næª”æ¡ˆå…§ä¸»è¦åŒ…å« data å’Œ footer file metadata å…©å€‹éƒ¨åˆ†ã€‚\nä¸€ç­†ä¸€ç­†çš„ç´€éŒ„æœƒè¢«åˆ†æ•£æ”¾åœ¨å„å€‹ row group å…§ï¼Œæ¥è‘— group å…§æœƒæœ‰å¾ˆå¤š column chunksï¼Œæ¯å€‹ chunk éƒ½åŒ…è‘—å¤šç­†ç´€éŒ„çš„åŒä¸€å€‹æ¬„ä½ï¼Œåˆ‡è‘—è¢«åˆ‡åˆ†ç‚º pagesï¼Œæ¯ä¸€å€‹ page åŸºæœ¬ä¸Šä¾†èªªæ˜¯ä¸å¯åˆ†å‰²çš„ï¼Œæ˜¯æ‹¿ä¾†å£“ç¸®å’Œ encoding çš„å–®ä½ã€‚\nRef: https://www.linkedin.com/pulse/all-you-need-know-parquet-file-structure-depth-rohan-karanjawala/\nåœ¨å¯ä»¥çœ‹åˆ° footer ä¸­çš„ file metadata åŒ…å«äº† row groups å’Œ column chunks çš„ä½ç½®ï¼Œæ‰€ä»¥é€™äº›æ±è¥¿å…¶å¯¦æ˜¯å¯ä»¥åˆ†é–‹å­˜åœ¨ä¸åŒåœ°æ–¹ã€‚\næŠŠ metadata å¯«åœ¨å°¾ç«¯çš„å¥½è™•æ˜¯å¯ä»¥ one pass å¯«å…¥\nåœ¨è®€è³‡æ–™çš„æ™‚å€™éƒ½æ˜¯ç”± footer é–‹å§‹ï¼Œå…ˆæ‰¾åˆ°éœ€è¦è®€çš„ column chunks æ¥è‘—ä¾åºå»è®€\nå¤§é‡è³‡æ–™åˆ†ææ™‚é€šå¸¸éƒ½æ˜¯è®€æ‰€æœ‰è³‡æ–™çš„ç‰¹å®šå¹¾å€‹ column è€Œå·²ï¼Œcolumn-oriented è³‡æ–™ç·¨æ’æ–¹å¼å¯ä»¥è·³éä¸éœ€è¦çš„ columnï¼Œå¦‚æœæ˜¯ä¸€èˆ¬ row-oriented çš„è™•å­˜æ–¹å¼ä¾‹å¦‚ Avroï¼Œå°±åªèƒ½ä¹–ä¹–æƒéæ‰€æœ‰è³‡æ–™\nè€Œå› ç‚ºåŒä¸€å€‹ column éƒ½æ˜¯åŒä¸€ç¨®å‹æ…‹ï¼ŒåŒä¸€å€‹å‹æ…‹çš„è³‡æ–™éƒ½èšé›†åœ¨ä¸€èµ·ï¼Œæ‰€ä»¥åœ¨å£“ç¸®ä¸Šä¹Ÿæ¯” row-oriented æ›´å®¹æ˜“\nèˆ‰å€‹ç°¡å–®çš„ä¾‹å­ï¼Œç›®å‰å„²å­˜äº†ä¸€å€‹ enum çš„ column å…§å®¹æ˜¯ AAAAABBBBï¼Œé‚£å°±å¯ä»¥æŠŠå®ƒå£“ç¸®æˆ 5A4B ä¾†å„²å­˜\nDDIA ç¬¬ä¸‰ç« æœ‰ä¸€å€‹å°ç¯€å°ˆé–€åœ¨è¬› column-oriented storage\nä¹‹å‰å¦‚æœæœ‰ç©ºå†ä¾†å¯«ä¸€ç¯‡ç´€éŒ„ä¸€ä¸‹\nRow group èˆ‡ data page size éƒ½æ˜¯å¯ä»¥èª¿æ•´çš„\nRow group size è¶Šå¤§å°±å¯ä»¥è®“ column chunks æ›´å¤§ï¼Œå¯ä»¥åšæ›´å¤§çš„ sequential IOï¼Œä¸éåœ¨é€”ä¸­ä¹Ÿæœƒéœ€è¦æ›´å¤šçš„ bufferã€‚å®˜æ–¹å»ºè­°å°±æ˜¯æŠŠä¸€å€‹ row group å‰›å¥½å¯ä»¥æ”¾é€²ä¸€å€‹ HDFS blockï¼Œ1GB\ndata page size çš„å»ºè­°å‰‡æ˜¯ 8KBï¼Œè¶Šå¤§çš„ size å¯ä»¥æ¸›å°‘ header çš„æ•¸é‡èˆ‡è™•ç† header çš„æ™‚é–“\nå°ä¸€é»çš„ size å‰‡æ˜¯å¯ä»¥æ›´æœ‰æ•ˆç‡çš„ query å°‘é‡ç´€éŒ„ï¼Œå› ç‚ºåœ¨æ’ˆå°‘é‡ç´€éŒ„æ™‚ä¸éœ€è¦å»è™•ç†å¾ˆå¤§çš„ page\nParquet å¤§æ¦‚å°±çœ‹åˆ°é€™é‚Šï¼Œç¸½çµå°±æ˜¯å®ƒç”¨ column-oriented çš„æ–¹å¼å»å­˜è³‡æ–™ï¼Œæ‰€ä»¥å¾ˆé©åˆè³‡æ–™åˆ†æï¼Œè€Œä¸”åˆå­˜äº†å¾ˆå¤š metadata ä¾†è®“å„ç¨®æ“ä½œæ¸›å°‘å¾ˆå¤š overhead (ä¾‹å¦‚ index)\nè·Ÿ Parquet å¸¸å¸¸è¢«ä¸€èµ·æèµ·çš„é‚„æœ‰ ORCï¼ŒORC ä¼¼ä¹åœ¨æŸäº›æ–¹é¢è¡¨ç¾ç¨å¾®å„ªæ–¼ parquetï¼Œä¸é Parquet åœ¨ Spark ä¸Šæœ‰åšä¸€äº›å„ªåŒ–ï¼Œè€Œ ORC å‰‡æ˜¯é©åˆè·Ÿ Hive ä¸€èµ·ä½¿ç”¨ã€‚ä½†é€™éƒ¨åˆ†å°±æ²’ä»€éº¼ç ”ç©¶äº†ï¼Œä¹‹å¾Œæœ‰ç©ºå†ä¾†çœ‹çœ‹å¥½äº†ã€‚\nRef:\nhttps://parquet.apache.org/docs/file-format/configurations/\nhttps://www.linkedin.com/pulse/all-you-need-know-parquet-file-structure-depth-rohan-karanjawala/\n","description":"parqqqquet","id":4,"section":"posts","tags":["parquet"],"title":"Parquet","uri":"https://markogoodman.github.io/posts/parquet/"},{"content":"çœ‹äº† DDIA ç¬¬ä¹ç«  è¨˜éŒ„ä¸€ä¸‹\n2 phase commit æ˜¯ç”¨ä¾†åš multiple nodes tansaction æ™‚ä½¿ç”¨çš„æ–¹æ³•\nsingle node transaction é€šå¸¸éƒ½æ˜¯ç”± log èˆ‡ commit ä¾†é”æˆ\npostgresql.org/docs/current/wal-intro.html\nä¾‹å¦‚ postgres çš„åšæ³•å°±æ˜¯æ¯å€‹æ“ä½œéƒ½æœƒæœ‰ä¸€å€‹ write-ahead-log (wal)ï¼Œæ¥è‘—æœƒæŠŠè³‡æ–™æ“ä½œå¯«é€² buffer (è¨˜æ†¶é«”å…§ï¼Œé€Ÿåº¦å¿«)ï¼Œåœ¨ commit (å¯«å…¥ commit record) ä¹‹å‰å¿…é ˆæŠŠæ‰€æœ‰çš„ wal éƒ½å¯«å…¥ persistent storageï¼Œæ¯éš”ä¸€é™£å­è³‡æ–™åº«æœƒä¸€æ¬¡æŠŠæ‰€æœ‰ buffer å…§çš„æ›´å‹•ä¸€æ¬¡å¯«é€² persistent storage\nwal æ˜¯ sequential writeï¼Œæ•ˆç‡æœƒæ¯”æ¯æ¬¡éƒ½æŠŠè³‡æ–™å¯«é€² persistent storage é«˜å¾ˆå¤š\ncommit ä¹‹å¾Œç³»çµ±å¦‚æœ crashï¼Œä¹Ÿå¯ä»¥ç”¨é€™äº›å·²ç¶“å¯«å…¥çš„ wal ä¾†åšæ¢å¾©\næ±ºå®šé€™å€‹ transaction æ˜¯æˆåŠŸæˆ–å¤±æ•—çš„å› ç´ å°±æ˜¯ commit record åœ¨ç³»çµ± crash ä¹‹å‰æ˜¯å¦æœ‰è¢«å¯«å…¥ persistent storage\nå¹³æ™‚æƒ³åˆ° transaction åªæœƒæƒ³åˆ°æ˜¯ä¸€æ¬¡æ›´æ”¹å¤šç­†è³‡æ–™çš„æƒ…æ³ï¼Œä½†å…¶å¯¦æ›´æ”¹ä¸€å€‹ç‰©ä»¶æ™‚ä¹Ÿæœƒæ›´æ”¹åˆ°å¾ˆå¤šç¡¬ç¢Ÿä¸Šçš„ä½ç½®ï¼ˆä¾‹å¦‚æœ‰ secondary indexï¼‰ï¼Œä¹Ÿæ˜¯æœ‰ transaction çš„è“‹å¿µ\nå–®ä¸€ç¯€é» tansaction é€šå¸¸æ˜¯ç”± db engine ä¾†è™•ç†\nMultiple nodes transaction å¦‚æœåªæ˜¯å–®ç´”çš„æŠŠå®ƒç•¶ä½œæ¯å€‹ db node ä¸Šéƒ½æœ‰ä¸€å€‹ transaction ä¾†å¯¦ä½œï¼Œclient å¯ä»¥åœ¨å®Œæˆæ™‚ä¸€æ¬¡ç™¼é€å¾ˆå¤š commit åˆ°å„å€‹ node ä¸Šï¼Œä½†å¾ˆæœ‰å¯èƒ½æŸäº›æˆåŠŸæŸäº›å¤±æ•—ï¼Œé€ æˆè³‡æ–™ä¸ä¸€è‡´\nå¦‚æ­¤ä¸€ä¾†å°±å¿…é ˆå°‡æŸäº› node ä¸Šå·²ç¶“ commit çš„ transaction å›æœ”ï¼Œä½†é€™äº› transaction è¢« commit ä¹‹å¾Œå°±å¯ä»¥è¢«å…¶ä»– transaction çœ‹è¦‹ï¼Œæœƒæœ‰æ›´å¤š transaction ä¾è³´åœ¨é€™å€‹ commit ä¸Šï¼Œæœƒå‡ºç¾å¾ˆå¤šå•é¡Œ\nä»¥ä¸‹æ˜¯ 2 phase commit çš„æµç¨‹åœ–\nåœ–ç‰‡ä¾†è‡ª DDIA figure 9-9\ncoordinator æ˜¯åœ¨ sindle node transaction å…§æ²’æœ‰å‡ºç¾çš„æ±è¥¿ï¼Œé€šå¸¸éƒ½æœƒå¯¦ä½œåœ¨ç™¼ request çš„ client library å…§ï¼Œä½†ä¹Ÿå¯ä»¥é¡å¤–ç”¨ä¸€å€‹æœå‹™ä¾†æ“”ä»»é€™å€‹è§’è‰²\nä»¥ä¸‹æ˜¯æ¯”è¼ƒè©³ç´°çš„ 2 pc æµç¨‹\né¦–å…ˆ coordinator æœƒåœ¨æ¯å€‹ db node ä¸Š init ä¸€å€‹ transaction\nç•¶æ‰€æœ‰æ‰€æœ‰è³‡æ–™æ“ä½œçµæŸå¾Œæœƒé€²å…¥ phase 1\ncoordinator ç™¼é€ prepare çµ¦æ¯å€‹ node\nåªè¦æœ‰ä»»ä½•ä¸€å€‹ node å›è¦† no æˆ–æ˜¯ timeoutï¼Œå‰‡åœ¨ phase 2 æ™‚ coordinator æœƒè«‹æ‰€æœ‰ node abort å„è‡ªçš„ transaction\nå¦‚æœæ‰€æœ‰ node çš†å›è¦† yesï¼Œå‰‡åœ¨ phase 2 æ™‚ coordinator æœƒè«‹æ‰€æœ‰ node commit\né€™é‚Šæœ‰å…©å€‹ decision points\nåœ¨ phase 1 æ™‚å¦‚æœä¸€å€‹ node å›è¦† yesï¼Œä»£è¡¨é€™å€‹ node å·²ç¶“è‡ªè¡Œå…ˆæª¢æŸ¥æ‰€æœ‰æ„å¤–æƒ…æ³ï¼ˆä¾‹å¦‚ unique constrain conflict ä¹‹é¡ï¼‰ï¼Œæ­¤ node ç„¡è«–å¦‚ä½•ä¸€å®šå¯ä»¥ commitï¼Œæ”¾æ£„äº†è‡ªè¡Œ abort çš„æ¬Šåˆ©ï¼Œå¿…é ˆç­‰å¾… phase 2 coordinator çš„é€šçŸ¥æ‰èƒ½é€²è¡Œä¸‹ä¸€æ­¥å‹•ä½œ (åœ¨å›è¦† yes å‰éƒ½å¯ä»¥è‡ªè¡Œ abort)\nç•¶ coordinator åœ¨ phase 1 åšäº†æ±ºå®šï¼ˆcommit or abortï¼‰å¾Œï¼Œæœƒå°‡é€™å€‹æ±ºå®šå¯«å…¥ logï¼ŒæˆåŠŸå¾Œé€™å€‹æ±ºå®šä¾¿ä¸æœƒè¢«æ›´æ”¹ï¼ˆsingle node æ˜¯æŠŠé€™å…©å€‹å‹•ä½œåˆåœ¨ä¸€èµ· -\u0026gt; commit recordï¼‰\nåœ¨ phase 2 æ™‚å¦‚æœæœ‰ coordinator å’Œ node ä¹‹é–“æºé€šå¤±æ•—å¦‚ timeout æˆ–æœ‰ node crashï¼Œå‰‡æœƒç„¡é™æ¬¡é‡è©¦ç›´åˆ°æˆåŠŸ\nè€Œ coordinator å¦‚æœ crash äº†ï¼Œå›ç­” yes çš„ node ä¹Ÿå¿…é ˆè¦ç„¡é™æ™‚çš„ç­‰å¾… coordinator ä¾†é€šçŸ¥è‡ªå·±æ¥ä¸‹ä¾†åˆ°åº•æ˜¯è¦ abort é‚„æ˜¯ commit\nnode è‹¥æ˜¯åœ¨æ”¶åˆ°é€šçŸ¥å‰æ“…è‡ª commitï¼Œå‰‡å¯èƒ½æœƒå› ç‚ºå…¶ä»–åƒèˆ‡è€…åœ¨ä¹‹å‰å›ç­”äº† noï¼Œå…¶å¯¦ coordinator çš„æ±ºå®šæ˜¯ abort\nåä¹‹ï¼Œè‹¥ node åœ¨æ”¶åˆ°é€šçŸ¥å‰æ“…è‡ª abortï¼Œå…¶ä»–åƒèˆ‡è€…å¾ˆæœ‰å¯èƒ½å·²ç¶“æ”¶åˆ° coordinator çš„ commit æ±ºå®šäº†\nå¯ä»¥çœ‹åˆ°é€™å€‹ protocol ä¸­æœ‰å¯èƒ½å› ç‚º coordinator crash é€ æˆæ‰€æœ‰ node éƒ½è¢«å¡ä½ï¼Œæ‰€ä»¥ 2 pc è¢«ç¨±ç‚º blocking protocol\næœ‰äººæå‡ºäº† 3pc è¦åšåˆ° non blocking protocolï¼Œè€Œå¯¦å‹™ä¸Šæ˜¯ä¸å¤ªå¯èƒ½åšåˆ°çš„ï¼Œå› ç‚ºå®ƒéœ€è¦ä¸€å€‹å¯ä»¥æº–ç¢ºå¾—çŸ¥æŸå€‹ node æ˜¯å¦ crash çš„æ–¹æ³•ï¼Œä½†ç¶²è·¯é€šè¨Šæ˜¯ unbounded delay æ‰€ä»¥å¾ˆæœ‰å¯èƒ½æ˜¯ timeoutï¼Œnode å»æ´»è‘—çš„æƒ…æ³\nä»¥ä¸Šå°±æ˜¯ 2pc çš„æµç¨‹\né‡é»å¤§æ¦‚å°±æ˜¯åœ¨å…©å€‹ decision points é‚£é‚Šæ˜¯ä»¥å‰ç¶²è·¯çœ‹æ–‡ç« æ¯”è¼ƒæ²’çœ‹åˆ°çš„éƒ¨åˆ†\n","description":"2 phase commit from DDIA","id":5,"section":"posts","tags":["2 phase commit"],"title":"2 Phase Commit","uri":"https://markogoodman.github.io/posts/2-phase-commit/"},{"content":"DynamoDB index é€™ç¯‡æƒ³è¬›ä¸€ä¸‹ç”¨ DynamoDB é‡åˆ°çš„ç‹€æ³ï¼Œå­—å¾ˆå¤šä½†å…§å®¹æ‡‰è©²å¾ˆå°‘ï¼Œæ¯”è¼ƒåƒæµæ°´å¸³\nå‰é™£å­å·¥ä½œæ™‚éœ€è¦å°‡ DynamoDB çš„å…¨éƒ¨è³‡æ–™(åŒ…æ‹¬å·²ç¶“å­˜åœ¨çš„å’Œæœªä¾†æ–°ä¾†çš„)è¼‰å…¥é€² Redshift\nä¸¦åœ¨é€”ä¸­åšä¸€äº›è³‡æ–™è™•ç†ï¼Œè³‡æ–™è™•ç†æ™‚éœ€è¦ä½¿ç”¨åˆ° DynamoDB å’Œ PostgreSQL å…§çš„æ±è¥¿\nDynamoDB å…§çš„è£çš„æ˜¯èŠå¤©çš„è¨Šæ¯ï¼Œéƒ½æœ‰ partition key (chat room id) å’Œ sort key (unique timestamp in a chat room)\nä¸€é–‹å§‹æƒ³äº†å…©ç¨®æ–¹æ³•\nç¬¬ä¸€ç¨®æ–¹æ³•å¾ˆç°¡å–®ï¼Œå°±æ˜¯ Batch processingï¼Œé¡ä¼¼ cursor based pagination\nå°±æ˜¯æ¯éä¸€æ®µæ™‚é–“å» DynamoDB å¾ offset (cursorï¼Œå¯ä»¥æ˜¯ partition key + sort key çš„çµ„åˆ) é–‹å§‹æŠ“ä»¥å¾Œçš„è³‡æ–™ä¾†è™•ç†ï¼Œè™•ç†æˆåŠŸå°±ä¸Ÿé€² Redshift ä¸¦æ›´æ–° offset\nå¯¦ä½œä¸Šçœ‹ä¼¼å¾ˆç°¡å–®ï¼Œä¸”ä¸å¤ªéœ€è¦è™•ç†å¤±æ•—çš„æƒ…æ³ï¼Œå› ç‚ºé€”ä¸­å¤±æ•—å°±ä¸è¦æ›´æ–° offset å°±å¥½\nç•¶æ™‚æƒ³å‡ºä¾†çš„å¦ä¸€ç¨®æ–¹æ³•æ˜¯æ¯”è¼ƒè¤‡é›œï¼Œå¦‚ä¸‹åœ–ï¼Œæ˜¯ stream processing\nè¦ç”¨çš„ service å¤šå¾ˆå¤šï¼Œä¸” service ä¹‹é–“æºé€šéƒ½è¦è™•ç†å¤±æ•—çš„å•é¡Œ\næœ€å¾Œé‚„æ˜¯é¸äº†é€™å€‹ä¾†ç”¨ï¼Œä¸éé€™ä¸æ˜¯é€™ç¯‡çš„é‡é»ï¼Œä¸‹æ¬¡æœ‰æ©Ÿæœƒå†ä¾†æŠŠé€™è£¡é¢çš„æ±è¥¿å¯«æ¸…æ¥š\nç•¶æ™‚å…¶å¯¦æ™‚é–“åªæœ‰ä¸€å€‹ç¦®æ‹œå·¦å³ï¼Œä¸”ç¾åœ¨è³‡æ–™é‡ä¸å¤šï¼ŒRedshift å…§çš„è³‡æ–™æ˜¯è¦åšåˆ†æå ±è¡¨çš„ï¼Œéœ€æ±‚æ²’æœ‰é‚£éº¼åŠæ™‚ï¼Œå°±æ‰“ç®—ç”¨ç¬¬ä¸€ç¨®æ–¹æ³•ä¾†è§£æ±º\nçµæœå‰›è¦é–‹å§‹åšçš„æ™‚å€™å°±ç™¼ç¾ DynamoDB çš„ index å¥½åƒæ²’ä»€éº¼è¾¦æ³•æ”¯æ´é€™ç¨®è¨­è¨ˆ\nç°¡ä»‹ä¸€ä¸‹ DynamoDB\nè³‡æ–™åº«å…§æ¯ä¸€ç­†è³‡æ–™å«åš itemï¼Œè£¡é¢æœ‰å¾ˆå¤š attributeï¼Œå°±åƒæ˜¯ RDB çš„ row å’Œ columnï¼Œä¸éæ¯å€‹ item å¯ä»¥æœ‰ä¸åŒ attribute (NoSQL)\nPrimary key æ˜¯åœ¨ä¸€å€‹ table ä¸­æ˜¯ unique çš„ï¼Œç”± partition key æˆ–æ˜¯ partition key + sort key çµ„æˆ\nåœ¨åŒä¸€å€‹ partition key (hash table) ä¸­å¯ä»¥ç”¨ sort key (b-tree)è®“è³‡æ–™æœ‰é †åº\nåˆ°é€™é‚Šå°±æœƒç™¼ç¾ DynamoDB çš„ query æ˜¯å…©å±¤ï¼Œç¬¬ä¸€å±¤æ˜¯ hashï¼Œç¬¬äºŒå±¤æ˜¯ b-treeï¼Œæ‰€ä»¥æƒ³è¦åœ¨æˆ‘å€‘çš„ table å…§åªç”¨ä¸€å€‹ cursor ä¾†ç•¶ä½œ offset æ˜¯ä¸å¯èƒ½çš„ï¼Œå› ç‚º hash table æ²’æœ‰é †åºé˜¿ï¼Œé‚„æ˜¯å¿…é ˆæƒéæ¯å€‹ entry\næ­¤æ™‚åˆæƒ³åˆ°ä¸€å€‹ tricky çš„æ–¹æ³•ï¼Œæ˜¯å»ºç«‹ä¸€å€‹ Global secondary index ç„¶å¾ŒæŠŠæ‰€æœ‰è³‡æ–™éƒ½å¡åˆ°åŒä¸€å€‹ partition key å…§ï¼Œé€™æ¨£å°±å¯ä»¥ç”¨ sort key ä¾†ç•¶ cursorï¼Œä¸éæŸ¥ä¸€æŸ¥åˆç™¼ç¾ partition key å° scalability æœ‰è¶…å¤§çš„å½±éŸ¿\nAWS æœƒæŠŠç›¸åŒ partitio key ä¸‹é¢çš„è³‡æ–™å­˜åœ¨ç‰©ç†ä¸Šå¾ˆæ¥è¿‘çš„ä½ç½®ï¼Œå¯ä»¥æƒ³åƒæˆä¸åŒ partition key çš„è³‡æ–™æœƒå­˜åœ¨ä¸åŒ disk ä¸Šï¼Œå°å–®ä¸€ partition key çš„ read å’Œ write æœƒæœ‰ throughput çš„ä¸Šé™ï¼Œåªè¦æŠŠè³‡æ–™å¹³å‡åˆ†æ•£åˆ°ä¸åŒ partition keyï¼Œå¹¾ä¹æ˜¯æ²’æœ‰ scalability çš„å•é¡Œï¼Œå¯ä»¥åƒè€ƒä¸‹æ–¹é€£çµ\nhttps://docs.aws.amazon.com/amazonDynamoDB/latest/developerguide/bp-partition-key-design.html\nå¦‚æœæŠŠæ¯å€‹ partition key (chat room id) éƒ½å„å­˜ä¸€å€‹ cursor (sort key) å‘¢?\næœƒæœ‰ä¸å°‘ overheadï¼Œå› ç‚ºå¾ˆå¤šå…¶å¯¦ partition key å…¶å¯¦éƒ½å¹¾ä¹æ²’å†ç”¨ï¼Œä½†ä¹Ÿä¸è¡Œåˆªé™¤ä»–ï¼Œå› ç‚ºæˆ‘å€‘ä¹Ÿç„¡æ³•ç¢ºå®šæ˜¯å¦æœƒå†æ¬¡å•Ÿç”¨ã€‚å¦‚æ­¤ä¸€ä¾†æ¯æ¬¡ batch process å•Ÿå‹•æ™‚éƒ½è¦å»æƒéä»–å€‘é€ æˆ overhead\nç¸½ä¹‹å°±æ˜¯æƒ³äº†å¾ˆå¤šæ–¹æ³•ï¼Œé‚„æ˜¯æ‰¾ä¸åˆ°ä¸€å€‹é©åˆçš„ index å­˜æ³•ä¾†æœ‰æ•ˆæ”¯æ´ç¬¬ä¸€ç¨®æ–¹æ³•ï¼Œæˆ–è¨±å°±æ˜¯ DynamoDB Partition keyã€Sort keyã€index è¨­è¨ˆé€ æˆçš„é™åˆ¶ï¼Œä¸éé€™äº›è¨­è¨ˆä¹Ÿè®“ä»–å¾ˆå®¹æ˜“ scaleï¼Œç®—æ˜¯ä¸€ç¨® trade off\nçµæœæœ€å¾Œé‚„æ˜¯è·‘å»ç”¨ DynamoDB stream äº†\nNOTE Global Secondary Indexes å¯ä»¥ç”¨å¦ä¸€çµ„ partition key å’Œ sort key ä¾†å»º index\nä½† PK + SK ä¸éœ€è¦ unique\nåªæ”¯æ´ eventual consistency\nLocal Secondary Indexes ä¾ç…§åŸæœ¬ table çš„ partition keyï¼Œç”¨å¦ä¸€å€‹ sort key ä¾†å»º index\næ”¯æ´ consistent consistency\nä½†å®˜æ–¹ä¸å»ºè­°ç”¨é€™å€‹æ±è¥¿å°±æ˜¯äº†\nå»ºç«‹å¤šçµ„ index æœƒè®“èŠ±è²»å¢åŠ ï¼Œå°¤å…¶æ˜¯å¯«å…¥æ™‚æœƒæ˜¯å…©å€ cost (delete, write)\nä¸‹é¢å†æ¨è–¦å¹¾ç¯‡ DynamoDB æ»¿å¥½æ‡‚å¾—æ–‡ç« \nDynamoDB è¨ˆè²»\nhttps://medium.com/fcamels-notes/amazon-DynamoDB-%E7%9A%84-consumed-units-%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A0%85-e1fbda5687b4\nhttps://medium.com/fcamels-notes/amazon-DynamoDB-%E5%88%9D%E6%AD%A5%E4%BD%BF%E7%94%A8%E5%BF%83%E5%BE%97-c734d8445ae2\nDynamoDB under the hood\nhttps://www.youtube.com/watch?v=yvBR71D0nAQ\nhttps://www.precisely.com/blog/big-data/big-data-101-batch-stream-processing\n","description":"DynamoDB æµæ°´å¸³","id":6,"section":"posts","tags":["DynamoDB","index","database"],"title":"DynamoDB Index","uri":"https://markogoodman.github.io/posts/dynamodb-index/"},{"content":"å¦‚ä½•æŠŠåŸæœ¬ä½¿ç”¨ AWS console å»ºç«‹çš„è³‡æºå®Œæ•´æ¬åˆ° cdk å…§ ç›®å‰å…¬å¸ä½¿ç”¨ AWS ä¸Šæ˜¯æ‰‹å‹•èˆ‡ cdk æ··è‘—ç”¨ï¼Œæ—©æœŸçš„æ±è¥¿éƒ½æ˜¯ç”¨æ‰‹å‹•å»ºç«‹çš„ï¼Œä¾‹å¦‚ Dynamodb tableï¼Œè£¡é¢çš„ index ç­‰ç­‰ã€‚\nä½†å¾Œä¾†å¾ˆå¤šæ±è¥¿éƒ½é™¸çºŒå¯«åœ¨ cdk å…§ï¼Œä¸å¾—ä¸èªªæ¯”èµ·æ‰‹å‹•å»ºç«‹é‚„æ˜¯æ–¹ä¾¿åˆå®‰å…¨å¤šäº†ï¼Œè¦ä¿®æ”¹å’Œæ¶è¨­æ¸¬è©¦ç’°å¢ƒæ™‚åªè¦æ”¹å€‹ç’°å¢ƒè®Šæ•¸æˆ–æ˜¯ region å°±ç›´æ¥éƒ¨ç½²ä¸Šå»ï¼Œæ‰€ä»¥é‚„æ˜¯æ»¿å¸Œæœ›æŠŠæ‰€æœ‰æ±è¥¿é€šé€šéƒ½ç§»åˆ° cdk ä¸Šé¢çš„\næœ€è¿‘å‰›å¥½ä¹Ÿè¦ä½¿ç”¨ Dynamodb çš„ stream åŠŸèƒ½ï¼ˆåŸæœ¬åœ¨ table ä¸Šæ˜¯é—œé–‰çš„ï¼‰ï¼Œå°±æƒ³èªªä¸€èµ·æ¬é€²å»ï¼Œé€™å¹¾å¤©å°±é–‹å§‹äº†ç˜‹ç‹‚çœ‹æ–‡ä»¶çš„ç”Ÿæ´»ï¼Œä¸å¾—ä¸èªª cdk çœŸçš„æ˜¯å‰›å‡ºçš„æ±è¥¿ï¼Œstack overflow ä¸Šé¢èƒ½æŠ„çš„æ±è¥¿é‚„çœŸå°‘ XD\nè¼‰å…¥ç¾æœ‰ table from_table æœ€å¸¸è¦‹çš„ç›´æ¥è§£æ³•å°±æ˜¯åœ¨ cdk ä¸­ç”¨ from_table_attributes, from_table_arn, from_table ç›´æ¥è¼‰å…¥ç¾æœ‰çš„ table\nä¸éé€™ç¨®æ–¹æ³•å…¶å¯¦æ²’è¾¦æ³•å®Œå…¨æ§åˆ¶ä½é€™å€‹è³‡æº\nä¾‹å¦‚ from_table_attributes å°±å¿…é ˆå‚³é€² stream çš„ arn æ‰è¡Œï¼Œå¯¦éš›ä¸Šé‚„æ˜¯è¦å» console æ‰‹å‹•é–‹é—œé‚£äº›æ±è¥¿\nè®“äººå¼·è¿«ç—‡ç™¼ä½œ\nç”¨ cdk å»ºç«‹æ–°çš„ Dynamodb Table ä¸¦æŠŠèˆŠçš„è³‡æ–™ç§»é€²å» ä¹Ÿæ˜¯å¯è¡Œçš„åšæ³•\nä¸éå•é¡Œæ˜¯éœ€è¦æŠŠä¼ºæœå™¨é—œæ‰ä¸€é™£å­ï¼Œæˆ–è‘—æ˜¯æœƒè®“ä¼ºæœå™¨éœ€è¦åŒæ™‚é€£æ–°èˆŠå…©å€‹ dbï¼Œmigration éç¨‹å…¶å¯¦æ»¿ç…©ç‘£çš„\nç”¨ cloudformation æ¬ç§» é€™æ˜¯ç ”ç©¶äº†ä¸€é™£å­ç™¼ç¾æœ€æ–¹ä¾¿å¯è¡Œçš„åšæ³•\nå¯ä»¥è®“ cdk code è£¡é¢çœ‹èµ·ä¾†å°±åƒæ˜¯å¾é€™é‚Šå¯«å‡ºä¾†çš„è³‡æºï¼Œæœ‰å®Œå…¨çš„æ§åˆ¶æ¬ŠåŠ›ï¼Œè€Œä¸”ç”¨ä¸ç”¨ db downtime\nåšæ³• å…¶å¯¦æ»¿ç°¡å–®çš„\nå…ˆ cdk deploy ä¸€æ¬¡ï¼Œç¢ºä¿ cdk code å…§å®¹èˆ‡ aws ä¸Šçš„ stack å…§å®¹ä¸€è‡´\nå» aws cloudformation é é¢ä¸Šçš„ stack ä¸­å°‡ template è¤‡è£½ä¸€ä»½å‚™ç”¨ (A)ï¼Œé€™ä»½å…§å®¹æ‡‰è©²ä¸åŒ…å«ä½ è¦ import çš„è³‡æº\næ¥è‘—å» cdk å…§åŠ å…¥æ–°çš„ codeï¼Œé€™é‚Šæœƒå»ºè­°è¨­å®šçš„è·ŸåŸæœ¬å­˜åœ¨ aws ä¸Šçš„è³‡æºå®Œå…¨ä¸€æ¨£ï¼Œå¦‚æœæœ‰ä¸€é»ä¸åŒæ­¥çš„è©±ï¼Œä¹‹å¾Œè¦æ”¹å¯èƒ½æœƒå‡ºå•é¡Œ\nä½¿ç”¨ cdk synth ç”¢ç”Ÿ cloudformationï¼Œå» cdk.out è£¡é¢æ‰¾åˆ°è©² template (B)\næ­¤æ™‚ template B æœƒå¤šå‡ºä¸€äº›æ±è¥¿ï¼ŒåŒ…æ‹¬ \u0026lsquo;æ–°è³‡æºçš„æ”¹å‹•\u0026rsquo; ä»¥åŠ \u0026lsquo;å…¶ä»–æ”¹å‹•\u0026rsquo;(CDKMetadataä¹‹é¡çš„ï¼Œæ‡‰è©²æ˜¯ cdk è‡ªå·±ç”¢ç”Ÿçš„ä¸€äº›ç‰ˆæœ¬è™Ÿ)ï¼Œå¯ä»¥ç”¨ vscode diff ä¹‹é¡çš„ä¾†æŸ¥çœ‹ï¼Œè¦æŠŠ B å…§é™¤äº†æ–°è³‡æºä»¥å¤–çš„è®Šå‹•ç”¨ A çš„è¦†è“‹æ‰\nåˆ° aws cloudformation é é¢å…§é¸æ“‡è©² stackï¼Œä¸¦åœ¨å³ä¸Šè§’ action è£¡é¢é¸æ“‡ import resourceï¼Œä¸Šå‚³ç¬¬ 5 æ­¥é©Ÿä¿®æ”¹å¾Œçš„ templateï¼Œé€™æ™‚ aws æœƒè‡ªå‹•åµæ¸¬åˆ° template å…§æœ‰äº›è³‡æºæ˜¯ç›®å‰ä¸åœ¨ aws stack ä¸Šçš„ï¼Œå°±å¯ä»¥æ‰‹å‹•å°‡è³‡æºå¡«é€²å»ï¼Œç„¶å¾Œå°±å®Œæˆæ‹‰ï¼\næœ€å¾Œå¯ä»¥åœ¨ cloudformation å³ä¸Šè§’æŒ‰ detect driftsï¼Œç„¶å¾Œ view driftsï¼Œæœƒè‡ªå‹•æª¢æŸ¥ cdk ç”¢ç”Ÿå‡ºä¾†çš„æ±è¥¿æ˜¯å¦èˆ‡åŸæœ¬ä¸Šé¢çš„è³‡æºä¸€è‡´ã€‚\næˆ‘åœ¨æ¬ç§»æ™‚å°±æœ‰é‡é cdk å…§å’Œ aws ä¸Šçš„å€¼ä¸åŒï¼Œè¦æŠŠ cdk å…§çš„å€¼æ”¹éå»ä¸¦ä¸” deploy æ™‚ï¼Œå‡ºç¾ \u0026lsquo;ä¸å¯ä»¥ç”¨åŒä¸€å€‹ value æ›´æ–° resource\u0026rsquo; é€™ç¨®éŒ¯èª¤ï¼Œæ‰€ä»¥å»ºè­°é‚„æ˜¯åœ¨æ¸¬è©¦ç’°å¢ƒå¤šç¢ºèªå¹¾æ¬¡ cdk èˆ‡ aws è³‡æºä¸€è‡´ï¼Œæ²’æœ‰ drifts ï¼Œæ‰åœ¨ production ä¸Šåš import æœƒæ¯”è¼ƒå®‰å…¨\n","description":"å¦‚é¡Œå•Š","id":7,"section":"posts","tags":[],"title":"AWSï¼Œå¦‚ä½•æŠŠåŸæœ¬ä½¿ç”¨ AWS console å»ºç«‹çš„è³‡æºå®Œæ•´æ¬åˆ° cdk å…§","uri":"https://markogoodman.github.io/posts/aws-migrate-from-existing-resource-to-cdk/"},{"content":"Redis è£¡é¢æœ‰ä¸€ç¨® data type å«åš sorted set\nç°¡å–®ä¾†èªªå°±æ˜¯ä¸€å † key:valueï¼Œä½†é€™äº›è³‡æ–™æœƒä¾ç…§ value (score) ä¾†æ’åº\nè®“ä½¿ç”¨è€…å¯ä»¥å¿«é€Ÿå–å¾—æŸå€‹ key çš„æ’åï¼Œæˆ–æ˜¯ä¸€å€‹æ’åç¯„åœ(æˆ–æ˜¯åˆ†æ•¸ç¯„åœ)å…§çš„ key å€‘ï¼Œç­‰ç­‰çš„åŠŸèƒ½\nè©³ç´°å¯ä»¥åƒè€ƒé€™å€‹ï½\nhttps://www.tutorialspoint.com/redis/redis_sorted_sets.htm\næœƒå¯«é€™ç¯‡æ˜¯å› ç‚ºçœ‹åˆ°é€™æ±è¥¿çš„å¯¦ä½œæ¯”è¼ƒç‰¹æ®Šï¼Œæƒ³æ‰¾æ‰¾çœ‹é€™å¯¦ä½œèƒŒå¾Œçš„åŸå› \nRedis sorted set å…§éƒ¨çµæ§‹ ç•¶è³‡æ–™é‡å°æ™‚ï¼Œsorted set ä½¿ç”¨çš„æ˜¯ ziplist è¶…éä¸€å®šé‡æ™‚å‰‡æ˜¯ä½¿ç”¨ hash map + skip list ziplist ä»¥å¾Œæœ‰ç©ºå†å¯« http://zhangtielei.com/posts/blog-redis-ziplist.html\nskip list æ€éº¼é‹ä½œçš„ä¹Ÿä¸ç‰¹åˆ¥è¬›ï¼Œç¶­åŸºç™¾ç§‘æˆ– google çœ‹ä¸€ä¸‹å¾ˆå¥½æŸ¥åˆ°ï¼ˆhttps://en.wikipedia.org/wiki/Skip_listï¼‰\nç‚ºä»€éº¼ Redis sorted set ä½¿ç”¨ skip list ä»Šå¤©ä¸»è¦æƒ³çœ‹çš„æ˜¯ç¬¬äºŒç¨®å¯¦ä½œçš„æ–¹æ³•ï¼Œä¸€é–‹å§‹æˆ‘çœ‹åˆ°é€™å€‹å¯¦ä½œï¼Œæƒ³èªªä¸€èˆ¬è³‡æ–™åº« range query ä¸éƒ½æ˜¯é  index å—(B+Treeã€BTree)ï¼Ÿ\nRedis æ€éº¼æç‰¹æ®Šè·‘ä¾†ç”¨ skip list XD\næƒ³è¦äº†è§£ä¸€ä¸‹ä»–é€™å€‹é¸æ“‡èƒŒå¾Œçš„æƒ³æ³•\næœäº†æœçœ‹åˆ°é€™ç¯‡æ–‡ https://news.ycombinator.com/item?id=1171423\nä½œè€…çµ¦äº†ä¸‰å€‹ç†ç”±\nä»¥ä¸‹æœƒæ‹¿ BTree å’Œ B+Tree ä¾†æ¯”è¼ƒä¸€ä¸‹ï¼Œå°é€™ä¸‰å€‹ç†ç”±ç ”ç©¶ä¸€ä¸‹ï¼Œä¸ç„¶æœ‰äº›ä¹çœ‹ä¹‹ä¸‹é‚„æ»¿é›£æ‡‚çš„\nThey are not very memory intensive. It\u0026rsquo;s up to you basically. Changing parameters about the probability of a node to have a given number of levels will make then less memory intensive than btrees. ç¬¬ä¸€å€‹ç†ç”±æ˜¯é—œæ–¼è¨˜æ†¶é«”ç”¨é‡çš„ï¼Œskip list ç›¸æ¯” balance tree ä¾†èªªè¨˜æ†¶é«”ç”¨é‡æ˜¯å¯ä»¥æ¯”è¼ƒå°çš„ï¼Œå°è±¡ä¸­å¦‚æœ p ç”¨ 1/4ï¼Œå¹³å‡æ˜¯æ¯å€‹ node æœƒæœ‰ 4/3 å·¦å³å€‹ pointer è€Œå·²ã€‚\nå› ç‚º Redis æ˜¯ in-memory é‹ä½œï¼Œç¯€çœè¨˜æ†¶é«”é€™é»å¯èƒ½é‚„æ»¿é‡è¦çš„ï¼Œç•¢ç«Ÿ memory è²´è²´ã€‚\nBtree å¦‚æœæ˜¯æ¯å€‹ node åªåŒ…å«ä¸€ç­†è³‡æ–™ï¼Œé‚£éº¼å°±æ˜¯æœƒæœ‰ 2 å€‹ pointerã€‚\nå¦‚æœå–®ä¸€ node æœ‰å¤šç­†è³‡æ–™ï¼Œpointer æ•¸é‡æœƒè®Šå°‘æ²’éŒ¯ï¼Œä½†å•é¡Œæ˜¯åŒä¸€ node çš„è³‡æ–™å¿…é ˆç·Šå¯†æ’åœ¨ä¸€èµ·ï¼Œå¸¸å¸¸æœƒæœ‰é ç•™çš„ç©ºé–“ï¼Œæœƒæµªè²»å¾ˆå¤šè¨˜æ†¶é«”ã€‚\nå¦‚æœç”¨çš„æ˜¯ B+Tree çš„è©±ï¼Œåªæœ‰ leaf nodes æœ‰å­˜è³‡æ–™ï¼Œé‚£ internal nodes è¨˜æ†¶é«”ä¹Ÿæ˜¯èŠ±å¾ˆå…‡ã€‚\nè©³æƒ…è«‹åƒè€ƒ https://en.wikipedia.org/wiki/B-tree\nA sorted set is often target of many ZRANGE or ZREVRANGE operations, that is, traversing the skip list as a linked list. With this operation the cache locality of skip lists is at least as good as with other kind of balanced trees. è€Œé€™å¥è©±ç¿»è­¯ä¸‹ä¾†å°±æ˜¯ï¼šä½¿ç”¨è€…å¤§å¤šæ˜¯ç‚ºäº† range query ä¾†ç”¨ sorted set çš„ï¼Œrange query æ™‚ skip list çš„ cache locality è‡³å°‘æœƒè·Ÿå…¶ä»–å¹³è¡¡è¡“ä¸€æ¨£å¥½ (ä¸å¾—ä¸èªªé€™ä¸€å¥è¶Šçœ‹è¶Šä¸æ‡‚ã€‚\né¦–å…ˆ skip list å°±è·Ÿ linked list ä¸€æ¨£ï¼Œåœ¨ cache locality ä¸Šæ˜¯æ¯” array å·®çš„ï¼Œå› ç‚ºè³‡æ–™ä¸é€£çºŒï¼Œcpu è®€è³‡æ–™æ™‚å¸¸å¸¸æœƒæŠŠé™„è¿‘çš„è³‡æ–™ä¸€èµ·è®€é€² cacheï¼Œè€Œ linked list è³‡æ–™æ•£ä½ˆåœ¨è¨˜æ†¶é«”å„è™•ï¼Œcpu æ¯”è¼ƒç„¡æ³•æŠŠç›¸é—œè³‡æ–™ä¸€æ¬¡å¡åˆ° cache ä¸Šã€‚\nå¦‚æœæ˜¯ä¸€å€‹ node åªæœ‰ä¸€ç­†è³‡æ–™çš„è©±ï¼ŒBTree çš„ cache locality ç¢ºå¯¦èˆ‡ linked list é¡ä¼¼ã€‚\nä¸é BTree å’Œ B+Tree å¦‚æœå–®ä¸€ node æœ‰å¤šç­†è³‡æ–™çš„è©± cache locality æ‡‰è©²æœƒæ¯”è¼ƒå¥½æ‰å°ï¼ˆï¼Ÿ\næœ‰äººçŸ¥é“è«‹å‘Šè¨´æˆ‘ XD\nä»¥æˆ‘çš„çŸ¥è­˜çœ‹èµ·ä¾†åœ¨ cache locality è¡¨ç¾ä¸Šæ‡‰è©²æ˜¯ BTrees å®¶æ— \u0026gt;= skip list\nBtree å®¶æ—æœƒè¢«å»£æ³›ç”¨åœ¨ database index ä¸Šä¹Ÿæ˜¯å› ç‚ºé€™å€‹è³‡æ–™èšé›†çš„ç‰¹æ€§ï¼Œä½¿å¾—åœ¨ç¡¬ç¢Ÿ io æ¬¡æ•¸å¯ä»¥æ¸›å°‘å¾ˆå¤šã€‚\n(ä¸éåˆæœ‰åœ¨ç¶²è·¯ä¸ŠæŸ¥åˆ°ä¸€äº› cache friendly çš„ skip listï¼Œæå¾—æˆ‘å¾ˆäº‚)\nThey are simpler to implement, debug, and so forth. For instance thanks to the skip list simplicity I received a patch (already in Redis master) with augmented skip lists implementing ZRANK in O(log(N)). It required little changes to the code. é€™å€‹å°±æ¯”è¼ƒå¥½ç†è§£äº†\nBTree åœ¨ Treverseï¼Œå¯èƒ½æœƒéœ€è¦ stack æˆ–æ˜¯ parent pointer çš„å¹«å¿™ï¼Œè¦ä¸Šä¸Šä¸‹ä¸‹çš„è·‘ï¼Œè€Œ B+Tree çš„è©±å‰‡æ˜¯ Traverse å¾ˆæ–¹ä¾¿ï¼Œä½†è·Ÿ BTree ä¸€æ¨£åœ¨æ’å…¥åˆªé™¤ä¿®æ”¹æ™‚éƒ½å¯èƒ½è¦ split merge ä¹‹é¡çš„\nè€Œ skip list çš„æ“ä½œå°±æ˜¯ä¸€å€‹ linked list æ“ä½œï¼Œå¹¾è¡Œå°±çµæŸäº†ã€‚\nSummary ç›®å‰çœ‹ä¸‹ä¾†æ˜¯ç¬¬ä¸€å€‹èˆ‡ç¬¬ä¸‰å€‹ç†ç”±æ¯”è¼ƒèƒ½èªªæœæˆ‘ï¼Œç¬¬äºŒå€‹ç†ç”±å‰‡æ˜¯è‡ªå·±æƒ³è¦ºå¾—ä¸å¤ªåˆç†ï¼Œç¶²è·¯ä¸Šä¹Ÿæ²’ä»€éº¼å¯ä»¥æ”¯æŒé€™å€‹èªªæ³•çš„ç›¸é—œè³‡è¨Šï¼Œä½œè€…ä¹Ÿæ²’æä¾› benchmarkï¼Œæ‰€ä»¥æš«æ™‚ä¿ç•™ã€‚\nä¸éæˆ‘å€‘å¯ä»¥å¾é€™äº›ç†ç”±çœ‹å‡ºä½œè€…åœ¨é¸ç”¨ skip list æ™‚æ˜¯æ€éº¼å»æ€è€ƒçš„ã€‚\nRedis å’Œå…¶ä»– database æœ€å¤§çš„å·®åˆ¥æ˜¯å®ƒæ˜¯ in-memory çš„ï¼Œè€Œå…¶ä»–ç”¨ BTree å®¶æ—çš„è³‡æ–™åº«å¤§å¤šæ˜¯å­˜åœ¨ç¡¬ç¢Ÿä¸Šï¼Œè€ƒé‡çš„é»å°±æœƒä¸åŒã€‚\nå¦‚æœ skip list åœ¨ range query æ™‚æ¯å€‹ node éƒ½è¦å»ç¡¬ç¢Ÿä¸Šæ’ˆä¸€æ¬¡æ‡‰è©²æœƒæ…¢åˆ°å¤©ä¸Šå»ï¼Œä½†åœ¨è¨˜æ†¶é«”å…§å°±å·®è·ä¸æœƒå¤ªå¤§ã€‚\nå¦‚æœ BTree ç›´æ¥ç”¨åœ¨ memory å…§åˆæœƒæ¶ˆè€—å¤ªå¤šç©ºé–“ï¼ˆå‰é¢æéçš„æµªè²»èˆ‡ pointer æ•¸é‡ï¼‰ï¼Œä½†ç”¨åœ¨ç¡¬ç¢Ÿä¸Šå°±æ¯”è¼ƒæ²’å•é¡Œï¼Œå› ç‚ºç¡¬ç¢Ÿç›¸å°å¤§åˆä¾¿å®œã€‚\nç¸½ä¹‹å°±æ˜¯ä¸€å€‹ trade offã€‚\n","description":"Sorted set ä½¿ç”¨ skip list çš„ä¸€é»çœ‹æ³•","id":8,"section":"posts","tags":["Redis","Sorted set"],"title":"Redis Sorted Set","uri":"https://markogoodman.github.io/posts/redis-sorted-set/"},{"content":"4 way handshake åœ¨ tcp é€£ç·šè¦çµæŸæ™‚å‰‡æ˜¯éœ€è¦å››æ¬¡æ¡æ‰‹\nï¼¡ -\u0026gt; ï¼¢ FIN\nï¼¢ -\u0026gt; ï¼¡ ACK\nï¼¢ -\u0026gt; ï¼¡ FIN\nï¼¡ -\u0026gt; ï¼¢ ACK\nç•¶ A æƒ³è¦çµæŸé€£ç·šæ™‚å°±å‚³é€ FIN çµ¦ Bï¼ŒB å…ˆç¢ºèª FIN ä¹‹å‰çš„è³‡æ–™éƒ½æ”¶åˆ°ä¹‹å¾Œå›å‚³ ACK çµ¦ A ç¢ºèªã€‚\næ¥è‘—åå‘åšä¸€æ¬¡ï¼Œæ•´å€‹é€£ç·šçµæŸ\nç¬¬ä¸€å€‹æ­¥é©Ÿ A å‚³ FIN çµ¦ B æ™‚ï¼Œè¦é—œé–‰çš„æ˜¯ A -\u0026gt; B çš„å‚³è¼¸è·¯ç·šï¼ˆç¬¬ä¸‰æ­¥å°±æ˜¯åéä¾†ï¼‰\nTCP æœƒè·Ÿæ‡‰ç”¨ç¨‹å¼èªª å°æ–¹é—œé–‰å‚³è¼¸äº†ï¼ˆæœ‰error eofä¹‹é¡çš„ï¼‰\nè€Œä»€éº¼æ™‚å€™è¦å‚³ FIN çµ¦å°æ–¹æ˜¯ç”±è‡ªå·± application ä¾†æ±ºå®šçš„ï¼Œæ‰€ä»¥å¦‚æœ application åæ‡‰å¾ˆå¿«å…¶å¯¦ä¹Ÿå¯ä»¥æŠŠ 2.3 æ­¥é©Ÿåˆåœ¨ä¸€èµ·è®Šæˆä¸‰æ¬¡æ¡æ‰‹ï¼Œä¸éé€šå¸¸ä¸æœƒé€™æ¨£å°±æ˜¯äº†\n","description":"æ¡æ‰‹æ‰‹","id":9,"section":"posts","tags":["HTTP"],"title":"Http 4 Way Handshake","uri":"https://markogoodman.github.io/posts/http-4-way-handshake/"},{"content":"protobuf vs json æœ€è¿‘å·¥ä½œæ–°å°ˆæ¡ˆè¦æŠŠåŸæœ‰çš„ http request å’Œ response éƒ½å¾ json æ”¹ç‚º protobuf\né æœŸæ˜¯å¯ä»¥è®“ç¶²è·¯å‚³è¼¸é‡é‚„æœ‰ (de)serialize åŠ é€Ÿï½\næ‰€ä»¥é€™é‚Šæƒ³ç ”ç©¶ä¸€ä¸‹ protobuf åˆ°åº•æ˜¯åšäº†ä»€éº¼æ‰æ¯” json å¿«\njson åŸºæœ¬ä¸Š json å°±æ˜¯ä¸€ä¸²å­—\nä¾‹å¦‚æˆ‘å€‘æ“ä½œçš„ object:\n{\r\u0026#34;key\u0026#34;: \u0026#34;value\u0026#34;\r} è½‰æˆå­—ä¸²å’Œbyteså°±æ˜¯é€™æ¨£\n{\u0026#34;key\u0026#34;:\u0026#34;value\u0026#34;} 7b 22 6b 65 79 22 3a 22 76 61 6c 75 65 22 7d å‚³è¼¸çš„æ™‚å€™å°±æ˜¯æŠŠé€™ä¸² byte å‚³éå»ï¼ŒåŒ…æ‹¬ {} \u0026quot;\u0026quot; éƒ½ç®—ï¼Œå¤§ç´„æ˜¯ 15 bytes\nè€Œä¸” deserialize çš„æ™‚å€™éƒ½æ˜¯è¦æƒéé‚£å€‹å­—ä¸²çš„æ¯ä¸€å€‹å­—ï¼Œåˆ¤æ–·æ¯å€‹å­—æ˜¯ç¬¦è™Ÿé‚„æ˜¯æ•¸å­—ç­‰ç­‰ï¼Œæ‰èƒ½è½‰æ›æˆç¨‹å¼èªè¨€è£¡é¢çš„ objectï¼Œå¾ˆè€—æ™‚\nprotobuf ä½¿ç”¨ protobuf ä¾†æºé€šå‰ client server è¦å…ˆå®šç¾©å¥½æºé€šçš„æ ¼å¼ .proto æª”æ¡ˆ\nä¾‹å¦‚\nsyntax = \u0026#34;proto3\u0026#34;;\rmessage Data { string key = 1;\r} client å’Œ server éƒ½æœƒä½¿ç”¨é€™å€‹æª”æ¡ˆä¾†ç”¢ç”Ÿå°æ‡‰çš„èªè¨€çš„è³‡æ–™çµæ§‹\nåƒæ˜¯ Go æœƒç”¢ç”Ÿ\nxxx.pb.go\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 type Data struct { state protoimpl.MessageState sizeCache protoimpl.SizeCache unknownFields protoimpl.UnknownFields Key string `protobuf:\u0026#34;bytes,1,opt,name=key,proto3\u0026#34;` } func (x *Data) GetKey() string { if x != nil { return x.Key } return \u0026#34;\u0026#34; } ç•¶æ”¶åˆ°ä¸€ä¸² byte æ™‚ï¼Œä½¿ç”¨ proto.Unmarshal å°±å¯ä»¥æŠŠ byte è½‰å› struct äº†\nWhy protouf is more efficient than json .proto æª”æ¡ˆæ¯å€‹ field å¾Œé¢éƒ½æœƒæœ‰å€‹æ•¸å­—ï¼Œåœ¨å‚³è¼¸æ™‚æœƒæ›¿ä»£ field name\nåˆ°é”ç›®çš„åœ°æ™‚å°æ–¹åœ¨ä½¿ç”¨å…ˆå‰å®šç¾©å¥½çš„ proto ä¾†æŸ¥è©¢æ•¸å­—å°æ‡‰çš„ field nameï¼Œå¯ä»¥çœä¸‹å¾ˆå¤šç©ºé–“\né™¤æ­¤ field name çš„æ›¿æ›å¤–ï¼Œprotobuf åœ¨å…§å®¹ä¸Šä¹Ÿæœƒæœ‰ç·¨æ’éè®“å‚³è¼¸èˆ‡ parse æ›´æœ‰æ•ˆç‡\nä»¥ä¸‹èˆ‰å€‹ä¾‹å­\nä¾‹å¦‚å‚³é€ string æ™‚å°±æœƒåŠ ä¸Šé•·åº¦çš„è³‡è¨Š\næˆ‘å€‘ç”¨ä¸Šé¢çš„ .proto ç‚ºæ ¼å¼å‚³é€äº†\n{\r\u0026#34;key\u0026#34;: \u0026#34;abc\u0026#34;\r} é‚£å¯¦éš›ä¸Šå‚³å‡ºå»çš„ bytes æœƒæ˜¯\n09 03 61 62 63 ç¬¬ä¸€å€‹ byte 0x09\nå¯ä»¥æ‹†è§£æˆ 00001 010\nå‰ 5 å€‹ bits 00001 ä»£è¡¨çš„æ˜¯ field name number\nå¾Œ 3 å€‹ bits 010 ä»£è¡¨çš„æ˜¯ string type\nåŸå…ˆçš„ \u0026ldquo;key\u0026rdquo; å»è¦ä½”ç”¨ 5 å€‹ bytesï¼Œé€™é‚Šåªè¦ 1 å€‹è€Œå·²\nç¬¬äºŒå€‹ byte 0x03 ä»£è¡¨äº†é•·åº¦\nå¾Œé¢æ¥è‘— 61 62 62 å°±æ˜¯å…§å®¹\nå¦‚æ­¤ä¸€ä¾†åœ¨ deserialize æ™‚å°±å¯ä»¥ç›´æ¥ä»¥ data[i:i+3] é€™ç¨®æ–¹å¼æŠ“å‡ºè³‡è¨Š\nä¸ç”¨åƒ json ä¸€æ¨£æ¯å€‹å­—å…ƒéƒ½åˆ¤æ–·ï¼Œç•¶é•·åº¦å¾ˆé•·æ™‚å·®è·æœƒå¾ˆå¤§\nå†èˆ‰å€‹å‚³è¼¸ integer(Varint) çš„ä¾‹å­\nå¦‚æœæ•¸å­—æ˜¯ 300 çš„è©±ï¼Œå¯¦éš›ä¸Šå‚³é€çš„è³‡æ–™æœƒæ˜¯\n1010 1100 0000 0010\næ¯å€‹ byte çš„ most significant bit ç”¨ä¾†ä»£è¡¨ä¸‹ä¸€å€‹ byte é‚„æ˜¯ä¸æ˜¯è³‡æ–™ï¼Œå¦‚æœæ˜¯ 1 çš„è©±ä»£è¡¨ä¸‹ä¸€å€‹ byte ä¹Ÿè¦ä¸€èµ·è¨ˆç®—\nå°‡ç¬¬ä¸€å€‹ bit å»æ‰ä¹‹å¾Œç„¶å¾Œå…©å€‹ byte reverse (å› ç‚ºå„²å­˜æ–¹å¼æ˜¯ least significant group first)\n_000 0010 _010 1100 å°±å¯ä»¥å¾—åˆ° 300 äº†\nè€Œ json åœ¨å‚³é€æ™‚æ¯å€‹å­—å…ƒéƒ½ä»£è¡¨äº†ä¸€å€‹ byteï¼Œåœ¨æ•¸å­—å¤§çš„æ™‚å€™è³‡æ–™é‡å·®è·ä¹Ÿå¾ˆå¤§\nç¸½çµèˆ‡å„ªç¼ºé» å‰é¢èˆ‰äº†ä¸€äº›ä¾‹å­ä¾†èªªæ˜ protobuf çš„è¨­è¨ˆæ˜¯å¦‚ä½•è®“å®ƒæ›´æœ‰æ•ˆç‡\nfield name number å¦‚ä½•çœè³‡æ–™é‡\nstring å¦‚ä½•è®“ parse æ›´å¿«\ninteger å¦‚ä½•çœè³‡æ–™é‡\né‚„æœ‰çœæ‰äº†ç¬¦è™Ÿ {} , : çš„è³‡æ–™é‡\næ‡‰è©²é‚„æœ‰å…¶ä»–çš„ä½†å°±ä¸ä¸€ä¸€åˆ—èˆ‰\nç¸½ä¹‹ä½¿ç”¨ protobuf å°æˆ‘å€‘çš„ç¨‹å¼è™•ç†è³‡æ–™éƒ½æœƒæœ‰æ•ˆç‡å¾ˆå¤š\nè€Œè³‡æ–™å…§å®¹åœ¨è™•ç†å‰æ˜¯äººé¡ä¸å¯è®€çš„ï¼ˆæœ‰å¥½æœ‰å£ï¼‰\nç›®å‰å¾ä½¿ç”¨ json è½‰æ›åˆ° protobuf å¾Œæ„Ÿè¦ºå¤šäº†ä¸€äº›é–‹ç™¼æˆæœ¬ï¼Œç•¢ç«Ÿå‰å¾Œç«¯éƒ½ç¿’æ…£ç”¨ json ä¾†åšäº‹æƒ…ï¼Œå¤šäº†ä¸€å€‹æ±è¥¿è¦ç®¡ï¼Œå¤§å®¶éƒ½è¦ç†Ÿæ‚‰æ‰è¡Œ\nå¦‚æœé–‹ç™¼çš„æ±è¥¿è¦æ¨¡ä¸å¤§ï¼Œè³‡æ–™é‡ä¸å¤§çš„è©±é‚„æ˜¯å¾ json é–‹å§‹ä½¿ç”¨é¿å…é¡å¤–æˆæœ¬éé«˜\nRef: https://developers.google.com/protocol-buffers/docs/encoding\n","description":"protobuf æ€éº¼é‚£éº¼å¿«","id":10,"section":"posts","tags":["protobuf"],"title":"Protobuf and Json","uri":"https://markogoodman.github.io/posts/protobuf-and-json/"},{"content":"How channel works Note of\nhttps://www.youtube.com/watch?v=KBZlN0izeiY\u0026amp;ab_channel=GopherAcademy\nby Kavya Joshi.\nChannel ï¼ï¼ï¼ goroutine-safe\nstore dataã€FIFO\npass data between goroutines\nblock, unblock goroutine\nmaking channels https://golang.org/src/runtime/chan.go\nhchan struct contains\nbuf -\u0026gt; circular queue (with send index \u0026amp; receive index)\nsendx\nrecvx\nmutex\nsendq // list of sudo g\nrecvq // list of sudo g\n\u0026hellip; ch := make(chan Task, 3)\nThis comman allocates an hchan on the heap\nch is a pointer to hchan\nsends and receives sender sends\nacquires lock put a copy of data into channel buf releases lock no shared memory except hchan between goroutines\nwhat if a sender trys to send data into a full channel? Sender (G1), Receiver(G2)\nSender G1\nG1 creates a sudog(of itself, this contains goroutine pointer and data) and puts it into the sendq.\nG1 calls the scheduler to detach(gopark) G1 from the M and set G1 to waiting state.\nThen the scheduler pops a runnable G from runq and schedules it to run on the M.\nSender is blockd but not the OS thread.\nHow to resume?\nReceiver\nGet an element from channel buf then pops a sudog from sendq.\nEnqueue data(in poped sudog) into buf.\nCalls into the scheduler to set the waiting sender(G1) to runnable and put it in runq of P(or global queue).\nReturns to Receiver\nwhat if a receiver trys to receive data on an empty channel? Sender (G1), Receiver(G2)\nReceiver\nG2 puts a sudog into recvq then call gopark to detach from M.\nSender\nG1 enqueue data into the buf, and call goready???\nNo,\nG1 writes to memory location of G2 directly\nG1 writes to G2\u0026rsquo;s stack\nG2 does not need to access the channel, and fewer memory copy\ndesign considerations simplicity queue + lock v.s. lock-free\nperformance So threads not blocked\ncross-goroutine stack \u0026amp; reads writes\ngoroutine wake up is lockless\nfewer memory copy\nothers nbufferd channel: read and write directly to each other\u0026rsquo;s stack\nselect: put the current goroutine to sendq and recvq of the channels in cases then call scheduler.\n","description":"How channel works??","id":11,"section":"posts","tags":["Go","Channel"],"title":"How Channel Works","uri":"https://markogoodman.github.io/posts/how-channel-works/"},{"content":"æ€éº¼è£èˆŠç‰ˆçš„ homegrew å¥—ä»¶ å·¥ä½œçš„æ™‚å€™è¦è£ protobuf çš„ 3.15.8 ç‰ˆï¼Œæ²’æƒ³åˆ° homebrew ä¸çµ¦è£ï¼²ï¼²ï¼²\nç”¨ brew info protobuf æŸ¥äº†ä¸€ä¸‹ç¾åœ¨æœ€æ–°ç‰ˆå·²ç¶“åˆ° 3.17.x äº†ï¼Œ3.15.8 ä¹Ÿæ²’åˆ—å‡ºä¾†\nä¼°ç‹—äº†ä¸€ä¸‹ç™¼ç¾é€™ç¯‡ https://itnext.io/how-to-install-an-older-brew-package-add141e58d32\næ²’æƒ³åˆ°è·Ÿè‘—åšç«Ÿç„¶å™´éŒ¯ï¼Œä¼¼ä¹æ˜¯ homebrew æ›´æ–°å¾Œä¸è®“ä½¿ç”¨è€…ç›´æ¥ç”¨ url å®‰è£äº†\né‚„å¥½ç•™è¨€è£¡é¢æœ‰å€‹è§£ç­”ï¼Œå¹«ä»–ç¿»è­¯ä¸€ä¸‹\nä¸»è¦å°±æ˜¯è‡ªå·±å»ºä¸€å€‹ tap(æœ‰é»é¡ä¼¼å¥—ä»¶åº«çš„æ„Ÿè¦º)ï¼Œç„¶å¾ŒæŠŠ protobuf çš„ 3.15.8 ç‰ˆæœ¬å¡é€²å»ï¼Œä¹‹å¾Œ brew install protobuf@3.15.8 å°±å¯ä»¥åœ¨é€™å€‹ tap å…§æ‰¾åˆ°ã€‚\nä»¥ä¸‹ç‚ºæ­¥é©Ÿ\nåœ¨è‡ªå·±çš„ github è£¡é¢å»ºä¸€å€‹ repo åå­—å«åš homebrew-custom (\u0026ldquo;homebrew-\u0026rdquo; é–‹é ­å°±å¥½) åŸ·è¡Œ brew extract \u0026ndash;version=3.15.8 protobuf \u0026lt;github_username\u0026gt;/custom æ¥è‘—å°±å¯ä»¥åŸ·è¡Œ brew install protobuf@3.15.8 äº† ç¬¬äºŒæ­¥é©Ÿè£¡é¢ï¼Œhomebrew çœ‹åˆ°å¾Œé¢é‚£å€‹ custom æœƒè‡ªå‹•åŠ ä¸€å€‹ homebrew- çš„ prefix è®Šæˆ repo_nameï¼Œç„¶å¾Œé…åˆ github_username æ‰¾åˆ°ä½ çš„ github repoï¼Œæ¥è‘—å» homebrew-core repo è£¡é¢æ‰¾æ­·å²ç´€éŒ„ï¼ŒæŠŠ protobuf 3.15.8 æ‹¿å‡ºä¾†ï¼Œå¡åˆ° /usr/local/Homebrew/Library/Taps/ ä¸‹é¢çš„ github_username è£¡é¢ï¼Œ\nbrew install å°±å¯ä»¥é‹ä½œäº†\nç„¶å¾Œå¯ä»¥è¨˜å¾—æŠŠ /usr/local/Homebrew/Library/Taps//\u0026lt;repo_name\u0026gt; push ä¸Šå» githubï¼Œä¹‹å¾Œåˆ¥å°é›»è…¦ brew tap ä¸€ä¸‹å°±å¯ä»¥ç”¨äº†\n","description":"ã„œ å¦‚é¡Œ","id":12,"section":"posts","tags":[],"title":"æ€éº¼å®‰è£ homebrew è£¡é¢çš„èˆŠç‰ˆ package","uri":"https://markogoodman.github.io/posts/brew-install-older-pkg/"},{"content":"Hyperloglog é€™ä¹Ÿæ˜¯åœ¨å·¥ä½œæ¥è§¸åˆ°çš„æ±è¥¿ï¼Œæ˜¯ç”¨ä¾†åšåŸºæ•¸çµ±è¨ˆçš„ä¸€å€‹æ–¹æ³•\nç¬¬ä¸€æ¬¡çœ‹åˆ°çœŸçš„è¦ºå¾—é€™æ˜¯ä»€éº¼å·«è¡“0.0\nç›®çš„æ˜¯è¦åšä¸€å€‹æŒ‰è®šçš„ç³»çµ±\nå°±æ˜¯ç©å®¶å¯ä»¥é‡è¤‡å°æŸå€‹å½±ç‰‡æŒ‰è®šï¼Œæ¯æ¬¡éƒ½è¦æœ‰ logï¼Œä½†çµ±è¨ˆæŒ‰è®šæ•¸æ™‚åŒä¸€å€‹ç©å®¶åªè¨ˆç®—ä¸€æ¬¡\nåŸºæ•¸çµ±è¨ˆ åŸºæ•¸ -\u0026gt; unique value count\nç¬¬ä¸€å€‹æƒ³åˆ°çš„æ‡‰è©²å°±æ˜¯ç”¨ hashmapï¼Œç°¡å–®å¥½ç”¨å¹¾ä¹æ¯å€‹ç¨‹å¼èªè¨€éƒ½æœ‰å…§å»º\nç¼ºé»å°±æ˜¯åŸºæ•¸å¤§çš„æ™‚å€™ç©ºé–“æ¶ˆè€—å¤§\nå†ä¾†å°±æ˜¯ç”¨ bitmapï¼ŒæŠŠæ¯å€‹ key éƒ½å°æ‡‰åˆ°æŸä¸€å€‹ bitï¼Œç›¸è¼ƒ hashmap ç©ºé–“æœƒå°‘ç”¨ä¸€äº›ï¼Œä½†é•·åº¦åŸºæœ¬ä¸Šä¹Ÿæ˜¯æœƒè¶Šä¾†è¶Šé•·\nHyperloglog æ˜¯ä¸€ç¨®åŸºæ•¸çš„ä¼°ç®—æ–¹æ³•ï¼Œä¸Šé¢å…©ç¨®éƒ½æ˜¯ç²¾ç¢ºåœ°çŸ¥é“ä¸é‡è¤‡çš„æ•¸é‡æœ‰å¤šå°‘ï¼Œä¹Ÿå¯ä»¥çŸ¥é“æŸå€‹å€¼æ˜¯å¦å‡ºç¾é\nè€Œé€™ç¨®ä¼°è¨ˆæ–¹æ³•æœƒæœ‰èª¤å·®ï¼Œè€Œä¸”ä¹Ÿç„¡æ³•çŸ¥é“æŸå€‹å€¼æ˜¯å¦å·²ç¶“å‡ºç¾\nä½†æ˜¯ç›¸å°å®ƒçš„é€Ÿåº¦å¾ˆå¿«ï¼Œè€Œä¸”ä½¿ç”¨ç©ºé–“éå¸¸çš„å°\nHyperloglog åŸºæœ¬æ¦‚å¿µ æ˜¯ä¸€ç¨®æ©Ÿç‡çš„æ¦‚å¿µ\næŠŠè³‡æ–™è½‰æ›æˆä¸€ä¸² bit\nå› ç‚ºæ¯å€‹ bit æ˜¯ 0 æˆ–æ˜¯ 1 çš„æ©Ÿç‡éƒ½æ˜¯ 1/2\næ‰€ä»¥å¾é€™ä¸² bit å·¦é‚Šé–‹å§‹çœ‹ï¼Œé€£çºŒæœ‰ n (n\u0026gt;0) å€‹ 0 çš„æ©Ÿç‡æ˜¯ (1/2)^n\næ‰€ä»¥ç•¶æˆ‘å€‘æœ‰å¾ˆå¤šç­†è³‡æ–™æ™‚\néœ€è¦åšçš„å°±æ˜¯æŠŠæ¯ç­†è³‡æ–™éƒ½è½‰æ›æˆä¸€ä¸² bit\næ‰¾å‡ºå¾å·¦é‚Šæ•¸ä¾†ç¬¬ä¸€å€‹ 1 çš„ä½ç½® (é€£çºŒ0çš„æ•¸é‡+1)\nä¾‹å¦‚ä»¥ä¸‹ä¸‰ç­†\n00110110 -\u0026gt; 3\n01010111 -\u0026gt; 2\n00010010 -\u0026gt; 4\nå¾ä¸­å–æœ€å¤§å€¼ 4ï¼Œ 2^4 = 16 å€‹å…ƒç´ \næ¨æ¸¬æ¦‚å¿µæ˜¯ï¼Œæˆ‘å€‘å¤§ç´„æœ‰äº† 16 ç­†è³‡æ–™ï¼Œæ‰èƒ½å¾—åˆ°ä¸€ä¸²æœ‰é€£çºŒä¸‰å€‹ 0 çš„è³‡æ–™\nå¤§è‡´æ¦‚å¿µæ˜¯ä¸Šé¢é‚£æ¨£ï¼Œç•¶ç„¶ç›´æ¥ä½¿ç”¨æœƒæœ‰ä¸å°‘èª¤å·®\næ‰€ä»¥æ¥ä¸‹ä¾†å°±æ˜¯ä¸€å †èª¤å·®è™•ç†æ–¹æ³•\nèˆ‰å€‹ç°¡å–®çš„ä¾‹å­ï¼Œåƒæ˜¯ä¸‹é¢é€™ç¨®æœ‰äº”ç­†è³‡æ–™ï¼Œå°‡å‰å…©å€‹ bit ç•¶ä½œ bucket numberï¼Œå°‡æ¯å€‹ bucket å„è‡ªå–æœ€å¤§ï¼Œå†æŠŠæ¡¶å­ä¹‹é–“å¹³å‡\n[00] 110110 -\u0026gt; 1 (é€™ç­†è³‡æ–™åœ¨æ¡¶å­[00]ä¸­ä¸æ˜¯maxï¼Œè¢«å¿½ç•¥)\n[00] 010010 -\u0026gt; 2\n[01] 010111 -\u0026gt; 2\n[10] 100010 -\u0026gt; 1\n[11] 010010 -\u0026gt; 2\n(2+2+1+2) / 4 = 1.75\nä¼°è¨ˆå€¼ = 4 * 2^(1.75) = 13.45\nå› ç‚ºæ¯æ¬¡è³‡æ–™é€²ä¾†éƒ½æ˜¯è½‰æ›æˆ bitï¼Œç„¶å¾Œçœ‹çœ‹æœ‰æ²’æœ‰æ¯”ç›®å‰æœ€å¤šé€£çºŒ 0 çš„æ•¸é‡é‚„å¤šï¼Œæœ‰çš„è©±å°±æ›´æ–°ä¸€ä¸‹ï¼Œæ‰€ä»¥åŸºæœ¬ä¸Šåªè¦ä¸€ä¸² bit çš„ç©ºé–“å°±å¯ä»¥è¨ˆç®—åŸºæ•¸äº†\nLoglog èˆ‡ HyperLoglog å¤§æ¦‚éƒ½æ˜¯ç”¨é€™ç¨®æ¦‚å¿µå»ä¼°è¨ˆåŸºæ•¸(Hyperloglogæ¯”è¼ƒæ–°)\nä½†åˆæœƒç”¨ä¸€äº›æ–¹æ³•å»ä¿®æ­£ç®—å¼æ¸›å°‘èª¤å·®(ä¹˜ä¸Šå¸¸æ•¸ä»€éº¼ï¼Œåå·®ä¿®æ­£ä¹‹é¡çš„ï¼Œæ•¸å­¸å®¶å¾ˆå²å®³)\nè©³ç´°å¯ä»¥åƒè€ƒä¸‹é¢é€™äº›é€£çµï¼Œä¸éæ¯æ¬¡çœ‹äº†éƒ½å¿˜è¨˜ï¼Œåªè¨˜å¾—æ¦‚å¿µè€Œå·²\nhttp://blog.codinglabs.org/articles/algorithms-for-cardinality-estimation-part-iii.html\nhttps://en.wikipedia.org/wiki/HyperLogLog\nhttps://blog.csdn.net/u011564172/article/details/86597575\nç„¶å¾Œ Redis å…§å…¶å¯¦å°±æœ‰å…§å»ºçš„ Hyperloglog å¯ä»¥ç”¨äº†\næ–¹æ³•å¾ˆç°¡å–®\nPFADD key value // æŠŠ value åŠ å…¥åŸºæ•¸è¨ˆç®—å…§ PFCOUNT key // ä¼°ç®—å‡ºä¾†çš„åŸºæ•¸ ä¸éå·¥ä½œä¸Šæœ€å¾Œæ±ºå®šé‚„æ˜¯ä¸ç”¨é€™å€‹æ–¹æ³•ï¼Œå› ç‚ºæ ¹æ“šæµé‡ä¾†çœ‹æŒ‰è®šçš„äººæ•¸æ ¹æœ¬å°±ä¸æœƒè®“ç©ºé–“æ¶ˆè€—å¾ˆå¤§QQï¼Œè€Œä¸”æŒ‰è®šçš„åå–®ä¹Ÿæƒ³å­˜åœ¨ db è£¡é¢ï¼Œç”¨äº†é‚„è¦å…ˆç¶“é redis æ„Ÿè¦ºæœ‰é»å¤šæ­¤ä¸€èˆ‰(mongodb æ²’æœ‰ hyperloglog)ï¼Œç›´æ¥ç°¡å–®ç”¨ hash map åšå°±å¥½äº†\n","description":"åŸºæ•¸ç¥å™¨ï¼Œè¨ˆç®—ä¸é‡è¤‡çš„å…ƒç´ é‚„åœ¨ç”¨ hash table å—ï¼Ÿ ä¾†çœ‹çœ‹æœ€æ–°æ½®çš„ hyperloglog","id":13,"section":"posts","tags":["redis","hyperloglog","cardinality"],"title":"Hyperloglog","uri":"https://markogoodman.github.io/posts/hyperloglog/"},{"content":"Redis transaction å·¥ä½œæ™‚æœ‰éœ€è¦åšä¸€å€‹\nSet if key exists\nç™¼ç¾ redis åªæä¾›ä¸€å€‹ SETNXï¼ŒSet if key doesn\u0026rsquo;t exist\né †ä¾¿ä¾†ç ”ç©¶ä¸€ä¸‹ redis çš„ transaction\nMULTI https://redis.io/topics/transactions\nåœ¨ redis è£¡é¢åš transaction åŸºæœ¬ä¸Šå°±æ˜¯ä½¿ç”¨ MULTI\nMULTI SET key0 value0 SET key1 value1\rEXEC Note: redis transaction è·Ÿä¸€èˆ¬çš„ db transaction æœ‰é»ä¸ä¸€æ¨£ï¼Œå¯ä»¥ä¿è­‰ä¸­é–“ä¸è¢«æ’å…¥å…¶ä»–æŒ‡ä»¤ï¼Œç…§é †åºåŸ·è¡Œï¼Œä½†åšåˆ°ä¸€åŠå‡ºéŒ¯ä¸æœƒ rollbackï¼Œä¸”ç”šè‡³æœƒç¹¼çºŒå¾€ä¸‹åš\nä¾‹å¦‚\nSET a 1\rSET b ssss\rSET c 1\rMULTI\rINCR a\rINCR b\rINCR c\rEXEC\r1) (integer) 2\r2) (error) ERR value is not an integer or out of range\r3) (integer) 2 Redis ç‚ºä½•æ²’æœ‰ rollback:\nhttps://redislabs.com/blog/you-dont-need-transaction-rollbacks-in-redis/\nRedis persistency:\nhttps://redis.io/topics/persistence?_ga=2.166846334.1799612137.1620217522-2107259978.1617716900\ntransaction åšåˆ°ä¸€åŠçœŸçš„æ©Ÿå™¨åœä½çš„è©±ï¼Œå¯èƒ½çœŸçš„åªæœ‰ä¸€åŠæŒ‡ä»¤é€²å»ï¼ŒAOFçš„è©±å°±å¯ä»¥æŠŠå¤šçš„é‚£éƒ¨åˆ†å»æ‰ï¼ŒRDBçš„è©±æ‡‰è©²æ˜¯ç›´æ¥æ‰è³‡æ–™äº†ï¼ˆï¼Ÿ\næˆ‘å€‘ Server ä½¿ç”¨çš„æ˜¯ https://github.com/go-redis/redis\nè£¡é¢æä¾›äº† TxPipeline å°±æ˜¯æ¥åˆ° MULTI ä¸Šé¢\ngo-redis æä¾›çš„ Pipeline æ²’æœ‰ç”¨ MULTI EXEC åŒ…èµ·ä¾†ï¼Œä¸­é–“æœ‰å¯èƒ½è¢«åˆ‡é–‹ï¼Œå°±æ˜¯ä¸€æ¬¡å‚³å¾ˆå¤šæŒ‡ä»¤å» redis æ¸›å°‘ round trip æ™‚é–“\nä½¿ç”¨æ–¹æ³•ä¹Ÿæ»¿ç°¡å–®çš„\n1 2 3 4 pipe := client.TxPipeline() pipe.Incr(key) pipe.Expire(key, time.Minute*15) _, err = pipe.Exec() ä¸éé‚„æ˜¯æ²’è¾¦æ³•é”åˆ° set if key exists\nå¦‚ä¸‹é¢çš„ç¯„ä¾‹ï¼Œå› ç‚º exists è¦ç­‰åˆ° pipe.Exec() ä¹‹å¾Œæ‰æœƒæœ‰æ­£ç¢ºçš„å€¼é€²å»\n1 2 3 4 5 6 pipe := client.TxPipeline() pipe.Set(key, 1, 1*time.Second) exists := pipe.Exists(key) fmt.Println(exists.Val()) // 0 pipe.Exec() fmt.Println(exists.Val()) // 1 ä¼°ç‹—äº†ä¸€ä¸‹ç™¼ç¾åªå¥½ç”¨ WATCH ä¾† workaround\nWATCH å¯ä»¥ç›£è¦–ä¸€å€‹ key\nä¹‹å¾Œä½¿ç”¨ MULTI EXEC å¦‚æœç™¼ç¾é€™å€‹ key è¢«å‹•éï¼Œå°±æœƒ EXEC å¤±æ•—\nWATCH key0\rMULTI\rSET xxx xxxxx\rEXEC // å¦‚æœ key0 åœ¨ EXEC ä¹‹å‰è¢«æ”¹éï¼Œå°±æœƒå¤±æ•— æ‰€ä»¥è¦å¯¦ç¾ set if key exists\nå°±è®Šæˆ\n// sudo code\rWATCH key0\rexists = EXISTS key0\rif exists == True {\rMULTI\rSET xxx xxxxx\rEXEC // å¦‚æœ key0 åœ¨ EXEC ä¹‹å‰è¢«æ”¹éï¼Œå°±æœƒå¤±æ•—\r} ä½†ä¹Ÿä¸å…¨ç„¶æ˜¯åªè¦å­˜åœ¨å°± setï¼Œå› ç‚ºç•¶ key0 è¢«æ”¹çš„æ™‚å€™ä¹Ÿæœƒä¸åš\nä¸‹é¢æ˜¯ Go è£¡é¢çš„åšæ³•\nåƒè€ƒï¼šhttps://www.tizi365.com/archives/309.html\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 key := \u0026#34;key\u0026#34; fn := func(tx *redis.Tx) error { // Do things exists := client.Exists(key).Val() if exists != 1 { return nil } // client.HSet(key, \u0026#34;B\u0026#34;, 666) // Modifying key causes transaction failure // call Pupeline if key is not changed _, err := tx.Pipelined(func(pipe redis.Pipeliner) error { pipe.HSet(key, \u0026#34;A\u0026#34;, 2) return nil }) return err } client.HSet(key, \u0026#34;A\u0026#34;, 1) fmt.Println(\u0026#34;Before\u0026#34;, client.HGet(key, \u0026#34;A\u0026#34;).Val()) err := model.userRedis.Watch(fn, key) fmt.Println(err) // å¤±æ•—çš„è©±æœƒå°å‡º redis: transaction failed fmt.Println(\u0026#34;After\u0026#34;, client.HGet(key, \u0026#34;A\u0026#34;).Val()) return ","description":"Redis transaction æ€éº¼ç”¨ï¼²","id":14,"section":"posts","tags":["Redis","Transaction"],"title":"Redis Transaction ä½¿ç”¨","uri":"https://markogoodman.github.io/posts/redis-transaction/"},{"content":"Docker https://www.youtube.com/watch?v=3c-iBn73dDE\nå‰å¹¾å¤©çœ‹äº†ä¸€å€‹ç°¡å–®ä»‹ç´¹ docker çš„å½±ç‰‡é‚„æ»¿å®Œæ•´çš„ï¼Œç´€éŒ„ä¸€ä¸‹å¤§æ¦‚è¬›äº†ä»€éº¼ï¼Œæ²’æœ‰å¤ªæ·±å…¥çš„æ±è¥¿ä¸éæ‡‰è©²æ»¿å¤ ç”¨çš„\nä»–è£¡é¢æœ‰åšäº†ä¸€å€‹ç°¡å–®çš„ç¯„ä¾‹ï¼Œä¹‹å¾Œè¦ç”¨æ‡‰è©²æ»¿å¥½åƒè€ƒçš„\nhttps://gitlab.com/nanuchi/techworld-js-docker-demo-app\nç‚ºä»€éº¼è¦ Container å¯ä»¥æŠŠä¸€å€‹ application å’Œä»–æ‰€éœ€è¦çš„æ‰€æœ‰æ±è¥¿(ä¾è³´çš„ lib æˆ–æ˜¯ è‡ªå·±å¯«çš„ config ä¹‹é¡çš„)åŒ…åœ¨ä¸€èµ·ï¼Œæ‰€ä»¥é€™å€‹ container ä¸éœ€è¦ä¾é å…¶ä»–æ±è¥¿ä¾†é‹ä½œ\nå› ç‚ºéœ€è¦çš„æ±è¥¿éƒ½åŒ…åœ¨ä¸€èµ·äº†ï¼Œæ‰€ä»¥ä¸ç®¡æ‹¿åˆ°å“ªå°æ©Ÿå™¨ä¸Šéƒ½ä¸æœƒå› ç‚ºæ©Ÿå™¨çš„ç’°å¢ƒå·®ç•°é€ æˆè¡Œç‚ºä¸åŒ\nè®“é–‹ç™¼åˆ°éƒ¨ç½²éƒ½éå¸¸æ–¹ä¾¿\nä¾‹å¦‚ï¼š\né–‹ç™¼æœŸé–“ï¼Œä¸åŒçš„é–‹ç™¼è€…ï¼Œè¦æŠŠç’°å¢ƒè¨­å®šåˆ°ä¸€æ¨£æ˜¯å¾ˆå›°é›£çš„ï¼Œä¸åŒæ©Ÿå™¨ä¸Šèªªä¸å®šæœƒè¡Œç‚ºä¸åŒï¼Œé€ æˆé–‹ç™¼å›°é›£\nç”šè‡³ä¹Ÿå¯èƒ½åœ¨ä¸€å°é›»è…¦ä¸Šéœ€è¦ä¸åŒç‰ˆæœ¬çš„æŸå€‹æ‡‰ç”¨ç¨‹å¼ï¼Œè¦ä¸€ç›´åˆ‡æ›\næˆ–æ˜¯éƒ¨ç½²æ™‚ï¼Œé–‹ç™¼äººå“¡æŠŠä¸€å †ç¨‹å¼çš„å®‰è£ä»¥åŠç’°å¢ƒè¨­å®šçš„æ­¥é©Ÿäº¤çµ¦ operation team å»è¨­å®š serverï¼Œä½†æ™‚å¸¸é€™äº›è¤‡é›œçš„æ­¥é©Ÿæ˜¯ç„¡æ³•æ‰€æœ‰ç´°ç¯€éƒ½äº¤ä»£æ¸…æ¥šçš„\nè€Œä¸”è¦ä¿æŒé–‹ç™¼å’Œéƒ¨ç½²ç’°å¢ƒä¸€ç›´ä¸€è‡´ä¹Ÿæ˜¯å¾ˆå›°é›£ï¼Œä»¥ä¸Šéƒ½å¾ˆå®¹æ˜“å‡ºäº‹\né€™äº›äº‹æƒ…æœ‰å®¹å™¨å¹«å¿™å°±å¯ä»¥æ–¹ä¾¿å¾ˆå¤š\nDocker vs Virtual Machine ä½œæ¥­ç³»çµ±æœ‰å…©å±¤ï¼Œkernel å±¤å’Œ application å±¤\nä¸åŒç‰ˆæœ¬çš„ Linux ä¾‹å¦‚ debian, ubuntuï¼Œå°±æ˜¯ç”¨åŒä¸€ç¨® kernelï¼Œä½†ä¸Šé¢æ˜¯ä¸åŒçš„ application\nDocker åªè™›æ“¬åŒ– application layerï¼Œä½¿ç”¨ host çš„ kernel\nVM å‰‡æ˜¯å…©å±¤éƒ½æœ‰ï¼ˆè™›æ“¬åŒ–æ•´å€‹osï¼‰\næ‰€ä»¥ docker å°ã€å¿«\nä½†å¦‚æ­¤ä¸€ä¾†æŸäº› docker image å°±æœƒä¸é©ç”¨åœ¨æŸ host ä¸Š å› ç‚º os kernel èˆ‡ image ä¸ç›¸å®¹ï¼Œåƒæ˜¯èˆŠç‰ˆçš„ windows èˆ‡æŸäº›èˆŠç‰ˆçš„ mac\nè¦ç”¨ docker toolbox è™•ç†\nContainer, Image ?? image å°±æ˜¯ä¸€å€‹æ¨¡æ¿ï¼Œæ•˜è¿°äº†é€™å€‹ container ä½œæ¥­ç’°å¢ƒè£¡é¢æ‰€æœ‰çš„æ±è¥¿\nåŸ·è¡Œèµ·ä¾†ä¹‹å¾Œå°±æ˜¯ä¸€å€‹ container\nContainer Repository(Registry) å­˜æ”¾ image çš„åœ°æ–¹ï¼Œå…¬å¸å¸¸æœ‰ç§æœ‰çš„ repo æ”¾å…§éƒ¨è‡ªå·± build å‡ºä¾†çš„ image\nå…¬æœ‰çš„åƒæ˜¯ Dockerhubï¼Œå¤§å®¶æœƒä¸Šå‚³å¾ˆå¤šå¥½ç”¨çš„ image ä¸Šå»\nImage Image æ˜¯ä¸€å€‹å±¤å±¤ç–Šç–Šçš„æ¦‚å¿µ\nä¾‹å¦‚é€™å€‹ redis çš„ image\nhttps://github.com/docker-library/redis/blob/1511c433cdb80391d897b5d2a04c67c261bf5f4b/6.2/Dockerfile\nå°±æ˜¯ç”±ä¸€å€‹ base image (debian:buster-slim) ä¹‹ä¸Šï¼Œè¨­å®šä¸€å †ç’°å¢ƒè®Šæ•¸ï¼ŒæŠŠ redis è£ä¸Šå»ï¼Œè€Œå½¢æˆé€™å€‹ image\nè¦è£½ä½œè‡ªå·±çš„ redis image æ™‚ï¼Œä¹Ÿå¯ä»¥æ ¹æ“šè‡ªå·±çš„éœ€æ±‚ï¼ŒæŠŠ config ç­‰ç­‰çš„è³‡è¨Šç–Šåœ¨é€™å€‹é€šç”¨çš„ redis image ä¹‹ä¸Šï¼Œå½¢æˆè‡ªå·±çš„ image\nNote: é€šå¸¸æœ€åº•ä¸‹é‚£å±¤éƒ½æ˜¯ Linux based image (è¦å°ï¼Œalpine ä¹‹é¡çš„)\nå¸¸ç”¨ cmd docker pull xxx\ndocker run xxx\ndocker run -d xxx = ä¸å¡åœ¨ terminal\ndocker ps -a åˆ—å‡ºæ‰€æœ‰ container åŒ…æ‹¬æ²’åœ¨è·‘çš„\ndocker rm $(docker ps -a -q) åˆªæ‰æ‰€æœ‰\ndocker stop start\nport éœ€è¦ç¶å®š host port to container port å¦å‰‡ä¸€å€‹ container è·‘åœ¨é‚£é‚Šä¹Ÿæ˜¯ unreachable\ndocker run -p6000:6379 redis\nåŸ·è¡Œé€™æŒ‡ä»¤å¯ä»¥ç¶ host port 6000\nDebug docker logs (name or id)\ndocker run \u0026ndash;name xxx å¯ä»¥æŒ‡å®šåç¨±\né€²å…¥terminal\ndocker exec -it 4839d8c690c8 /bin/bash (sh)\nit = interactive terminal\nDocker network container å€‘æœƒè·‘åœ¨ä¸€å€‹éš”é›¢çš„ network è£¡é¢\nè¦è®“ä¸åŒçš„ container æ–¹ä¾¿çš„æºé€šå°±è¦æŠŠä»–å€‘æ”¾åœ¨åŒä¸€å€‹ docker network å…§\nå¯ç”¨ docker network ls çœ‹æœ‰å“ªäº›\nDocker compose å°±æ˜¯æŠŠä¸€å † run docker çš„æŒ‡ä»¤çµæ§‹åŒ–å¯«åœ¨ä¸€å€‹æª”æ¡ˆå…§\nservice ä¸‹é¢æœƒæœ‰ä¸€å † container name (å°æ‡‰åˆ° docker run \u0026ndash;name)\nè€Œä¸”æœƒè‡ªå‹•æ¶ docker network\ndocker-compose -f docker-compose.yaml up(down) -d\nNote: docker-compose æ˜¯è®“ä¸€å † container è·‘åœ¨åŒä¸€å€‹ host çš„æ±è¥¿ï¼Œè¦ä¸€æ¬¡æ“ä½œä¸€å † host ä¸Šçš„ container éœ€è¦ç”¨ docker swarm æˆ–æ˜¯ k8s ä¹‹é¡çš„\nhttps://stackoverflow.com/questions/47536536/whats-the-difference-between-docker-compose-and-kubernetes\nDockerfile ç”¨ä¾† build docker image çš„è—åœ–ï¼Œå°±æ˜¯ä¸€å †æ•˜è¿°èªªè¦ç”¨å“ªå€‹ base imageï¼Œè¦è£ä»€éº¼å¥—ä»¶ç­‰ç­‰ç­‰çš„\n-t çµ¦åå­—å’Œ tag\ndocker build -t my-app:1.0 .\nDocker volumes Data persistency\næ›ä¸€å€‹ container æ™‚è³‡æ–™å°±æœƒä¸è¦‹ (docker-compose down up)\næŠŠ host ä¸Šçš„è³‡æ–™å’Œ container å…§çš„è³‡æ–™ç¶åœ¨ä¸€èµ·\nè³‡æ–™å°±ä¸æœƒæ‰\ndocker volume ls\nä¸»è¦æœ‰ä¸‰ç¨®\ndocker run -v host_path:container_pathï¼Œå¯«å‡ºå…©é‚Šçš„è·¯å¾‘ docker run -v container_pathï¼Œåªå¯« container pathï¼Œdocker æœƒåœ¨æŸå€‹åœ°æ–¹è‡ªå‹•å‰µä¸€å€‹è³‡æ–™å¤¾ volume (anonymous volume) docker run -v volume_name:container_path æœ€å¸¸ç”¨çš„ï¼Œnamed volumeã€‚å…ˆå‰µé€  volume å†ç›´æ¥çµ¦åå­— ","description":"æŸå€‹ docker å½±ç‰‡çš„ç­†è¨˜ï¼Œå¤§æ¦‚å°±æ˜¯ç°¡å–®ä»‹ç´¹ docker æ˜¯ä»€éº¼ï¼Œæ²’æœ‰å¤ªæ·±çš„ç†è«–","id":15,"section":"posts","tags":["docker"],"title":"Docker","uri":"https://markogoodman.github.io/posts/docker/"},{"content":"Websocket https://www.cnblogs.com/nuccch/p/10947256.html#websocket%E5%8D%8F%E8%AE%AE%E6%98%AF%E4%BB%80%E4%B9%88\næ˜¯ä¸€å€‹æ‡‰ç”¨å±¤çš„ protocol (è·Ÿ http åŒå±¤)\næœ€é‡è¦çš„åŠŸç”¨å¤§æ¦‚å°±æ˜¯é›™å‘å‚³è¼¸ï¼Œå»ºç«‹é€£ç·šå¾Œå°±æŠŠé€£ç·šé–‹è‘—ï¼Œclient å’Œ server ä¹‹é–“éƒ½å¯ä»¥äº’ç›¸å‚³è¨Šæ¯ï¼Œä¸” overhead æ¯” http å°‘\nhttp å‚³é€è¨Šæ¯æ™‚éƒ½æ˜¯ä¸€æ•´å€‹ä¸€èµ·å‚³\nwebsocket å¯ä»¥åˆ‡æˆå¾ˆå¤š frame åˆ†é–‹é€ï¼Œå»ºç«‹é€£ç·šå¾Œæ¯å€‹ frame çš„ header ä¹Ÿå¾ˆå°ã€‚é€™æ˜¯æ‡‰ç”¨å±¤çš„ frameï¼Œåˆ°é”æ‡‰ç”¨å±¤ç´šæ™‚ protocol æœƒå¹«ä½ çµ„å¥½\nç‚ºä½•ä½¿ç”¨ åŸæœ¬çš„ä¸€å€‹ http server å¿…é ˆç­‰å¾… client å‚³ req æ‰å¯ä»¥å›æ‡‰ï¼ˆåƒæ˜¯ä¸‹é¢çš„1ã€2ï¼‰\nå¦‚æœæ˜¯æƒ³è¦æŒçºŒæ›´æ–°æ•¸æ“šï¼Œé€™æ¨£æœƒé€ æˆå¾ˆå¤š overhead\nå…¶é¤˜æŒçºŒæ›´æ–°æ•¸æ“šæ–¹æ³• polling\næ¯ä¸€æ®µæ™‚é–“éƒ½ç™¼ http request å»å•ï¼Œæœ‰é»æµªè²»é »å¯¬è€Œä¸”ä¸ä¸€å®šæœƒå‘½ä¸­\nlong polling\nç™¼ä¸€å€‹ http req çµ¦ serverï¼Œserver å…ˆæŠŠé€£ç·šç•™è‘—ä¸å›æ‡‰ï¼Œç­‰åˆ°æœ‰è³‡æ–™å†å›æ‡‰ã€‚client æ”¶åˆ°å¾Œå†ç™¼ä¸€å€‹ reqã€‚é‡è¤‡ä»¥ä¸Šå‹•ä½œ\nè³‡æ–™æ›´æ–°é »ç¹æ™‚ client ä¹Ÿæ˜¯è¦ä¸€ç›´ç™¼ req æ‰è¡Œ\nserver sent event\nå–®å‘ (server-\u0026gt;client) è³‡æ–™å‚³è¼¸ï¼Œwebsocket å¤ªæ–¹ä¾¿äº†æ‰€ä»¥é€™å€‹æ¯”è¼ƒå°‘äººç”¨\nä¸éåœ¨æŸäº›ç‰¹å®šæ™‚å€™é‚„æ˜¯å¯ä»¥å‡ºå ´ï¼Œä½†æˆ‘ä¹Ÿæ²’ç”¨é\nè©³æƒ…è«‹åƒè€ƒï¼šhttps://stackoverflow.com/questions/5195452/websockets-vs-server-sent-events-eventsource\nå»ºç«‹é€£ç·š Client å…ˆç™¼ http request (http2.0 ä¸å¯å‡ç´š)\nGET /index HTTP/1.1\rHost: www.example.com\rConnection: upgrade\rUpgrade: websocket\r// other field, version ä¹‹é¡çš„ æˆåŠŸçš„è©±ï¼Œå°±æœƒæŠŠé€™å€‹é€£ç·šå‡ç´šç‚º websocket\nHTTP/1.1 101 switching protocol xxxx\rConnection: upgrade\rUpgrade: websocket\r// other field å°±è®Šæˆ websocket é€£ç·šäº†\nå’Œ http2 çš„é—œä¿‚ ç›®å‰çœ‹åˆ°æ¯”è¼ƒåˆç†çš„è§£ç­”XD\nhttps://stackoverflow.com/questions/28582935/does-http-2-make-websockets-obsolete\nwebsocket æœ€é‡è¦çš„åŠŸèƒ½ä¹‹ä¸€å°±æ˜¯é›™å‘æºé€šï¼Œå…©æ–¹éš¨æ™‚éƒ½å¯ä»¥å‚³é€è³‡è¨Šï¼Œä¸å¿…è¢« request + response ç¶ä½\nè€Œ http2 ä¹Ÿæœ‰ server pushï¼Œé€™æ¨£çš„è©± websocket æœƒè¢«å–ä»£å—ï¼Ÿï¼Ÿ\nserver push å¤§å¤šéƒ½è¢«æ‹¿ä¾†ä½¿ç”¨åœ¨ç€è¦½å™¨è®€ç¶²é çš„æ•ˆèƒ½å¢é€²ï¼Œä¾‹å¦‚ client è¦ä¸€å€‹ htmlï¼Œserver å¯ä»¥æŠŠè£¡é¢çš„åœ–ç‰‡ç­‰ç­‰è³‡æºä¸€èµ·çµ¦ï¼Œé¿å…å¤šæ¬¡ request\næ‰€ä»¥ http2 å¸¸å¸¸è¢«èªç‚ºæ˜¯ request/response + server push (å›æ‡‰æ™‚å¤šå›ä¸€äº›æ±è¥¿)ï¼Œè€Œç„¡æ³•é›™å‘å‚³è¼¸\nhttp2 å…¶å¯¦æ˜¯å¯ä»¥é”åˆ°é›™å‘å‚³è¼¸çš„(ä¾‹å¦‚ grpc å°±å¯ä»¥ï¼Œgrpc ä½¿ç”¨ http2 çš„è³‡æ–™å‚³è¼¸æ©Ÿåˆ¶å†åŠ ä¸Š protobuf)\nä½†æ˜¯ç€è¦½å™¨ä¸¦æ²’æœ‰ expose è¶³å¤ çš„ API è®“ javascript å»æ“ä½œé€™å¡Šï¼Œæ‰€ä»¥ç›®å‰ç„¡æ³•é”æˆ\nå¤§å®¶åªå¥½ç¹¼çºŒåœ¨ç€è¦½å™¨ä¸Šç”¨ websocket\n","description":"websocket æ˜¯å•¥ï½ è·Ÿ http2 æ¯”è¼ƒä¸€ä¸‹","id":16,"section":"posts","tags":["http"],"title":"What Is Websocket","uri":"https://markogoodman.github.io/posts/what-is-websocket/"},{"content":"HTTP å€‘ HTTP https://notfalse.net/39/http-message-format\nHyperText Transfer Protocol\nä¸€ç¨®æ‡‰ç”¨å±¤çš„é€šè¨Šå”å®š\nç°¡å–®ä¾†èªªå°±æ˜¯æ‡‰ç”¨ç¨‹å¼ä¹‹é–“çš„ä¸€ç¨®æºé€šè¦ç¯„ï¼Œè¦å®šå¥½å¤§å®¶è³‡æ–™æ ¼å¼é•·ä»€éº¼æ¨£å­ï¼Œäº’ç›¸è©²å¦‚ä½•ä¾†å›è¨Šæ¯ã€‚å¦‚æœå¤§å®¶éƒ½ä¾ç…§é€™ç¨®çµ±ä¸€è¦ç¯„ä¾†åšè‡ªå·±çš„æ±è¥¿ï¼Œé‚£éº¼åœ¨éŠœæ¥ä¸Šå°±æœƒå¾ˆå®¹æ˜“\nhttp é€šå¸¸ä½¿ç”¨ tcp å”å®š (http3 æ˜¯ udp)\nå»ºç«‹ tcp é€£ç·š 3 way handshake åŸºæ–¼ tcp çš„ http å€‘ï¼Œä¸€é–‹å§‹è¦éä¸‰æ¬¡çš„è¨Šæ¯äº¤æ›ä¾†å»ºç«‹é€£ç·š\nè©³ç´°è«‹åƒè€ƒ https://notfalse.net/7/three-way-handshake\næ³¨æ„é€™æ™‚å‚³é€çš„è¨Šæ¯è·Ÿæ‡‰ç”¨ç¨‹å¼å¯¦éš›æºé€šæ™‚çš„ request å’Œ response ä¸ä¸€æ¨£\nnote: ack å›æ‡‰æ™‚ä¸å–®æ˜¯seq+1ï¼Œè€Œæ˜¯ seq+(æ•´å€‹header+dataçš„é•·åº¦)\nStateless æ¯å€‹ request éƒ½ä¸æœƒé è¨­ server çŸ¥é“è‡ªå·±ä¹‹å‰åšéä»€éº¼\nRequest è¦ä¾é è‡ªå·±æä¾›å®Œæ•´çš„è³‡è¨Šï¼Œæˆ–æä¾›ç·šç´¢è®“ server çŸ¥é“å»å“ªè£¡æ‰¾åˆ°è³‡è¨Š (åœ¨ header å¸¶è‘— cookie ä¹‹é¡çš„)\nRequest, Response Request é•·ç›¸å¦‚ä¸‹ (Ref: https://documentation.help/DogeTool-HTTP-Requests-vt/http_request.htm)\nResponse\nå„ä»£ http ä¸åŒä»£çš„ http éƒ½æœ‰ä¸€äº›å•é¡Œï¼Œä¸‹é¢ç°¡å–®èˆ‰å¹¾å€‹ä¾‹å­\nHTTP/1.0 é è¨­ä¸ä½¿ç”¨ keep-alive (ç„¶å¾Œå¥½åƒå¤§å®¶çœŸçš„éƒ½æ²’ç”¨ï¼¸ï¼¤)\né€™æ¨£çš„è©±æ¯æ¬¡requestéƒ½è¦å»ºç«‹ä¸€å€‹TCPé€£ç·šï¼Œæƒ³æ³•æ˜¯ç‚ºäº†é¿å… client ä½”è‘— server å¤ªä¹…ï¼Œæ‰€ä»¥åšå®Œä¸€ä»¶äº‹æƒ…å°±é—œæ‰\nå¦‚æœé–‹ä¸€å€‹ç¶²é è¦è®€å–å¾ˆå¤šæ±è¥¿ -\u0026gt; å»ºç«‹å¾ˆå¤šé€£ç·š(3 way) -\u0026gt; è€—è²»è³‡æº\nHTTP/1.1 é è¨­æŒä¹…é€£ç·šï¼Œé‡è¤‡ä½¿ç”¨åŒä¸€å€‹TCPé€£ç·š\nè¦é¦¬ä¸Šé—œé–‰çš„è©±è¦ç‰¹åˆ¥åœ¨ header è£¡é¢çš„ Connection å¯«\næœ‰ head of line blocking çš„å•é¡Œ\nhttp1.1 æœ‰ pipeline åŠŸèƒ½å˜—è©¦è§£æ±ºé€™å€‹å•é¡Œ\nä½†ä¼¼ä¹è¦å®š server éœ€è¦ä¾ç…§æ”¶åˆ° request çš„é †åºå›çµ¦ clientï¼Œä»£è¡¨æ¯å€‹ req éƒ½è¦å¤šå¸¶ä¸€äº›è³‡è¨Šï¼Œä¸”æ‡‰ç”¨ç¨‹å¼éƒ½å¿…é ˆç‰¹åˆ¥è™•ç†é€™ä¸€éƒ¨åˆ†ï¼Œè¤‡é›œåº¦å¤ªé«˜ï¼Œä¸”å¾ˆå¤š proxy æ ¹æœ¬ä¸æ˜¯ä½ èƒ½æ§åˆ¶çš„ï¼Œæ‰€ä»¥éƒ½æ²’äººåœ¨ç”¨ã€‚\nHOLB é‚„æ˜¯å­˜åœ¨\næ¯”èµ· 1.0 é‚„å¤šäº†ä¸€äº› header etag ä¹‹é¡çš„æ±è¥¿\ncache: https://blog.techbridge.cc/2017/06/17/cache-introduction/\nå¯ä»¥å° body çš„éƒ¨åˆ†é€²è¡Œç·¨ç¢¼é †ä¾¿å£“ç¸®ï¼Œå¸¸è¦‹çš„åƒæ˜¯ gzip https://crypto.stackexchange.com/questions/40215/encoding-vs-compression-vs-encryption\nHTTP/2.0 ä¹Ÿæ˜¯åŸºæ–¼ tcpï¼Œhttp2 è¨±å¤šæ±è¥¿éƒ½èˆ‡ http1.1ç›¸å®¹ï¼Œåƒæ˜¯ methodsã€status code é‚£äº›\nç„¶å¾Œå„ªåŒ–äº†å…¶ä»–æ±è¥¿\nä¸»è¦æœ‰ä¸‹é¢å¹¾å€‹è®Šå‹•\nå¯ä»¥ server push (ä¸»å‹•ä¸Ÿæ±è¥¿çµ¦ client)ï¼Œåœ¨ä¹‹å‰çš„ http ä¸­ï¼Œéƒ½éœ€è¦ã€€client å…ˆç™¼ request å¾Œ server æ‰å¯å›æ‡‰\nheader å£“ç¸® (hpack)ï¼Œå¯ä»¥å£“ç¸®åˆ°å‰©ä¸‹å¹¾ byteï¼ŒåŸæœ¬çš„å¯èƒ½æ•¸åç”šè‡³æ•¸ç™¾\nä¸Šé¢æéçš„ holb å•é¡Œè§£æ±ºäº†(è§£æ±ºäº†æ‡‰ç”¨å±¤çš„ï¼Œä½† tcp æœ¬èº«ç¶²è·¯å±¤å°±æœ‰ holbï¼Œhttp3 æ‰æœƒè©¦è‘—ç”¨ udp ä¾†è§£æ±º)ï¼Œä¸€æ¢ tcp é€£ç·šè£¡é¢å¯ä»¥æœ‰å¤šå€‹ stream\nä¾‹å¦‚ä¸€å€‹ request æœƒæœ‰ä¸€å€‹ stream id xï¼Œrequest å¯ä»¥è¢«æ‹†æˆ frame å€‘ï¼Œåˆ°ç›®çš„åœ°å†çµ„èµ·ä¾†ï¼Œä¸åŒ request çš„ä¸€å † frame å€‘éƒ½å¯ä»¥ä¸ç…§é †åºå‚³è¼¸ã€‚\nå…¶å¯¦é•·å¾—é‚„æ»¿åƒ tcp packet çš„ XD\nBinary protocol\né€™æ¢ä¸å¾—ä¸èªªå¾å­—é¢ä¸Šçœ‹èµ·ä¾†çœŸçš„å¾ˆçœ‹ä¸æ‡‚XDD\nå¾Œä¾†æŸ¥åˆ°é€™ç¯‡ https://stackoverflow.com/questions/58498116/why-is-it-said-that-http2-is-a-binary-protocol æ‰æ¯”è¼ƒäº†è§£ä¸€é»\nå¤§æ„å°±æ˜¯ï¼ŒåŸæœ¬åŸºæ–¼æ–‡å­—çš„ httpï¼Œæ¥æ”¶çš„äººçœ‹åˆ°è³‡æ–™å°±æ˜¯ä¸€ä¸² characterï¼Œéœ€è¦ä¸€å€‹å€‹å­—å»è®€å‡ºä¾†è§£æï¼Œæ‰¾åˆ° newline character ä¹‹é¡çš„ï¼Œé€Ÿåº¦è¶…æ…¢ã€‚\nä¸”åœ¨å‚³è¼¸ä¸Šï¼Œä¸€å€‹ request æˆ–æ˜¯ response éƒ½å¿…é ˆä¸€æ¬¡å‚³é€åˆ°é”ç›®çš„åœ°ï¼Œåœ¨é€™ä¹‹å‰å…¶ä»–äººéƒ½ä¸èƒ½ç”¨é€™æ¢é€£ç·š(èˆ‡ç¬¬ä¸‰é»ç›¸é—œ)ã€‚\nè€Œ http2 çš„æ¯å€‹ frame éƒ½å¾ˆæœ‰çµæ§‹(https://tools.ietf.org/html/rfc7540#section-4.1)ï¼Œè­¬å¦‚å‰é¢ n å€‹ bit ä»£è¡¨ frame é•·åº¦ï¼Œæ¥ä¸‹ä¾† m å€‹ bit ä»£è¡¨ä»€éº¼ä»€éº¼ï¼Œå…§å®¹å¤šé•·ç­‰ç­‰çš„ï¼Œéƒ½å¯ä»¥é å…ˆçŸ¥é“ï¼Œåœ¨è§£æä¸Šå°±å¯ä»¥éå¸¸å®¹æ˜“\nhttp3.0 tcp æ¥æ”¶è³‡æ–™æ™‚æœƒç¢ºä¿è³‡æ–™å°åŒ…æ˜¯é€£çºŒçš„ï¼Œæ‰æœƒä¾ç…§é †åºæŠŠè³‡æ–™æ‹¿çµ¦æ‡‰ç”¨ç¨‹å¼\nè­¬å¦‚æœ‰ 1 2 3 4 5å€‹å°åŒ…\nå¦‚æœå‚³é€ä¸­ 1 3 æ­£ç¢ºåˆ°é”ä½† 2 æ‰äº†ï¼Œtcp å°±åªèƒ½ç­‰åˆ° 2 åˆ°é”å¾Œæ‰æŠŠ 3 ä¹Ÿä¸€èµ·æ‹¿ä¾†ç”¨(å³ä½¿ 1 3 é€™å…©å€‹å°åŒ…åœ¨æ‡‰ç”¨å±¤ä¸Šéƒ½å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œä½† tcp ä¸¦ä¸ç­è§£æ‡‰ç”¨å±¤çš„äº‹æƒ…)\nä¸”åœ¨æ­¤åŒæ™‚ sliding window ä¹Ÿå¯èƒ½è¢«å¡ä½ï¼Œå‚³é€ç«¯æˆ–ç·šè·¯ä¸Šå³ä½¿ç©ºé–’ä¹Ÿä¸æœƒç¹¼çºŒå‚³é€å¾Œé¢çš„å°åŒ…ï¼Œé€ æˆ holb çš„å•é¡Œ\nhttp3 å°±ç”¨ udp + QUIC ä¾†è§£æ±ºé€™å€‹å•é¡Œ\nQUIC ä¹Ÿæ˜¯ä¸€ç¨®å‚³è¼¸å±¤çš„å”è­°ï¼Œæä¾›å¯é å‚³è¼¸\nè‡³æ–¼ç´°ç¯€é‚„æ²’ç ”ç©¶ XD\nç¾åœ¨é‚„æ²’æœ‰è¢«å¾ˆå»£æ³›çš„ä½¿ç”¨\nä¸‹ä¸€ç¯‡å¯èƒ½æœƒæ‹¿ websocket å’Œ http2 æ¯”è¼ƒçœ‹çœ‹ï¼Œå› ç‚ºç¾åœ¨å…¶å¯¦å¾ˆå¤šç€è¦½å™¨éƒ½æ”¯æ´ http2 äº†ï¼Œhttp2 åˆæœ‰ server push çš„åŠŸèƒ½ï¼Œæ„Ÿè¦ºå’Œ websocket é‚„æ»¿åƒçš„ ?? GRPC???\n","description":"HTTPï½","id":17,"section":"posts","tags":["http"],"title":"What Is Http","uri":"https://markogoodman.github.io/posts/what-is-http/"},{"content":"é€™ç« ç¯€æ˜¯æ¦‚ç•¥ä»‹ç´¹ä¸€ä¸‹ Go çš„ scheduler å¦‚ä½•é‹ä½œçš„ï½\næœ‰äº›äº‹ä¹‹å‰æœ‰çœ‹é\nä¸é tasks å’Œ continuation çœŸçš„æ˜¯ç¬¬ä¸€æ¬¡è½åˆ°ï¼Œæ»¿æœ‰è¶£çš„æ¦‚å¿µ\nWork Stealing Fair schedulingï¼Œç›´æ¥æŠŠä¸€å †ä»»å‹™å¹³å‡åˆ†æ•£åˆ°å„å€‹ processor ä¸Š\nä½†å› ç‚º Go æ˜¯ä½¿ç”¨ fork-joinï¼Œä¸€å€‹ goroutine æ˜¯å¾ä¸€å€‹ goroutine åˆ†å‡ºå»çš„ï¼Œå¸¸å¸¸æœƒäº’ç›¸ä¾è³´(é †åºå•é¡Œ)ï¼Œå¯èƒ½é€ æˆå„å€‹ processor ä½¿ç”¨ä¸å‡ï¼ˆæ¯å€‹task loadingä¸åŒï¼‰ã€‚ä¸” cache ä¹Ÿå¯èƒ½æœ‰æ•ˆç‡å·®çš„å•é¡Œï¼Œå¦‚æœç›¸é—œ task åˆ†æ•£å„å€‹ processorã€‚\nA centralized task queue? å¦‚æœå¼•é€²â€œä¸€å€‹â€ task queue å‘¢ï¼Ÿ\nè² è²¬è£æ‰€æœ‰ä»»å‹™ï¼Œæœ‰ç©ºçš„ processor å°±å»æ‹¿ä»»å‹™ä¾†åš\næ˜¯å¯ä»¥è§£æ±ºä¸€äº› loading åˆ†é…ä¸å‡çš„å•é¡Œï¼Œä½†å¤§å®¶éƒ½è¦å»å­˜å–é€™å€‹å”¯ä¸€ task queueï¼Œé€²å‡º critical section å¾ˆè€—è²»æ™‚é–“ã€‚ä¸” cache å•é¡Œä¹Ÿæ²’è§£æ±ºï¼Œä¸çŸ¥é“å“ªå€‹ task æœƒå»å“ªå€‹ processor ä¸Š\nMultiple queue? å†é€²ä¸€æ­¥ï¼Œçµ¦æ¯å€‹ processor éƒ½çµ¦ä¸€å€‹ local queue å‘¢ï¼Ÿ\nè§£æ±ºçš„ critical section çš„å•é¡Œäº†\nä½†å¦‚æœ fork å‡ºä¾†çš„ goroutine éƒ½åœ¨åŒä¸€å€‹ P ä¸Šï¼Œè¦æ€éº¼æ¬å»å…¶ä»– Pï¼Œé‚„æœ‰ context switch æ€éº¼åšï¼Ÿï¼Ÿ\nWork stealing fork æ™‚ï¼ŒåŠ å…¥è©² thread çš„ queue çš„å°¾ç«¯ thread æ²’äº‹æ™‚ï¼Œå»åˆ¥äººçš„ queue é ­ç«¯å·å·¥ä½œ ç•¶ join point åˆ°é”ï¼Œè¦ç­‰å¾…å…¶ä»–äººå›æ‡‰çµæœæ‰èƒ½ç¹¼çºŒæ™‚ï¼Œé€™å€‹ thread æœƒå…ˆæš«åœé€™å€‹å·¥ä½œï¼Œä¸¦å¾è‡ªå·±çš„ queue çš„å°¾ç«¯æ‹¿å·¥ä½œå‡ºä¾†åš thread çš„ queue æ˜¯ç©ºçš„æ™‚å€™ï¼Œå¯èƒ½æœƒåœåœ¨ join point æˆ–æ˜¯å»åˆ¥äººçš„é ­ç«¯å·å·¥ä½œä¾†åš å¯ä»¥æ³¨æ„çš„æ˜¯ 1 å’Œ 3ï¼Œéƒ½æ˜¯å¾å°¾ç«¯æ“ä½œ\nå› ç‚ºå°¾ç«¯çš„ä»»å‹™æ˜¯æœ€å¾Œ push é€²å»çš„ï¼Œæœ€æœ‰å¯èƒ½æ˜¯ parent è¦ join æ‰€éœ€è¦çš„çµæœï¼Œå¿«é» join æ•ˆèƒ½å¥½\nå› ç‚ºæ˜¯é”åˆ° join point å‰æœ€å¾Œè™•ç†çš„æ±è¥¿ï¼ˆå°¾ç«¯å·¥ä½œï¼‰ï¼Œæ‰€ä»¥æœ€æœ‰å¯èƒ½é‚„åœ¨ cache ä¸­\nStealing Tasks or Continuations? å‡è¨­ç›®å‰æ­£åœ¨åŸ·è¡Œçš„ goroutine å«åš Aï¼Œè€Œ A å•Ÿå‹•äº†ä¸€å€‹ goroutine Bï¼Œé‚£æ­¤æ™‚ç›®å‰çš„ thread æœƒé¸æ“‡ A å‰©ä¸‹çš„å…§å®¹(continuation)æˆ–æ˜¯ B (task) ç¹¼çºŒåšå‘¢ï¼Ÿ\nç­”æ¡ˆæ˜¯é€šå¸¸æœƒæŠŠ task æ‹¿ä¾†åšï¼Œè€ŒæŠŠ A æ¨é€² local queue çš„å°¾ç«¯\nåŸå› æ˜¯\né€šå¸¸ç¨‹å¼éƒ½æ˜¯å¸Œæœ›ä¸­é–“ fork å‡ºå»çš„ goroutine åšå®Œä¸€äº›äº‹æƒ…ï¼Œç„¶å¾Œ join å›ä¾†åŸæœ¬çš„ goroutine åŸæœ¬çš„ gorutine fork å‡ºåˆ¥çš„ gorutine å¾Œéä¸ä¹…é€šå¸¸æœƒå¡ä½ç­‰ join å¦‚æœ thread ç¹¼çºŒåšAï¼Œé‚£é€šå¸¸å°±æœƒæ˜¯ (A åšåˆ° join point) -\u0026gt; (B åšå®Œ) -\u0026gt; (ç¹¼çºŒA)\nå¦‚æœæ˜¯åš Bï¼Œé‚£é€šå¸¸æœƒæ˜¯ (B åšå®Œ) -\u0026gt; (ç¹¼çºŒA)\nå°‘äº†ä¸€å€‹ context switch\næ³¨æ„ fork æ™‚é¸æ“‡ A æˆ– B éƒ½ä¸ç®— context switchï¼Œåªæ˜¯é¸æ“‡å…¶ä¸­ä¹‹ä¸€ä¸Ÿé€² queue è€Œå·²\ncontinuation-stealing æŒ‡çš„å°±æ˜¯åœ¨ fork æ™‚ï¼Œæ˜¯æŠŠåŸæœ¬çš„ goroutine å‰©ä¸‹éƒ¨åˆ†éƒ½é€² queue å…§ï¼Œé€™ç¨®æ–¹æ³•è¢«èªç‚ºæ˜¯æ¯”è¼ƒå¥½çš„ï¼Œè›‹éœ€è¦ç‰¹åˆ¥çš„ compiler æ”¯æ´ï¼Œè€Œ Go æœ‰\nGMP model G ä»£è¡¨ goroutine çš„ç‹€æ…‹ï¼Œå°¤å…¶æ˜¯ program counter\næ¥ä¸‹ä¾†çš„ä¸€å°æ®µå…¶å¯¦å°±æ˜¯åœ¨èªª shceduler æ€éº¼é‹ä½œï¼Œè·Ÿä¹‹å‰å¯«éçš„ä¸€ç¯‡æ–‡ç« é¡ä¼¼\nM(thread) è‡³å°‘æœƒæœ‰è·Ÿ P ä¸€æ¨£çš„æ•¸é‡ï¼Œç•¶æŸå€‹ thread è¢« G å¡ä½(è®€IOä¹‹é¡çš„)ï¼Œé€™å€‹ M å°±æœƒè·Ÿ P åˆ‡é–‹ï¼Œè‡ªå·±å»æ—é‚Šç­‰ï¼Œè®“ P å¯ä»¥å»è·Ÿåˆ¥çš„ M çµåˆï¼Œç¹¼çºŒä½¿ç”¨ CPU\nGlobal run queue å‰‡æ˜¯ç‚ºäº†ä»–å€‘çš„å¯¦ä½œç´°ç¯€å„ªåŒ–ï¼Œæˆ‘å°±ä¸çŸ¥é“è©³ç´°äº†ï¼¸ï¼¤\næœ€å¾Œä»–å¯«äº†ç›®å‰å¦‚æœä¸€å€‹ goroutine æ²’æœ‰æ–·é»(function callã€ioé‚£äº›)çš„è©±æ˜¯ç„¡æ³•è¢«æ¶å¥ªçš„ï¼Œæœƒé€ æˆå•é¡Œ\né€™å€‹å¯¦éš›ä¸Šæˆ‘åœ¨å·¥ä½œæ™‚å°±é‡éï¼¸ï¼¤\næœ‰ä¸€å€‹ goroutine è£¡é¢è·‘äº†ç„¡çª®è¿´åœˆï¼Œå¥½åƒå°è‡´åƒåœ¾å›æ”¶æŠŠå…¶ä»–äººéƒ½åœæ­¢ä¹‹å¾Œä¸€ç›´åœ¨ç­‰é€™å€‹ g ç­‰ä¸å®Œå°±çˆ†äº†\nlocal æ¸¬è©¦æ™‚æ¸¬ä¸å‡ºä¾†ï¼Œå¾Œä¾†ç™¼ç¾åŸä¾†æ˜¯æ–°ç‰ˆçš„ Go å·²ç¶“æŠŠå•é¡Œè§£æ‰ï¼Œå¥½åƒæ˜¯1.14(?\nçˆ†æ‰çš„é‚£å°æ©Ÿå™¨å¥½åƒæ˜¯ç”¨æ¯”è¼ƒèˆŠçš„æŸç‰ˆæ‰æœƒç™¼ç”Ÿï¼ŒçœŸ4ç¥å¥‡\n","description":"Concurrency in Go ç¬¬å…­ç« ï½ Goroutines and the Go runtime ","id":18,"section":"posts","tags":["Go","Goroutine","concurrency"],"title":"Concurrency in Go IV ç¬¬å…­ç«  Goroutines and the Go runtime","uri":"https://markogoodman.github.io/posts/concurrency-in-go-iv/"},{"content":"ç­†è¨˜éƒ½æ²’å•¥æ•´ç†ï¼²\nError Propagation // å¥½åƒè·Ÿ concurrency æ¯”è¼ƒç„¡é—œ(?\nå¯« concurrent code çš„æ™‚å€™ï¼Œdebug æœƒæ¯”å¹³å¸¸é›£å¾ˆå¤šï¼Œå¦‚æœäº’ç›¸å‚³éè³‡è¨Šæ™‚éƒ½é™„ä¸Š error æœƒæ¯”è¼ƒå¥½\nErroréœ€è¦åŒ…å«ä¸€äº›æ±è¥¿:\nç™¼ç”Ÿçš„äº‹æƒ…\nä¾‹å¦‚ç¡¬ç¢Ÿæ»¿äº†ã€ç¶²è·¯æ–·ç·šç­‰ç­‰ã€‚åœ¨å‚³éé€”ä¸­æˆ‘å€‘ä¹Ÿå¯ä»¥è‡ªå·±åŒ…äº›è³‡è¨Š\næ™‚é–“èˆ‡åœ°é»\nè¦è¨˜éŒ„ç™¼ç”Ÿçš„æ™‚é–“\nè¦åŒ…å«å®Œæ•´çš„ stack trace\né‚„æœ‰ä¸Šä¸‹æ–‡(é€™å€‹ä¸å¤ªæœ‰æƒ³åƒ)ï¼Œä¾‹å¦‚åˆ†æ•£å¼ç³»çµ±ï¼Œè¦çŸ¥é“æ˜¯å“ªå€‹æ©Ÿå™¨å‡ºéŒ¯\né¡¯ç¤ºç”¨è¨Šæ¯\nçµ¦ä½¿ç”¨è€…çœ‹çš„ï¼Œä¸åŒ…å« stack trace é€™é¡å¤ªè©³ç´°çš„è³‡è¨Š\né¡ä¼¼å‰é¢å…©é»çš„ç²¾ç°¡ç‰ˆ\nerror id\nè®“çœ‹åˆ°é¡¯ç¤ºç”¨è¨Šæ¯çš„ä½¿ç”¨è€…å¯ä»¥æ‰¾åˆ°è©³ç´°è³‡è¨Š\né€™äº›è³‡è¨Šå¤§å¤šéƒ½è¦æˆ‘å€‘è‡ªå·±åŒ…ï¼Œä¸€èˆ¬çš„ error ç„¡\n1 2 3 4 5 6 7 8 9 10 11 12 func High(param string) error { result, err := Low.Do() if err != nil { // æª¢æŸ¥è³‡è¨Šæ˜¯å¦æœ‰åŒ…å®Œæ•´ï¼ŒåŸºæœ¬ä¸Šéƒ½è¦åŒ…ï¼Œé€ƒéæª¢æŸ¥çš„å°±æ˜¯æ²’åŒ…å¥½ if _, ok := err.(Low.Error); ok { err = WrapErr(err, \u0026#34;cannot do High id:%v\u0026#34;, param) // æœƒä¸æœƒä½¿ç”¨ defer åŒ…æ¯”è¼ƒå¥½å•Š? å°±ä¸ç”¨åœ¨æ¯å€‹ func call éƒ½åŒ…ä¸€æ¬¡ï¼Œdup code } return err } // ... } é€šå¸¸åªåœ¨ module boundaries(åƒæ˜¯public function/method) WrapErr\nåœ¨æœ€ä¸Šå±¤æ™‚ï¼Œå¦‚æœç™¼ç¾ä¸æ˜¯è‡ªè£½çš„ errorï¼Œå°±è¼¸å‡º default è¨Šæ¯ï¼Œå¦‚æœæ˜¯çš„è©±å°±ç›´æ¥è¼¸å‡º err.Message å³å¯ã€‚ä½†å…©å€‹éƒ½è¦è¨˜å¾—è¼¸å‡º error id\nä»¥ä¸‹æ˜¯èª²æœ¬ä¸Š p. 151 èˆ‰çš„ä¾‹å­\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 type MyError struct { Inner error Message string StackTrace string Misc map[string]interface{} } func wrapError(err error, messagef string, msgArgs ...interface{}) MyError { return MyError{ Inner: err, // å®Œæ•´çš„åº•å±¤è³‡è¨Š Message: fmt.Sprintf(messagef, msgArgs...), // é¡¯ç¤ºç”¨ï¼ŒæœƒæŠŠä¸‹å±¤çš„ err.Message è—èµ·ä¾† StackTrace: string(debug.Stack()), Misc: make(map[string]interface{}), // é›œäº‚è³‡è¨Šæ”¾é€™ } } Timeouts and Cancellation ç‚ºä½•æƒ³è¦ timeoutï¼Ÿ\nå¾ˆé‚Šç·£çš„ req å¯èƒ½æœƒæƒ³è¦è®“ä»– timeout è€Œä¸æ˜¯è®“ä»–ç­‰è¶…ä¹…\nä½•æ™‚é©åˆ timeoutï¼Ÿ\ntoå¾Œä¸æœƒä¸€ç›´é‡è¤‡ä¾†ï¼ˆé€ æˆnegative feedback loopï¼‰ æ²’æœ‰è³‡æºå»å„²å­˜æ­¤ reqï¼Œåƒæ˜¯ queue æ»¿äº†ä¹‹é¡ req æœƒéæ™‚ï¼Œç­‰å¾ˆä¹…æ›åˆ°å®ƒæ™‚å€™ï¼Œå·²ç¶“è™•ç†ä¹Ÿæ²’æ„ç¾© é é˜² deadlockï¼Œæ­»çµä¹Ÿæ™‚å¸¸æœƒç™¼ç”Ÿåœ¨ç¨‹å¼åŸ·è¡Œä¸€æ®µæ™‚é–“å¾Œï¼Œæ¸¬è©¦æ™‚ä¸ä¸€å®šæŠ“å¾—åˆ°ã€‚æ­»çµæ™‚é€šå¸¸åªèƒ½é‡å•Ÿæ©Ÿå™¨ï¼Œæ›æˆ timeout é›–ç„¶æœ‰å¯èƒ½ä¹Ÿæ˜¯æ´»çµï¼Œä½†è‡³å°‘ç™¼ç¾å¾Œå¯ä¿®ï¼Œä¸æ˜¯ç›´æ¥çˆ†ç‚¸ ä½•æ™‚æƒ³å–æ¶ˆï¼Ÿ\nä¸Šé¢é‚£äº›æƒ…æ³ ä½¿ç”¨è€…æƒ³å–æ¶ˆ parent å¦‚æœåœæ­¢äº†ï¼Œè©² concurrent op ä¹Ÿè¦å–æ¶ˆ Replicated requestsï¼ŒæŸäº›æƒ…æ³ä¸‹(p. 159)ç‚ºäº†æ•ˆèƒ½ï¼Œå¯èƒ½æœƒæ”¶åˆ°å…©å€‹ä¸€æ¨£çš„ reqï¼Œä¸€å€‹å®Œæˆå¾Œï¼Œå…¶ä»–å–æ¶ˆ ç°¡å–®ç¯„ä¾‹\nG -\u0026gt; A -\u0026gt; B\nç•¶ A æ²’æ•ˆç‡æ™‚å¯èƒ½æœƒé–‹å•Ÿ A2\nå¦‚æ­¤ B å¯èƒ½æ”¶åˆ°é‡è¤‡çš„\nä¸€å€‹ op å–æ¶ˆæ™‚ï¼Œå…¶é¤˜çš„ç›¸é—œ op è©²æ€éº¼è¾¦ï¼ˆæ­£åœ¨åŸ·è¡Œçš„æ±è¥¿æˆ–å…¶ä»–å­opç­‰ç­‰ç­‰ï¼‰\nä¸€å€‹å¯èƒ½æœƒè¢«å–æ¶ˆçš„ op åº•ä¸‹æœƒå‘¼å«åˆ°çš„å­ op éƒ½å¿…é ˆæª¢æŸ¥ï¼Œé€™äº› op å¦‚æœåŸ·è¡Œæ™‚é–“è¶…å‡ºå–æ¶ˆå¾Œå¯ä»¥ç­‰å¾…çš„ç¯„åœï¼Œé‚£å°±å¿…é ˆæŠŠé€™äº› op åšæˆ preemptable\nç°¡å–®è™•ç† Replicated requests æ–¹å¼å°±æ˜¯ç•¶å­ goroutine å›å ±çµæœå¾Œï¼Œè¦æŠŠå¾€å¦ä¸€å€‹é‡è¤‡çš„ req é€å–æ¶ˆæŒ‡ä»¤ï¼ˆä½†é€™å°±éœ€è¦é›™å‘æºé€šï¼‰\næˆ–æ˜¯ä¸è™•ç†ï¼Œæˆ–è¦æ±‚ parent permission(Aè¦é€çµ¦Bæ™‚å•GåŒæ„)\ntimeoutå’Œå–æ¶ˆæ˜¯ç¨‹å¼å®Œæˆå¾Œå¾ˆé›£åŠ å…¥çš„ï¼Œè¦ä¸€é–‹å§‹å°±è€ƒæ…®\nHeartbeat è®“åˆ¥äººçŸ¥é“ä½ æ´»è‘—ï¼Œæ¯”è¼ƒå¸¸è¦‹çš„æ˜¯ä¸€å€‹ server é–‹ä¸€å€‹ endpoint è®“åˆ¥äººçŸ¥é“ server æ›äº†æ²’\né€™é‚Šçš„ heartbeat æ˜¯ä¸€å€‹ goroutine è¦å›å‚³ä¸€å€‹ heartbeat chanï¼Œå®šæ™‚å‚³æ±è¥¿å‡ºå»è¡¨ç¤ºè‡ªå·±æ²’æ›\nç›´æ¥æŠŠ p. 162 çš„ä¾‹å­æ‘³é€¼ä¸Šä¾†\ndoWork := func(\rdone \u0026lt;-chan interface{},\rpulseInterval time.Duration,\r) (\u0026lt;-chan interface{}, \u0026lt;-chan time.Time) {\rheartbeat := make(chan interface{})\rresults := make(chan time.Time)\rgo func() {\rdefer close(heartbeat)\rdefer close(results)\rpulse := time.Tick(pulseInterval)\rworkGen := time.Tick(2 * pulseInterval)\rsendPulse := func() {\rselect {\rcase heartbeat \u0026lt;- struct{}{}:\rdefault:\r}\r}\rsendResult := func(r time.Time) {\rfor {\rselect {\rcase \u0026lt;-done:\rreturn\rcase \u0026lt;-pulse:\rsendPulse()\rcase results \u0026lt;- r:\rreturn\r}\r}\r}\rfor {\rselect {\rcase \u0026lt;-done:\rreturn\rcase \u0026lt;-pulse:\rsendPulse()\rcase r := \u0026lt;-workGen:\rsendResult(r)\r}\r}\r}()\rreturn heartbeat, results\r} è¦æ³¨æ„çš„æ˜¯å‚³æ±è¥¿å» chan éƒ½å¯èƒ½æœƒè¢«å¡ä½åŒ…æ‹¬ heartbeatï¼Œæ‰€ä»¥éƒ½ä½¿ç”¨ select é é˜²ï¼Œä¸”é€ result ä¸­é–“å¯èƒ½æœ‰å¤šå€‹å¿ƒè·³ï¼Œæ‰€ä»¥è¦ç”¨ for åŒ…ä½ (å¸¸å¸¸å¿˜è¨˜)\nä½¿ç”¨ä¸Šå¯ä»¥åœ¨ for è£¡é¢åŒ… select heartbeat, result, time.After(timeout) é€™å¹¾å€‹ caseï¼Œå¦‚æœå¤ªä¹…æ²’è½åˆ° heartbeat æˆ– result å°±æ›æ‰\nReplicated Requests å°±æ˜¯åŒæ™‚æœƒæœ‰å¤šå€‹è™•ç† request çš„å–®å…ƒï¼ˆæ©Ÿå™¨ã€processã€goroutine éƒ½æœ‰å¯èƒ½ï¼‰ï¼Œä¸Ÿä¸€æ¨£çš„ req çµ¦ä»–å€‘ï¼Œæ‹¿æœ€å¿«çš„å›æ‡‰ä¾†ä½¿ç”¨\nRate limiting https://www.alexedwards.net/blog/how-to-rate-limit-http-requests\né é˜² rate å¤ªé«˜é€ æˆç³»çµ±å£æ‰ã€‚\nå¯èƒ½æ˜¯æ”»æ“Šï¼Œæˆ–æ˜¯ç³»çµ±è¨­è¨ˆä¸Šæœ¬ä¾†å°±æ²’è€ƒæ…®åˆ°é«˜ rate çš„æƒ…æ³\næˆ–æ˜¯ä¹‹å‰èªªçš„ negative feedback loop ç­‰ç­‰ç­‰\nç”šè‡³å°ä¸åŒä½¿ç”¨è€…ï¼ˆä¾‹å¦‚æœ‰ç„¡ä»˜è²»ï¼‰è¨­å®šä¸åŒçš„é™åˆ¶\nå¯ä»¥å…ˆå°‡ç³»çµ±èƒ½æ¥å—çš„ request æ•¸é‡é™åˆ¶åœ¨è‡ªå·±å·²çŸ¥å¯æŒæ§çš„ç¯„åœå…§\nä¸åªæœå‹™æä¾›æ–¹å¯ä»¥è¨­ç½® rate limitï¼Œå¦‚æœå®¢æˆ¶ä½¿ç”¨éœ€è¦ä»˜è²»çš„æœå‹™ï¼Œé‚£å¹«è‡ªå·±è¨­ rate limit ä¹Ÿåˆç†\nå¸¸ç”¨çš„æ–¹æ³•å«åš token bucketï¼Œè¦ä½¿ç”¨è³‡æºå°±å¿…é ˆæŒæœ‰ tokenï¼Œè¦å»æ¡¶å­è£¡æ‹¿ã€‚æ¡¶å­è£¡æœ€å¤šå¯ä»¥æœ‰ d å€‹ tokenï¼Œæ¯ç§’æœƒè£œå…… r å€‹ token å›å»æ¡¶å­ã€‚\ngolang.org/x/time/rate package å¯¦ä½œäº† token bucket\nfunc NewLimiter(r Limit, b int) *Limiter // é‚„æœ‰ä¸€äº› function å¯ä»¥å¹«å¿™ç”¢ç”Ÿrï¼Œåƒæ˜¯ Every(duration) å¯ä»¥è‡ªå‹•è½‰æˆ r\rfunc (lim *Limiter) Wait(ctx context.Context) (err error)// ç­‰æ–¼ lim.WaitN(ctx, 1)ï¼Œ\rfunc (lim *Limiter) WaitN(ctx context.Context, n int) // block ç›´åˆ°æ“æœ‰ n å€‹ tokenï¼Œæœƒå»æª¢æŸ¥ ctx çš„æ­»ç·šå’Œæ˜¯å¦å–æ¶ˆäº†\rä½¿ç”¨ç¯„ä¾‹\rlim := rate.NewLimiter(rate.Limit(1), 1)\rfunc XXX(ctx context.Context) error {\rif err != lim.Wait(ctx); err != nil{\rreturn err }\r} ä¹Ÿå¯ä»¥æŠŠä¸€å † limiter åŒ…èµ·ä¾†ï¼Œç”¨ä¾†åšä¸€å€‹æœ‰å„ç¨®ä¸åŒé™åˆ¶çš„ limiterï¼Œä¾‹å¦‚æŠŠ disk limiterã€network limiterã€ second limiter(æ¯ç§’é™åˆ¶)ã€minute limiter(æ¯åˆ†é˜é™åˆ¶)\nåœ¨ç”¨ for è¿´åœˆå»è·‘éœ€è¦å•Ÿå‹•çš„ limiter\nç¯„ä¾‹ï¼Œæ›¸ä¸Šé‚„æœ‰ä¸€äº›å„ªåŒ–ï¼Œä¸éå¤§è‡´æ¦‚å¿µæ˜¯é€™æ¨£\n// è®“ MultiLimiter æ¥æ”¶ interfaceï¼Œå¦‚æ­¤ä¸€ä¾†ä¸æ­¢å¯ä»¥æ¥æ”¶åŸç”Ÿ Go limiterï¼Œä¹Ÿå¯ä»¥æ¥æ”¶ multiLimiterï¼ŒåŒ…å¥½å¹¾å±¤\rtype RateLimiter interface{\rWait(context.Context) error\r}\rtype multiLimiter struct { limiters []RateLimiter\r}\rfunc MultiLimiter(limiters ...RateLimiter) *multiLimiter{\rreturn \u0026amp;multiLimiter{limiters: limiters}\r}\rfunc (lim *multiLimiter) Wait(ctx context.Context) error{\rfor _, l := range lim.limiters {\rif err := l.Wait(ctx); err != nil{\rreturn err\r}\r}\rreturn nil\r}\rä½¿ç”¨ä¸Šå¯ä»¥åœ¨ä¸åŒçš„ func è£¡é¢å»æˆ³è‡ªå·±æƒ³è¦ç”¨çš„ limiter\rtype XXX struct {\rALimiter, BLimiter, CLimiter, }\rfunc (x *XXX) DoSomething (ctx context.Context) error {\rerr := MultiLimiter(x.ALimiter, x.BLimiter).Wait(ctx)\r.....\r} è©³ç´°è«‹åƒè€ƒ p.183\nè£œä¸€äº›æ›¸ä¸Šæ²’æœ‰çš„ç”¨æ³•\nfunc (lim *Limiter) Allow() bool // ç­‰æ–¼ AllowN(time.Now(), 1)\rfunc (lim *Limiter) AllowN(now time.Time, n int) bool // å›å‚³ now çš„æ™‚å€™æ¡¶å­è£¡é¢æœ‰æ²’æœ‰ n å€‹ tokenï¼Œå¦‚æœæœ‰æœƒå›å‚³ true ä¸¦æ¶ˆè€—æ‰\rfunc (lim *Limiter) Reserve() *Reservation // ReserveN(time.Now(), 1)\rfunc (lim *Limiter) ReserveN(now time.Time, n int) *Reservation é ç´„ n å€‹ tokenï¼Œæœƒå…ˆæŠŠ limiter è£¡é¢çš„ token å…ˆå¡ä½\rr.OK() // æœ‰æ²’æœ‰å¯èƒ½ç­‰åˆ° n å€‹token\rr.Delay() // å¤šä¹…æ‰å¯ä»¥å¾—åˆ° n å€‹ r.Cancel() // å–æ¶ˆé ç´„\r// package è¨»è§£çš„ç”¨æ³•\r// r := lim.ReserveN(time.Now(), 1)\r// if !r.OK() {\r// // Not allowed to act! Did you remember to set lim.burst to be \u0026gt; 0 ?\r// return\r// }\r// time.Sleep(r.Delay())\r// Act()\rfunc (lim *Limiter) SetLimit(newLimit Limit)\rfunc (lim *Limiter) SetBurst(newBurst int) Healing Unhealthy Goroutines æœƒæ´»å¾ˆä¹…çš„ process ä¸­é€šå¸¸ä¹Ÿæœƒæœ‰ä¸€äº›ä¸€ç›´éƒ½æ´»è‘—çš„ goroutineï¼Œç­‰å¾…è³‡æ–™ä¾†ï¼Œè™•ç†ï¼Œå›æ‡‰ã€‚ç¸½ä¹‹ä»–å€‘å¾ˆæœ‰å¯èƒ½æœƒæ›æ‰ï¼ˆï¼Ÿ éœ€è¦ä¸€äº›æ–¹æ³•ä¾†å¾©æ´»ä»–å€‘\né€™ç« ç¯€çš„ code ä¹Ÿå¤ªé•·äº†ã„…\nåŸºæœ¬ä¸Šå°±æ˜¯è¦è·‘èµ·å¦ä¸€å€‹ goroutine å»åµæ¸¬ç›®æ¨™çš„ heartbeatï¼Œç•¶ä¸æ­£å¸¸æ™‚ï¼Œå°±å‚³ done çµ¦ç›®æ¨™ï¼Œç„¶å¾Œé‡å•Ÿä¸€å€‹\nSummary é€™ç« ä¸»è¦æ˜¯åœ¨èªªè¦æ€éº¼è®“ç³»çµ±ç©©å®šé»\næ»¿å¤šä¸»é¡Œçš„è§€å¿µä¹Ÿä¸åªé™å®šåœ¨ Go çš„ concurrency ä¸Š\n","description":"Concurrency in Go ç¬¬äº”ç« ï½ Concurrency at Scale ","id":19,"section":"posts","tags":["Go","Goroutine","concurrency"],"title":"Concurrency in Go III  ç¬¬äº”ç«  Concurrency at Scale","uri":"https://markogoodman.github.io/posts/concurrency-in-go-iii/"},{"content":"Concurrency in go. ç¬¬å››ç«  Concurrency Patterns in Go é€™ç« ç¯€å°±æ˜¯è¬›ä¸€äº›å¸¸è¦‹çš„ Go concurrency patternï¼Œæœ‰å“ªäº›æ–¹ä¾¿ä½¿ç”¨ä»¥åŠå¦‚ä½•å®‰å…¨çš„ä½¿ç”¨é€™äº› pattern\nconfinement è¦åšåˆ° concurrent safe é™¤äº†ä¹‹å‰èªªçš„ channel èˆ‡ primitives é‚„æœ‰äº›æ–¹æ³•\nåƒæ˜¯ Immutable data æ˜¯ concurrent safe çš„ï¼Œå¤§å®¶å¯ç”¨ä½†æ˜¯ä¸èƒ½æ”¹ï¼Œè¦ä¸åŒçš„å€¼å°±è‡ªå·± create (åƒæ˜¯ string)\nè€Œ confinement æœ‰å…©ç¨® adhoc èˆ‡ lexical\nadhoc æ˜¯é¡ä¼¼å¤§å®¶ç´„å®šå¥½çš„å¯«ç¨‹å¼è¦ç¯„ï¼Œä¾‹å¦‚ç´„å®šå¥½åªåœ¨æŸéƒ¨åˆ†çš„ function å­˜å–é€™å€‹å…±åŒè®Šæ•¸ï¼ˆå³ä½¿åœ¨å…¶ä»–éƒ¨åˆ†ä¹Ÿå¯ä»¥å­˜å–é€™å€‹è®Šæ•¸ï¼‰ï¼Œä»¥é€™ç¨®æ–¹æ³•ä¾†é”åˆ° concurrent safe\nè€Œé–‹ç™¼è€…è®Šå¤šä»¥å¾Œï¼Œä¸ä¸€å®šå¤§å®¶éƒ½æœƒçŸ¥é“ä¸”éµå®ˆé€™è¦ç¯„ï¼Œå¯èƒ½é€ æˆç¨‹å¼å‡ºéŒ¯\nè€Œ lexical confinement æ˜¯åˆ©ç”¨ compiler åŠèªè¨€ç‰¹æ€§ç›´æ¥é™åˆ¶é€™ç¨®éŒ¯èª¤çš„ç™¼ç”Ÿï¼Œå°±å¦‚åŒåªæœ‰ channel owner å¯ä»¥å‚³è³‡æ–™ï¼Œconsumer åªæœƒæ”¶åˆ°ä¸€å€‹ read only çš„ channel é€™ç¨®æ–¹æ³•\næˆ–è‘—æ˜¯å¦‚ä¸‹é¢çš„ code\ndata := []byte(\u0026#34;dataaatata\u0026#34;)\rgo processData(\u0026amp;wg, data[:i])\rgo processData(\u0026amp;wg, data[i:]) æŠŠdataåˆ‡é–‹ï¼Œç›´æ¥è®“å…©å€‹ goroutine ä¸æœƒäº’ç›¸å½±éŸ¿\nä¹Ÿå¯ä»¥ç›¡é‡æ¸›å°‘ goroutine ä¹‹é–“çš„æºé€šï¼Œå¤§å¤šæ•¸è¦äº’ç›¸æºé€šçš„ç¨‹å¼å¯«èµ·ä¾†æœƒæ¯”è¼ƒè¤‡é›œä¸€é»\nå¸¸è¦‹ pattern for select for { // ç„¡çª®è¿´åœˆæˆ–æŸå€‹å¯iterçš„æ±è¥¿ä¾‹å¦‚ []string{\u0026#34;x\u0026#34;, \u0026#34;y\u0026#34;, \u0026#34;z\u0026#34;}\rselect {\rcase \u0026lt;-done:\r// break or return\rcase result \u0026lt;- data:\rfmt.Println(\u0026#34;put something\u0026#34;)\rdefault:\r// åšå…¶ä»–äº‹\r} } Goroutine leak æŒ‡çš„æ˜¯æˆ‘å€‘ä¸å¸Œæœ›ä¸€ç›´å­˜åœ¨çš„ goroutine ä¸€ç›´å­˜åœ¨ï¼Œé€ æˆè¨˜æ†¶é«”å•é¡Œ\nä¾‹å¦‚\nvar ss chan string\rgo func() {\rfor s := range ss {\rfmt.Println(s)\r}\r}() å¦‚æœ ss æ˜¯ nilï¼Œæˆ–æ˜¯æ ¹æœ¬æ²’äººå»é—œé–‰é€™å€‹ chan\né‚£é€™å€‹ goroutine å°±æœƒä¸€ç›´å­˜åœ¨ç›´åˆ° process çµæŸ\nç¨‹å¼ç¢¼ä¸­å¦‚æœé‡è¤‡å‰µé€ å‡ºé€™ç¨®æ±è¥¿åˆ°æœ€å¾Œè¨˜æ†¶é«”å°±ç”¨å®Œäº†\nè¦è¨˜å¾—é—œé–‰æˆ–è‘—æ˜¯ä½¿ç”¨ for select + done chan å»æé†’ goroutine è©²çµæŸäº†\ngo func(){\r// done is a \u0026lt;-chan inteface{}\rfor {\rselect { case \u0026lt;-done:\rreturn\rcase OOO: }\r}\r}() The or-channel p.94 å¾ˆé•·ä¸€ä¸²ï¼Œç¸½ä¹‹è¦è¨˜å¾—æŠŠ orDone å‚³ä¸‹å»ï¼Œé¿å…ä¸Šå±¤å·²ç¶“çµæŸè€Œä¸‹é¢çš„goroutine éƒ½æ²’é—œæ‰\nError handling p. 111\nåœ¨ä¸€å † concurrent processes ä¸­ï¼Œä¸€å€‹é‡è¦çš„å•é¡Œæ˜¯èª°è¦è™•ç† error\nä¸‹é¢é€™æ®µ code æ˜¯åœ¨ worker è£¡é¢è™•ç†ï¼Œä½†ä»–æœ€å¤šä¹Ÿåªèƒ½å°å‡º err è®“äººçŸ¥é“\nworker := func(done \u0026lt;-chan interface{}, params) \u0026lt;-chan int {\rresults := make(chan int)\rgo func() {\rdefer close(results)\rfor {\rres, err := DoSomething(params)\rif err != nil {\rfmt.Println(err)\rcontinue\r}\rselect {\rcase \u0026lt;-done:\rreturn\rcase results \u0026lt;- res:\r}\r}\r}()\rreturn results\r} å¦‚æœåƒä¸‹é¢é€™æ¨£å°‡ error å‚³å›ï¼Œæ¥æ”¶é€™äº› result çš„ goroutine ä¹Ÿå¯ä»¥ä¾æ“š error ä¾†æ±ºå®šå„å€‹ worker æ˜¯å¦è©²ç¹¼çºŒå­˜æ´»ç­‰ç­‰\ntype Result struct { Error error\rResult int\r}\rworker := func(done \u0026lt;-chan interface{}, params) \u0026lt;-chan Result {\rresults := make(chan Result)\rgo func() {\rdefer close(results)\rfor {\rres, err := DoSomething(params)\rselect {\rcase \u0026lt;-done:\rreturn\rcase results \u0026lt;- Result{Error: err, Result: res}:\r}\r}\r}()\rreturn results\r} å°±åƒæ˜¯ä¸€èˆ¬çš„ go function æœƒå›å‚³ result + errï¼Œåœ¨ä¸€å€‹å°ä¸Šä¸‹æ–‡ä¸æ¸…æ¥šï¼Œå–®ç´”æ˜¯è² è²¬åŸ·è¡Œä»»å‹™çš„ goroutine ä¸­ï¼ŒæŠŠ res + err ä¸€èµ·å‚³å›å»å¸¸å¸¸æ˜¯å¾ˆå¥½çš„é¸æ“‡ ï¼Œè®“å°ä¸Šä¸‹æ–‡æ›´æ¸…æ¥šçš„ goroutine å»è™•ç† error\nPipeline ä¸€é€£ä¸²çš„ stageï¼Œè¼¸å…¥è¼¸å‡ºè³‡æ–™ï¼Œéš¨æ„çµ„åˆ\nè¼¸å…¥èˆ‡è¼¸å‡ºåŒtypeï¼Œæ¯å€‹ stage ç¨ç«‹æ˜“ä¿®æ”¹\n// Batch processing\rfor _, i := range stage2(stage1(intSlice)) {\rfmt.Println(i)\r} // streaming\rfor _, i := range intSlice {\rfmt.Println(stage2(stage1(i)))\r} Best Practices for Constructing Pipelines channel å¾ˆé©åˆ\nä¸Šé¢é‚£å€‹ streaming çš„ä¾‹å­æ˜¯ä¸€å€‹ element æ‹¿å‡ºä¾†ï¼Œè™•ç†å®Œæ‰€æœ‰ stage ä¹‹å¾Œæ‰æ›ä¸‹ä¸€å€‹ element\np. 118 ç¯„ä¾‹æ»¿æœ‰è¶£çš„\nä½¿ç”¨ channelï¼Œæ¯å€‹ stage å„è‡ªè·‘èµ· goroutineï¼Œæ¯å€‹ element ç¶“éä¸€å€‹ stage ä¹‹å¾Œæœƒç›´æ¥å¡åˆ° chan ä¸­ï¼Œè®“ä¸‹ä¸€å€‹ stage æ‹¿ï¼Œè‡ªå·±ä¹Ÿæº–å‚™é–‹å§‹è™•ç†ä¸‹ä¸€å€‹ element\n// example\rfunc multiply(done \u0026lt;-chan interface{}, intStream \u0026lt;-chan int, mu int) \u0026lt;-chan int{\routStream := make(chan int)\rgo func(){\rdefer close(outStream)\rfor i := range intStream{\rselect{\rcase \u0026lt;-done:\rreturn\rcase outStream \u0026lt;- i*mu:\r}\r}\r}()\rreturn outStream\r}\r// add èˆ‡ multiply æ˜¯ stage\r// generator æ˜¯ä¸€å€‹æœƒä¸€ç›´æœ‰å…¶ä»–äººå¡è³‡æ–™é€²ä¾†çš„ chanï¼Œå¯èƒ½æ˜¯å»è®€æª”æ¡ˆæˆ–æ˜¯ç¶²è·¯æ”¶è³‡æ–™ç­‰ç­‰ï¼Œgenerator æ™‚å¸¸ä¹Ÿæœƒå‚³å…¥åŒä¸€å€‹ done ä¸€èµ·æ§åˆ¶é–‹é—œ\rfor v := range multiply(done, add(done, generator, 1), 2){\rfmt.Println(v)\r} Fan-out, Fan-in p. 114\npipeline stage ä¸­å¯èƒ½æœ‰æŸäº› stage è¦èŠ±å¾ˆå¤šæ™‚é–“ä¾†åŸ·è¡Œ\né‚£ä¾¿æœƒæˆç‚ºæ•´æ¢pipeçš„æ•ˆèƒ½ç“¶é ¸\né€™æ™‚å¯ä»¥å˜—è©¦ç”¨å¤šå€‹ goroutine ä¾†åŸ·è¡Œé€™å€‹ stageï¼ŒåŒæ™‚è™•ç†å¤šå€‹è³‡æ–™ä¾†åŠ é€Ÿ\né€™å°±å«åš fan out\nè€Œå¤šå€‹ goroutine è™•ç†å®Œè³‡æ–™å¾Œï¼Œè¦å°‡è³‡æ–™æµåˆ°ä¸€å€‹ç®¡é“ä¸­ï¼Œè®“ä¸‹ä¸€å€‹ stage å¯ä»¥å¾é€™å€‹ç®¡é“å–å‡ºè³‡æ–™ï¼Œå‰‡å«åš fan in\nå¤§æ¦‚çš„ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼Œä¾‹å­å–è‡ªæ›¸ä¸­\n// p. 116, fan-out\rnumFinders := runtime.NumCPU()\rfinders := make([]\u0026lt;-chan int, numFinders) for i := 0; i \u0026lt; numFinders; i++ {\rfinders[i] = primeFinder(done, randIntStream)\r} primeFinder å°±æ˜¯å’Œä¹‹å‰é‚£äº›ä¾‹å­ä¸€æ¨£çš„ä¸€å€‹ stageï¼Œæ¥æ”¶ä¸€å€‹ input channel å¾è£¡é¢æ‹‰è³‡æ–™ï¼Œæœƒå°‡çµæœå‚³å› return çš„ channelï¼Œåªæ˜¯é€™å€‹ stage è¦èŠ±å¾ˆå¤šæ™‚é–“å»è¨ˆç®—\nè€Œ fan-in çš„ä¾‹å­åœ¨ p. 117ï¼Œä¸»è¦å°±æ˜¯æœƒæ¥æ”¶ n å€‹ input channel (ä¸Šé¢é‚£äº› finders)ï¼Œä¸¦è·‘èµ· n å€‹ goroutine ä¾†æŠŠé€™ n å€‹ input channel çš„è³‡æ–™æ¥åˆ°ä¸€å€‹ output channel ä¸Šï¼Œé‚„æœ‰ç”¨ wg æ§åˆ¶ç•¶ input chan å…¨é—œæˆ– done æ™‚ï¼Œè¦æŠŠ output é—œæ‰\nThe or-done-channel p. 119\nä¹‹å‰çš„ pipeline ä¾‹å­ä¸Šéƒ½æ˜¯ç›´æ¥ç”¨ for å» range ä¸€å€‹ channel\nä½†å¯¦éš›ä¸Šä¸æ˜¯åœ¨ä½¿ç”¨ pipeline æ™‚ï¼Œè¢«è®€å–çš„ channel è¡Œç‚ºæœƒç„¡æ³•é çŸ¥ï¼Œç›®å‰çš„ code æ”¶åˆ° done æ™‚ï¼Œä¸ä»£è¡¨è©² channel æœƒè¢«é—œé–‰\nç”¨ä¸‹é¢é€™ç¨® code å¯èƒ½å°è‡´ leak\nfor v := range channel {\r// do something\r} æ‰€ä»¥è¦åƒå‰é¢çš„é é˜² goroutine leak é‚£é‚Šä½¿ç”¨ for select ä¾†è™•ç†\nç•¶ç›®å‰çš„ code æ”¶åˆ° done æ™‚ï¼Œchannel å°±ç®—æ²’é—œé–‰ä¹Ÿå¯ä»¥è·³å‡º range\norDone ä¸»è¦æ˜¯æŠŠå±•é–‹å¾ˆé†œçš„æ±è¥¿åŒ…åœ¨ function è£¡é¢ï¼Œè®“ code ä¹¾æ·¨é»\nfor v := range orDone(done, channel) {\r// do something\r} ä»¥ä¸‹æˆªè‡ª p. 120\norDone := func(done, c \u0026lt;-chan interface{}) \u0026lt;-chan interface{} {\rvalStream := make(chan interface{})\rgo func() {\rdefer close(valStream)\rfor {\rselect {\rcase \u0026lt;-done:\rreturn\rcase v, ok := \u0026lt;-c:\rif ok == false {\rreturn\r}\r// å¦‚æœç›´æ¥ valStream \u0026lt;- v è€Œä¸ç”¨ selectï¼Œæ”¶åˆ° done æ™‚ä¹Ÿå¯èƒ½è¢« valStream å¡ä½\rselect { case valStream \u0026lt;- v: case \u0026lt;-done:\r}\r}\r}\r}()\rreturn valStream\r} tee-channel ä¸€å€‹ chan è®Šå…©å€‹\nbridge-channel æŠŠ channel of channels ä¸­æ¯å€‹ chan æ‹¿å‡ºä¾†ä¸¦æŠŠæ±è¥¿éƒ½è®€å‡º\nQueuing https://www.cnblogs.com/276815076/p/8615500.html\np. 124\nGo è£¡é¢çš„ buffered channel å¸¸å¸¸æœƒè¢«æ‹¿ä¾†ç•¶åš queue ä½¿ç”¨\néš¨ä¾¿å¢åŠ  queue å¯èƒ½æœƒæŠŠä¸€äº›å•é¡Œè—èµ·ä¾†ï¼Œåƒæ˜¯ dead lock, live lock\nåœ¨ pipeline ä¸­éš¨ä¾¿åŠ å…¥ queue é€šå¸¸ä¸æœƒå¢åŠ æ•´é«”çš„æ•ˆèƒ½ï¼Œåªæœƒæ”¹è®Šä¸€äº›äº›è¡Œç‚º\nä¾‹å¦‚ä¸‹é¢çš„ä¾‹å­\na := A(done, inputStream) // æ¯å€‹ element èŠ±è²»1ç§’\rb := B(done, a) // æ¯å€‹ element èŠ±è²»3ç§’ B è¦è™•ç†ä¸€å€‹ element çš„æ™‚é–“æ¯”è¼ƒé•·ï¼Œæ‰€ä»¥ A æŠŠè³‡æ–™å¾€ a é€æ™‚ï¼Œå¯èƒ½æœƒè¢« B çš„è®€å–é€Ÿåº¦å¡ä½\nä½†å°±ç®—åœ¨ä»–å€‘ä¸­é–“åŠ äº†ä¸€å€‹ buffer ä¹Ÿåªæ˜¯è®“ A å¯ä»¥å¿«é€Ÿçš„æŠŠ inputStream è™•ç†å®Œæ—©æ—©é—œé–‰ï¼Œä½†ç¸½é«”åŸ·è¡Œæ™‚é–“é‚„æ˜¯è¢« B é™åˆ¶ä½\næ›¸ä¸Šèˆ‰äº†ä¸‹é¢çš„ä¾‹å­\np := processRequest(done, acceptConnection(done, httpHandler)) å¦‚æœæ˜¯é€™ç¨®æƒ…æ³ï¼Œæˆ‘å€‘å°±å¯èƒ½æœƒæƒ³è¦åœ¨ accpet åˆ° process ä¹‹é–“åŠ å…¥ bufferï¼Œå¦å‰‡ client çš„ request å€‘å¯èƒ½æœƒæ…¢æ…¢å‡ºç¾ timeout, è¢«æ‹’çµ•çš„æƒ…æ³\né€™é‚Šæˆ‘å€‘è¦æ¸›å°‘çš„æ˜¯å‰ä¸€å€‹ stage è¢« block çš„æƒ…æ³ï¼Œè€Œä¸æ˜¯ process çš„æ•ˆèƒ½ã€‚è®“é€™å…©å€‹ stage çš„è™•ç†äº’ç›¸è§£è€¦\nåœ¨é€™é‚Šæåˆ°ä¸»è¦æœ‰å…©å€‹ä½¿ç”¨ queue çš„ç†ç”±\næ‰¹æ¬¡è™•ç†å¯ä»¥å¾—åˆ°å¥½è™• æŸå€‹ stage delay æˆ–å¡ä½æœƒé€ æˆä¸å¥½çš„ feedback loop ç¬¬ä¸€ç¨®æ»¿å¸¸è¦‹çš„ï¼Œè­¬å¦‚å¯«é€² disk ä¹‹å‰æˆ‘å€‘æœƒå…ˆå¸Œæœ›åœ¨ memory è£¡é¢ç›¡é‡æ”¶é›†å®Œè³‡æ–™å†ä¸€æ¬¡å¯«å…¥ï¼Œå› ç‚º disk æ¯æ¬¡è®€å¯«éƒ½å¾ˆæ…¢ã€‚åˆæˆ–è‘—æ˜¯éœ€è¦å­˜å–é ç«¯çš„è³‡æ–™åº«ï¼Œå¯èƒ½æœƒæƒ³è¦æ”¶é›†å¤šé» command ä¸€æ¬¡é€å»ï¼Œæ¸›å°‘ä¾†å›æ¶ˆè€— ç­‰ç­‰ç­‰\nç¬¬äºŒç¨®\npipeline èˆ‡å…¶ä»–ç³»çµ±ä¹‹é–“å¯èƒ½æœƒäº’ç›¸å½±éŸ¿\nèˆ‰å€‹ä¾‹å­ web server èˆ‡ client\nå¦‚æœ web server åœ¨æ¥æ”¶ request æ™‚æ²’æœ‰ bufferï¼Œå¿…é ˆè¦ç­‰ req æ‰èƒ½ç¹¼çºŒæ¥æ”¶ä¸‹ä¸€å€‹ï¼Œå¯èƒ½é€ æˆ req timeoutï¼Œå°è‡´ client ç¹¼çºŒé€æ›´å¤š req è€Œè¶Šä¾†è¶Šç³Ÿã€‚\nå…ˆæŠŠ req queue ä½ï¼Œclient å°±ä»¥ç‚ºåªæ˜¯è™•ç† req ä¹…äº†é»è€Œå·²\né€™ç¨®æƒ…æ³æ„Ÿè¦ºæ¯”è¼ƒé›£çœ‹å‡ºä¾†ï¼Œé‚„éœ€è¦å°äº’å‹•çš„ç³»çµ±æœ‰äº†è§£æ‰è¡Œ\nç¸½çµ queue å¯ä»¥æ”¾çš„åœ°æ–¹ä¹Ÿæ˜¯å…©å€‹\nbatching æœ‰å¥½è™•çš„åœ°æ–¹ pipeline é–‹é ­ å¯ä»¥æ‡‰ç”¨çš„æƒ…å¢ƒä¸å¤šï¼Œæ²’å¿…è¦æ™‚ä¹Ÿä¸å¿…ç”¨ï¼Œä¸ç„¶å°±å¤šä¸€å€‹æ±è¥¿è¦ç®¡\næ›¸ä¸Šé‚„ä»‹ç´¹äº† Little\u0026rsquo;s law ä½†å¯¦åœ¨æœ‰é»çœ‹ä¸æ‡‚åˆ°åº•æ˜¯æ€éº¼ç”¨ï¼¸ï¼¤\nThe context Package å¯ä»¥å»çœ‹ä»–çš„ interfaceï¼Œæ»¿ç°¡æ½”çš„\nctx ä¸»è¦åŠŸèƒ½ï¼š\næä¾› API å»å¾ parent ctx çš„ä½ç½®å»å–æ¶ˆé‚£äº›ç›¸é—œçš„ callï¼Œé¡ä¼¼ä¹‹å‰æ‰€èªªçš„ done è£ request ç›¸é—œè³‡æ–™åˆ°è™•å‚³ å–æ¶ˆåŠŸèƒ½ï¼š\nä¸Šå±¤æƒ³å–æ¶ˆç›®å‰çš„å‹•ä½œ ç›®å‰çš„å‹•ä½œæƒ³å–æ¶ˆä»–æ‰€ç”¢ç”Ÿå‡ºçš„å­å‹•ä½œ blocking çš„å‹•ä½œéœ€è¦å¯ä»¥è¢«å–æ¶ˆå‹•ä½œæ¶å¥ªï¼Œé¿å… leak ctx := context.Background()\rctx2, c := context.WithCancel(ctx) // create new instance\rc()\rfmt.Println(ctx.Err()) // nil\rfmt.Println(ctx2.Err()) // context canceled å› ç‚ºæ˜¯ create new instance æ‰€ä»¥æŠŠ ctx å¾€ä¸‹å‚³ä¹‹å¾Œï¼Œä¸‹å±¤ç„¡æ³•å‘¼å« cancel ä¾†å–æ¶ˆä¸Šå±¤ï¼ˆä¿è­·ï¼‰\nåŸæœ¬çš„ done æ–¹æ³•ä¹Ÿå¯ä»¥åšåˆ°ï¼Œä½†å°±è¦æŠŠ done åŒ…ä¾†åŒ…å»\nå‚³å€¼çš„éƒ¨åˆ†\nuserID := \u0026#34;qq\u0026#34;\rctx := context.WithValue(context.Background(), \u0026#34;userID\u0026#34;, userID)\rfmt.Println(ctx.Value(\u0026#34;userID\u0026#34;)) key å¿…é ˆæ˜¯å¯æ¯”è¼ƒçš„ == != ä¹‹é¡çš„\nvalue å¿…é ˆæ˜¯ concurrent safe\nkeyå¦‚æœéƒ½ä½¿ç”¨ stringï¼Œä½ åˆæŠŠ ctx å‚³å»åˆ¥äººçš„ packageï¼Œæœ‰å¯èƒ½æœƒæ’\næ¨è–¦çš„æ–¹æ³•æ˜¯è‡ªå®šç¾© unexported type ä¾‹å¦‚:\n// p. 143\rtype ctxKey int\rconst (\rctxUserID ctxKey = iota ctxAuthToken\r) ä½†è¦æä¾› func å»å¾ ctx æŠ“è³‡æ–™ï¼Œå®Œæ•´ç¯„ä¾‹åœ¨ p. 143\nä¸é ctx Value å¥½åƒä¹Ÿè¢«å¾ˆå¤šäººè¦ºå¾—å¾ˆä¸å®‰å…¨ï¼Œç•¢ç«Ÿéƒ½æ˜¯ interface{}\nè€Œä¸”å®˜æ–¹ä¹Ÿå»ºè­° ctx åªæ”¾ request-scoped çš„æ±è¥¿ï¼Œä½†é€™æ±è¥¿ä¹Ÿæ»¿é›£å®šç¾©çš„\næ„Ÿè¦ºé‚„æ˜¯å°‘ç”¨ï¼ˆï¼Ÿ\n","description":"Concurrency in Go ç¬¬å››ç« ï½ ","id":20,"section":"posts","tags":["Go","Goroutine","concurrency"],"title":"Concurrency in Go - II ç¬¬å››ç« ","uri":"https://markogoodman.github.io/posts/concurrency-in-go-ii/"},{"content":"é€™ä¸‰ç« ç¯€å…§å®¹å…¶å¯¦æ»¿å°‘çš„ï¼Œè®€éä¹‹å¾Œéš¨ä¾¿è¨˜ä¸€è¨˜\nch1 Why Is Concurrency Hard?\nRace condition\næ‡‰è©²è¦ä¾åºåŸ·è¡Œçš„ä¸åŒæŒ‡å®šå€‘ï¼Œæ²’æœ‰ä¾ç…§æ­£ç¢ºçš„é †åºé€ æˆçµæœéŒ¯èª¤\nä¾‹å¦‚ä¸‹é¢é€™æ®µç¨‹å¼å°±æœ‰å¯èƒ½å‡ºç¾å¾ˆå¤šçµæœï¼Œå› ç‚ºä½¿ç”¨è€…å¯èƒ½ä»¥ç‚ºgoè£¡é¢çš„ç¨‹å¼ç¢¼å¯«åœ¨å‰é¢ï¼Œå°±æœƒå…ˆè·‘\n1 2 3 4 5 6 7 var a int go func(){ a++ }() if a==0{ fmt.Println(\u0026#34;zero\u0026#34;) } Atomicity\nä¸å¯åˆ‡å‰²ï¼Œå®‰å…¨ï¼Œä¸€æ¬¡è¦åšå®Œ\nMemory Access Synchronization\nä¸åŒåœ°æ–¹å¯èƒ½ concurrently å­˜å–åŒä¸€å€‹è¨˜æ†¶é«”ï¼Œéœ€è¦è®Šæˆ critical section ç”¨é–é–ä½ä¹‹é¡çš„ï¼Œä½†æœƒè®Šæ…¢\nDeadlocks, Livelocks, and Starvation\ndead lock -\u0026gt; 4å€‹æ¢ä»¶\nDetermining Concurrency Safety\nâ€¢ Who is responsible for the concurrency?\nâ€¢ How is the problem space mapped onto concurrency primitives?\nâ€¢ Who is responsible for the synchronization?\nch2 Go CSP\nä¸‹åœ–æ˜¯ Concurrency in Go 33 é çš„åœ–\nprimitives æŒ‡çš„åƒæ˜¯ sync package è£¡é¢çš„ mutex\nå››å€‹æ¢ä»¶çš„è§£é‡‹\nAre you trying to transfer ownership of data?\nç›¡é‡ç¶­æŒä¸€æ¬¡åªæœ‰ä¸€å€‹äººæœ‰è³‡æ–™çš„æ“æœ‰æ¬Šåˆ©ï¼Œåšå®Œä¸€ä»¶äº‹å¾Œè¦æŠŠoutputä¸Ÿçµ¦åˆ¥äººé€™ç¨®å‹•ä½œï¼Œé©åˆç”¨ channel\nAre you trying to guard internal state of a struct?\næŠŠå¯¦ä½œè—èµ·ä¾†ä¸è®“å¤–é¢çœ‹åˆ° -\u0026gt; ç”¨primitives\nAre you trying to coordinate multiple pieces of logic?\nåˆ°è™•éƒ½æœ‰ lock å¾ˆå®¹æ˜“é€ æˆå•é¡Œï¼Œè€Œ channel çš„çµ„åˆæ€§å¾ˆå¥½ï¼Œå‡ºéŒ¯ä¹Ÿå¥½æŠ“ï¼Œè¤‡é›œçš„é‚è¼¯æœ€å¥½ç”¨ channel ä¾†åš è€Œä¸æ˜¯è‡ªå·±åˆ°è™•é–ä¾†é–å»\nIs it a performance-critical section?\nçœŸçš„ç™¼ç¾ä½¿ç”¨ channel é€ æˆå·¨å¤§æ•ˆèƒ½å•é¡Œæ‰æ”¹ç”¨ primitivesï¼Œè€Œä¸æ˜¯ç‚ºäº†æ•ˆèƒ½ä¸€é–‹å§‹å°±ç”¨ primitives\nch3 goroutine ä¸èƒ½è¢« interrupt?\nä»¥å‰å¥½åƒæ˜¯ï¼Œå¾Œä¾†æ”¹æˆå¯ä»¥ï¼Œä¸ç„¶åƒåœ¾å›æ”¶ä¹‹é¡çš„åŠŸèƒ½æœ‰å¯èƒ½è¢«å¡ä½\nä½†å¤§å¤šé‚„æ˜¯åœ¨å›ºå®šæ™‚é–“æ‰æœƒè¢«æš«åœï¼Œä¾‹å¦‚ sleep, ç­‰ io ä¹‹é¡çš„\ngoroutine closure åœ¨åŒä¸€å€‹ address space åŸ·è¡Œ\nvar wg sync.WaitGroup\rsalutation := \u0026#34;hello\u0026#34;\rwg.Add(1)\rgo func() {\rdefer wg.Done()\rsalutation = \u0026#34;welcome\u0026#34;\r}()\rwg.Wait()\rfmt.Println(salutation) The sync package WaitGroup var wg sync.WaitGroup // å‚³é€² func æ™‚è¦å‚³ pointer\rwg.Add(2) // +2\rdefer wg.Done() // -1\rwg.Wait() // == 0 æ™‚å®Œæˆ mutex var lock sync.Mutex\rlock.Lock()\rdefer lock.Unlock()\rvar m sync.RWMutex\rm.Lock() // rw lock\rm.RLock() // r lock\rm.RLocker() // r locker Cond æœ‰æ•ˆç‡çš„ç­‰å¾…ï¼Œä¸ç”¨æµªè²»ï¼£ï¼°ï¼µè·‘è¿´åœˆ\nc := sync.NewCond(\u0026amp;sync.Mutex{}) c.L.Lock()\rfor conditionTrue() == false {\rc.Wait() // suspend, å…¶ä»– goroutine å¯ä»¥ç”¨ thread\r}\rc.L.Unlock()\rc.Singal() å»æˆ³æ­£åœ¨ Wait çš„ä¸€å€‹ goroutine (æœ€æ—©é–‹å§‹ç­‰çš„)\rc.Broadcast() å»æˆ³æ‰€æœ‰åœ¨ Wait çš„ goroutines signal å¯ä»¥ç”¨ channel ä¾†åšå‡ºä¸€æ¨£çš„åŠŸèƒ½\nä½† broadcast æœƒæ¯”è¼ƒéº»ç…©ï¼Œä¹Ÿå¯èƒ½éœ€è¦å¾ˆå¤šæ“ä½œ\nonce var once sync.Once\ronce.Do(xxx) å³ä½¿ä¸€å † goroutineï¼Œä¹Ÿä¿è­‰ once åªæœƒåšä¸€ä»¶äº‹æƒ…\nä¸‹é¢é€™ç¨®ä¹Ÿæ˜¯åªæœƒåŸ·è¡Œaaa\nonce.Do(aaa)\ronce.Do(bbb) è¨ˆæ•¸æ˜¯è¨˜once åšéçš„äº‹æƒ…è€Œä¸æ˜¯ unique function æ•¸\nPool å‰µé€ åŠæŒæœ‰æ±è¥¿å¾ˆè²´ ä¸å¸Œæœ›æœ‰å¤ªå¤š æ‰€ä»¥æ”¾åœ¨ä¸€å€‹ pool é‡è¤‡é‹ç”¨ä¸¦é™åˆ¶æ•¸é‡\næå‰æŠŠä¸€äº›æ±è¥¿å¡é€² pool é¿å… createï¼Œåƒæ˜¯ db é€£ç·šç­‰ç­‰\n1 2 3 4 5 6 7 8 9 10 myPool := \u0026amp;sync.Pool{ New: func() interface{} { fmt.Println(\u0026#34;Creating new instance.\u0026#34;) return struct{}{} }, } myPool.Get() instance := myPool.Get() myPool.Put(instance) myPool.Get() ä½¿ç”¨æ–¹æ³•ï¼š\nåŠ å…¥ New func Get çš„æ±è¥¿æœ‰å¯èƒ½æ˜¯ä»»ä½•ç‹€æ…‹ è¨˜å¾— Put å›å»ï¼Œé€šå¸¸ç”¨ defer è£¡é¢çš„æ±è¥¿åŸºæœ¬ä¸Šè¦é•·å¾—ä¸€æ¨£ Channels var dataStream chan int\rvar dataStream \u0026lt;-chan int\rvar dataStream chan\u0026lt;- int\rdataStream = make(\u0026lt;-chan int, 1) å¾ˆå°‘æœƒ make å–®å‘çš„ chanï¼Œé€šå¸¸æ˜¯å‚³åƒæ•¸æ™‚æœƒç”¨\rdataStream := make(chan int)\rvar d chan\u0026lt;- int\rd = dataStream é—œé–‰ channel\nä¹‹å¾Œé‚„æ˜¯å¯ä»¥ç„¡é™è®€å–ï¼Œå› ç‚ºå¯èƒ½å¾ˆå¤šä¸‹æ¸¸çš„ goroutine éƒ½éœ€è¦è®€\ndataStream := make(chan int)\rgo func() {\rclose(dataStream)\r}()\rd, ok := \u0026lt;-dataStream\rfmt.Println(\u0026#34;I GET! \u0026#34;, d, ok) // 0, false æ”¶åˆ° close æ™‚æœƒç›´æ¥ break\rfor integer := range intStream { fmt.Printf(\u0026#34;%v \u0026#34;, integer)\r} p.75 åˆ—å‡ºäº†ä¸åŒç‹€æ…‹çš„ chan ä¸Šæ“ä½œæœƒå‡ºç¾ä»€éº¼æƒ…æ³ï¼ŒåŒ…æ‹¬éŒ¯èª¤å€‘\np. 91 æœ‰ç¯„ä¾‹\nè¦ç”¨å¥½ channel æœ‰å¹¾é»\nç¢ºèª channel çš„ owner æ˜¯èª°ï¼ˆç›¡é‡å°‘ï¼‰ owner è² è²¬ channel çš„å‰µé€ ã€å¯«ã€é—œã€è½‰ç§» ownership é owner è² è²¬è®€ï¼Œç¢ºèª chan ä½•æ™‚é—œã€è™•ç† blocking ä¾‹å¦‚ç¬¬ 2 é»ï¼ŒæŠŠ owner é™åˆ¶åœ¨å¾ˆå°çš„ç¯„åœï¼Œå°±å¯ä»¥é¿å…å¯«å…¥ nil chanã€close closed chan ä¹‹é¡çš„ p.75 æ‰€æçš„ç¨‹å¼é‚è¼¯ bug\nSelect 1 2 3 4 5 6 7 8 9 10 11 12 13 v1 := make(chan int) go func() { time.Sleep(3 * time.Second) close(v1) }() select { case x := \u0026lt;-v1: // v1 æœ‰æ±è¥¿æ‹¿æ™‚ // xxx case v1 \u0026lt;- 1: // v1 æœ‰ç©ºé–“æ™‚ // ooo } ç•¶å¤šå€‹caseéƒ½å¯ä»¥æ™‚æœƒéš¨æ©Ÿé¸ä¸€å€‹\ntimeout\ncase \u0026lt;-time.After(1 * time.Second):\ndefault (é€šå¸¸å’Œforä¸€èµ·ç”¨) å…¶ä»– case éƒ½æ²’ä¸­çš„æ™‚å€™\ndefault:\n","description":"Concurrency in Go é€™æœ¬æ›¸å‰ä¸‰ç« çš„è®€æ›¸ç­†è¨˜ï½ ","id":21,"section":"posts","tags":["Go","Goroutine","concurrency"],"title":"Concurrency in Go - I å‰ä¸‰ç« ","uri":"https://markogoodman.github.io/posts/concurrency-in-go-i/"},{"content":"ä¸€ç›´éƒ½è½èªª Graphql å¾ˆæ½®(? å·¥ä½œä¸Šå…¶å¯¦ä¹Ÿæœ‰é‡åˆ°é¡ä¼¼çš„å•é¡Œï¼Œä¸€å€‹ç©å®¶çš„è³‡æ–™æœ‰ä¸€å †æ¬„ä½ï¼Œå¸¸å¸¸å› ç‚ºå„ç¨®éœ€æ±‚åŠ äº†ä¸€å †åƒæ•¸æˆ– API ä¾†æ‹¿è£¡é¢çš„ä¸åŒæ¬„ä½ï¼Œgraphql ä¹Ÿæœ‰è¢«æåˆ°èªªæ˜¯ä¸€å€‹å¥½é¸æ“‡ï¼Œä¸éç¾åœ¨ä¼ºæœå™¨éƒ½ç”¨ restful å¯«å¥½å¥½çš„è¦æ¬ä¹Ÿæ˜¯ä¸€å€‹å¤§å·¥ç¨‹ï¼Œåªå¥½è‡ªå·±ä¾†ç ”ç©¶ä¸€ä¸‹ XD\nhttps://ithelp.ithome.com.tw/articles/10200678 \u0026lt;- ä¸çŸ¥é“ graphql æ˜¯ä»€éº¼å¯ä»¥åƒè€ƒé€™å€‹ï¼Œæˆ–æ˜¯å»å®˜ç¶²çœ‹ï½\né€™æ±è¥¿ç¶²è·¯ä¸Šä¹Ÿå¾ˆå¤šä»‹ç´¹äº†å°±ä¸å¤šè¬›ï¼Œå¤§è‡´ä¸Šå°±æ˜¯ç”¨ä¸€å€‹ endpoint å°±å¯ä»¥è®“ client server ä¹‹é–“å¾ˆæœ‰å½ˆæ€§çš„é¸æ“‡æƒ³è¦å‚³è¼¸çš„è³‡æ–™ï¼Œå¾ˆåƒæˆ‘å€‘åœ¨ä¸‹è³‡æ–™åº«æŒ‡ä»¤ã€‚\nä¸‹é¢åªæ˜¯ç©ç©çœ‹ gqlgen é€™å€‹ Go çš„ graphql å¥—ä»¶è€Œå·²ï¼Œç¸½ä¹‹åˆæ˜¯ä¸€ç¯‡é›œäº‚çš„æ–‡ç« \ngqlgen å®˜æ–¹ç¯„ä¾‹åœ¨æ­¤ https://gqlgen.com/getting-started/\né¦–å…ˆé€²å»æœƒæ•™ä½ å®‰è£\nç„¶å¾Œè·‘ go run github.com/99designs/gqlgen init æœƒå‡ºç¾ä»–çš„ç¯„ä¾‹\né‚„åŒ…å«ä¸€å€‹ playground GUI è®“æˆ‘å€‘æ–¹ä¾¿ä¸‹ query\ngraph/generated è£¡é¢çš„æ±è¥¿åŸºæœ¬ä¸Šå°±æ˜¯é‚£äº›æ‹†è§£ query ä¹‹é¡çš„ç¨‹å¼ç¢¼ï¼Œ gqlgen éƒ½å¹«æˆ‘å€‘ç”¢ç”Ÿå¥½æ‹‰\nschema (èˆ‡ client çš„æºé€šæ ¼å¼) å°±æ˜¯å¯«åœ¨ graph/schema.graphqls å…§ï¼Œå¾ gqlgen.yml è£¡é¢å¯ä»¥çŸ¥é“ä¹Ÿå¯ä»¥åˆ†æ”¾åœ¨å¤šå€‹æª”æ¡ˆå…§\nschema:\r- graph/*.graphqls graph/model å…§æ˜¯ gqlgen ä¾ç…§ schema ç”¢ç”Ÿçš„ go struct\nå¦‚æœå¸Œæœ›strcutèˆ‡schemaä¸åŒæ™‚ï¼Œå°±è¦åœ¨gqlgem.ymlçš„modelsé‚£é‚Šå…ˆå®£å‘Š(Type Mapping)ï¼Œé€™æ¨£ä»–å°±ä¸æœƒå¹«ä½ genå‡ºä¾†\nåƒè€ƒgqlgen workshopçš„\nmodels:\rUser:\rmodel: github.com/99designs/gqlgen-workshop/db.User æˆ–è€…æ˜¯ç›´æ¥åœ¨autobindé‚£å€‹è·¯å¾‘è£¡é¢å…ˆè‡ªå·±å®£å‘Šä¹Ÿè¡Œï¼Œå°±ä¸æœƒç”¢ç”Ÿ\næ³¨æ„çš„æ˜¯å¦‚æœstructéƒ½importä¾†çš„gqlgenæœƒæ²’æœ‰ç”¢ç”Ÿå‡ºä»»ä½•graph/modelè£¡é¢çš„æª”æ¡ˆå°è‡´ module mode lä¸å­˜åœ¨\ngençš„æ™‚å€™æœƒè·‘å‡ºä¸€å †éŒ¯èª¤\nvalidation failed: packages.Load: -: malformed module path \u0026quot;gqlgen-workshop/graph/model\u0026quot;: missing dot in first path element\nçŒœå¤§æ¦‚æ˜¯æ‰¾ä¸åˆ°modelé€™å€‹module\näº‚æ”¹äº†ymlç™¼ç¾æŠŠ autobind é‚„æœ‰ model é€™å…©å€‹è¨»è§£æ‰å°±ï¼¯ï¼«äº†\nImplement the resolvers è¨»è§£è£¡é¢æœ‰å¯«ï¼Œå…¶å¯¦å°±æ˜¯æŠŠéœ€è¦çš„æ±è¥¿æ”¾é€²å»ä¾‹å¦‚db\ntype Resolver struct{\rtodos []*model.Todo\r} æ¥è‘—è¦å¯¦ä½œ schema.resolvers.go è£¡é¢ CreateTodo å’Œ Todosï¼Œé€™å…©å€‹ func ä¹Ÿæ˜¯ gqlgen ä¾ç…§ schema ç”¢ç”Ÿçš„ï¼Œæ‡‰è©²æ»¿å¥½ç†è§£\nCreateTodo çš„ input é€²ä¾†æˆ‘å€‘å°±è™•ç† input å­˜é€² db\nTodos å°±æ˜¯å›å‚³ db å…§å®¹é€™æ¨£\nå›å‚³å°æ‡‰çš„ struct å¾Œ gqlgen ç”¢ç”Ÿå‡ºä¾†çš„ code (generated.go) æœƒå¹«æˆ‘å€‘è™•ç†å‰©ä¸‹çš„äº‹æƒ…ï¼Œè­¬å¦‚æŠŠ client ä¸éœ€è¦çš„ field æ‹¿æ‰ä¹‹é¡çš„\næ¥è‘—å°±å¯ä»¥ go run server.go å»ä¸Šé¢ç©ç©çœ‹äº†\nå†ä¾†ç¯„ä¾‹ä¸Šè‡ªå·±å¯«äº†ä¸€å€‹ Todo çš„ struct è€Œä¸æ˜¯ç”¨ gen å‡ºä¾†çš„\ntype Todo struct {\rID string `json:\u0026#34;id\u0026#34;`\rText string `json:\u0026#34;text\u0026#34;`\rDone bool `json:\u0026#34;done\u0026#34;`\rUserID string `json:\u0026#34;user\u0026#34;`\r} æ­¤æ™‚å†è·‘ä¸€æ¬¡ go run github.com/99designs/gqlgen generate æœƒç™¼ç¾ schem.resolvers.go å¤šäº†ä¸€å€‹ (r *todoResolver) User\né€™æ˜¯å› ç‚ºä¿®æ”¹ä¹‹å¾Œ Todo struct èˆ‡ schema ä¸Šçš„ Todo å°ä¸èµ·ä¾† (UserID: User)ï¼Œæ‰€ä»¥æˆ‘å€‘åœ¨æŠŠ struct Todo è½‰æ›ç‚º schema Todo æ™‚ï¼Œè¦çµ¦ä»–ä¸€å€‹æ–¹æ³•ï¼Œç”¨ struct Todo è£¡é¢çš„è³‡æ–™çµ„æˆ schema Todoï¼Œè©³æƒ…è«‹åƒè€ƒï¼Œè©³æƒ…è«‹åƒè€ƒ generated è£¡é¢ç”¢ç”Ÿå‡ºä¾†çš„ code\nctx = graphql.WithFieldContext(ctx, fc)\rresTmp, err := ec.ResolverMiddleware(ctx, func(rctx context.Context) (interface{}, error) {\rctx = rctx // use context from middleware stack in children\rreturn ec.resolvers.Todo().User(rctx, obj)\r}) åŸºæœ¬ç¯„ä¾‹åˆ°é€™é‚Šå·®ä¸å¤šå°±çµæŸäº†ï½\nä¸‹é¢é‚„æœ‰å¾ˆå¤š reference å¯ä»¥å»çœ‹çœ‹ï¼Œä¸‹é¢åªå¯«äº†æˆ‘æœ‰çœ‹çš„\nFieldCollection https://gqlgen.com/reference/field-collection/\nå‰é¢çš„ç¯„ä¾‹æ˜¯ client query ä¾†äº†ï¼Œç¨‹å¼å» db æ’ˆå°æ‡‰çš„è³‡æ–™ï¼Œç„¶å¾Œäº¤çµ¦ gqlgen å»æŠŠä¸å¿…è¦çš„æ¬„ä½ç¯©æ‰å†å‚³å›çµ¦ clientï¼Œfield collection æ˜¯è¦è®“ä½ åœ¨æ’ˆ db å‰å…ˆçŸ¥é“åˆ°åº•æœ‰å“ªäº› field æ˜¯è¦ç”¨çš„ï¼Œæ’ˆ db æ™‚å¯é‡å°å»æ’ˆï¼Œé¿å…æµªè²»è³‡æº\nCollectAllFields æœƒç›´æ¥å›å‚³ä¸€å€‹ string slice åŒ…å« query æœ€ä¸Šå±¤çš„ field åç¨±\nCollectFieldsCtx æœƒå›å‚³ä¸€å€‹ CollectedField çš„ sliceï¼ŒCollectedField æ˜¯ä¸€å€‹ struct è£¡é¢åŒ…å«è©² field çš„ä¸€äº›è³‡è¨Š(åç¨±ä¹‹é¡çš„)ï¼Œé‚„æœ‰è©² field çš„å­ field è³‡è¨Š\nä¸‹é¢æ”¹å¯«ä¸€ä¸‹funcå°å‡ºç›¸é—œè³‡è¨Š\nfunc (r *queryResolver) Todos(ctx context.Context) ([]*model.Todo, error) {\rfmt.Printf(\u0026#34;CollectAllFields: %+v \\n\\n\u0026#34;, graphql.CollectAllFields(ctx))\rfmt.Printf(\u0026#34;CollectFieldsCtx: \\n\u0026#34;)\rfor _, field := range graphql.CollectFieldsCtx(ctx, nil) {\rfmt.Printf(\u0026#34; %+v\\n\u0026#34;, field.Name)\rfor _, sel := range field.Selections {\rfmt.Printf(\u0026#34; %+v\\n\u0026#34;, sel)\r}\r}\rreturn r.todos, nil\r} CollectAllFields: [id text done user] CollectFieldsCtx: id\rtext\rdone\ruser\r\u0026amp;{Alias:name Name:name Arguments:[] Directives:[] SelectionSet:[] Position:0xc00011df18 Definition:0xc00011b0a0 ObjectDefinition:0xc000108b40}\r\u0026amp;{Alias:id Name:id Arguments:[] Directives:[] SelectionSet:[] Position:0xc00011df58 Definition:0xc00011b030 ObjectDefinition:0xc000108b40} ç™¼ query å¾Œå¯ä»¥çœ‹åˆ° CollectAllFields å›å‚³äº†ä¸Šå±¤çš„ field nameï¼Œ user è£¡é¢åªè¦è‡³å°‘æœ‰ä¸€å€‹ field å°±æœƒå›å‚³ user\nè€Œ graphql.CollectFieldsCtx è£¡é¢çš„å„å€‹ field é‚„æœ‰ Selectionsï¼Œé€™å°±æ˜¯åŒ…å«äº†å­ field çš„è³‡è¨Šï¼ŒSelection æ˜¯ interfaceï¼Œé€™é‚Šåªè©¦å°å‡ºä¾†ï¼Œå¯¦éš›ä¸Šè¦ç”¨ CollectFieldsï¼Œè£¡é¢æœƒå»è½‰å‹ã€‚\nå› ç‚º field ç„¡æ³•é æ¸¬åˆ°åº•æœ‰å¹¾å±¤ï¼Œå¯¦éš›ä¸Šæ˜¯è¦ç”¨ç¯„ä¾‹ä¸­éè¿´çš„æ–¹å¼å»è§£é–‹\nQuery complexity å› ç‚º filed åº•ä¸‹æœ‰å¯èƒ½åˆæœ‰ field åˆæœ‰ fieldï¼Œä¾‹å¦‚ä¸‹é¢\ntype User {\rfriends: [User!]!\r} å¯èƒ½ query å‡ºä¸€å¨æ±è¥¿ç„¶å¾Œçˆ†ç‚¸\næ‰€ä»¥éœ€è¦æŸäº›æ–¹æ³•ä¾†é™åˆ¶ query çš„é‡\nä¸‹é¢å…ˆä¿®æ”¹åŸæœ¬çš„ä¾‹å­ schema å’Œ model ä¸¦ go generete ./...\n---- graph/schema.graphqls\rtype Todo {\rid: ID!\rtext: String!\rdone: Boolean!\ruser: User!\rrelated(count: Int!): [Todo!]! # count ç”¨ä¾†é™åˆ¶å›å‚³çš„ related todo æ•¸é‡\r}\rinput Relation {\ra: String!\rb: String!\r}\rtype Mutation {\rcreateTodo(input: NewTodo!): Todo!\raddRelated(input: Relation!): Todo!\r}\r---- graph/model/todo.go\rtype Todo struct {\rID string `json:\u0026#34;id\u0026#34;`\rText string `json:\u0026#34;text\u0026#34;`\rDone bool `json:\u0026#34;done\u0026#34;`\rUserID string `json:\u0026#34;user\u0026#34;`\rRelated []string `json:\u0026#34;related\u0026#34;`\r} ç„¶å¾ŒæŠŠ schema.resolvers.go å¯¦ä½œä¸€ä¸‹\naddRelated å°±æ˜¯æŠŠ b åŠ åˆ° a.related\nfunc (r *mutationResolver) AddRelated(ctx context.Context, input model.Relation) (*model.Todo, error) {\rvar a, b *model.Todo\rfor _, todo := range r.todos {\rif todo.ID == input.A {\ra = todo\r} else if todo.ID == input.B {\rb = todo\r}\r}\rif a == nil || b == nil {\rreturn nil, errors.New(\u0026#34;QQ\u0026#34;)\r}\ra.Related = append(a.Related, b.ID)\rreturn a, nil\r}\rfunc (r *todoResolver) Related(ctx context.Context, obj *model.Todo, count int) ([]*model.Todo, error) {\rtodos := []*model.Todo{}\ri := 0\rfor _, rid := range obj.Related {\rfor _, todo := range r.todos {\rif rid == todo.ID {\rtodos = append(todos, todo)\ri++\rif i \u0026gt;= count {\rbreak\r}\r}\r}\r}\rreturn todos, nil\r}\r---- server.go\råŠ å…¥ srv.Use(extension.FixedComplexityLimit(5)) é€™æ™‚å¦‚æœæˆ‘å€‘ä¸‹äº† query\nquery getTodos {\rtodos {\rid\rtext\rdone\rrelated (count:1){\rid\rtext\r}\r}\r} æœƒå‡ºç¾ message\u0026quot;: \u0026ldquo;operation has complexity 7, which exceeds the limit of 5\u0026rdquo;\né€™æ˜¯å› ç‚ºé è¨­ä¸€å€‹ field å’Œä¸€å±¤æ·±åº¦éƒ½æœƒ complexity + 1\né€™é‚Šå…±æœ‰ 7 å€‹ complexity (todos, id, text, done, related, id, text)\nä½†ä¹Ÿå¯ä»¥ç™¼ç¾countä¸ç®¡æ”¹æˆå¤šå°‘complexityéƒ½ä¸æœƒè®Š\næˆ‘å€‘å¯èƒ½æœƒæƒ³è¦é™åˆ¶relatedçš„æ•¸é‡\né€™æ™‚å¯ä½¿ç”¨ custom complexity Calculation\næŠŠ server.go æ”¹æˆ\nc := generated.Config{Resolvers: \u0026amp;graph.Resolver{}}\rcountComplexity := func(childComplexity, count int) int {\rfmt.Println(\u0026#34;childComplexity: \u0026#34;, childComplexity, \u0026#34;, count: \u0026#34;, count)\rreturn count * childComplexity\r}\rc.Complexity.Todo.Related = countComplexity\rsrv := handler.NewDefaultServer(generated.NewExecutableSchema(c)) ä¿®æ”¹çš„ structæ˜¯graph/generated/generated.go è£¡é¢çš„ ComplexityRoot struct è¨ˆç®—è¤‡é›œåº¦çš„ function\næ¥è‘—è·‘ query\nquery getTodos {\rtodos {\rid\rtext\rdone\rrelated (count:2){\rid\rrelated (count:3){\rid\ttext\rdone\r}\r}\r}\r} æœƒå¾—åˆ°\noperation has complexity 24, which exceeds the limit of 5\u0026#34;,\rchildComplexity: 3 , count: 3 childComplexity: 10 , count: 2 ï¼ƒä¸Šé¢ä½¿ç”¨ countComplexity func è¨ˆç®—è¤‡é›œåº¦ = childComplexity * count\nçœ‹èµ·ä¾†æ˜¯ç”¨éè¿´å…ˆè·‘åˆ°æœ€å…§å±¤çš„ related (count:3)ï¼Œä»–çš„ childComplexityæ˜¯3 (filedæ•¸é‡)ï¼Œç®—å‡ºä¾†ç­‰æ–¼ 9\nå†ä¾† related (count:2) çš„ childComplexity æ˜¯ 10 (id + related (count:3)çš„è¤‡é›œåº¦)ï¼Œè¤‡é›œåº¦20\næœ€å¾Œå†åŠ  todos, id, text, done = 24\nç¸½çµä¸€ä¸‹ï¼Œåœ¨ query ä¾†çš„æ™‚å€™ gqlgen å°±æœƒå¹«æˆ‘å€‘æŠŠè¤‡é›œåº¦ç®—å¥½äº†ï¼Œå¯ä»¥è‡ªå·±æ›¿æ›ç®— complexity çš„ funcï¼Œå¦‚æœè¶…éæˆ‘å€‘è¨­å®šçš„è¤‡é›œåº¦é™åˆ¶å°±æœƒä¸çµ¦ä»–éï¼Œé¿å…æœ‰äººäº‚æ‰“ä¸€å †å¥‡æ€ªçš„ queryï¼ŒæŠŠé »å¯¬æˆ–ç¨‹å¼å¼„çˆ†\né€™æ¬¡çœ‹ä¸‹ä¾†å…¶å¯¦æ„Ÿè¦º graphql å„ªå‹¢é‚„æ»¿æ˜é¡¯çš„ï¼Œä¸éæ‡‰è©²ä¹Ÿæœ‰å¾ˆå¤šå‘é‚„æ²’ç ”ç©¶åˆ°ï¼Œåƒæ˜¯ restful å°±ä¸æœƒæœ‰ query complexity é€™ç¨®æ±è¥¿è¦è™•ç†ï¼Œè€Œä¸”è¦ç”¨é€™ç¨®æ–°çš„æ±è¥¿å…¬å¸å…§è¦ç”¨æ„Ÿè¦ºä¹Ÿè¦ä¸€é™£å­ç ”ç©¶æ‰èƒ½ä¸Šæ‰‹\né€™æ¬¡çš„ç¯„ä¾‹ç¨‹å¼ç¢¼æ”¾åœ¨ä¸‹é¢çš„ repo è¨˜éŒ„ä¸€ä¸‹ï¼Œä¸ç„¶ä¹‹å¾Œè¦ç”¨çš„æ™‚å€™å…«æˆä¹Ÿå¿˜è¨˜æ€éº¼ç”¨äº†\nhttps://github.com/Markogoodman/gqltest\n","description":"gqlgen! ç°¡å–®ç´€éŒ„ä¸€ä¸‹","id":22,"section":"posts","tags":["Go","gqlgen","graphql"],"title":"Gqlgen","uri":"https://markogoodman.github.io/posts/gqlgen/"},{"content":"tags: Golang åƒåœ¾å›æ”¶ï½ï½ï½ è¿½è¹¤heapè£¡é¢çš„mem åˆªé™¤æ²’åœ¨ç”¨çš„ ä¿ç•™æœ‰åœ¨ç”¨çš„ ä¸»è¦æœ‰åˆ†å…©å¤§é¡\nä¸€. Reference counting\næ¯å€‹ obj è¨˜ä½è‡ªå·±æœ‰è¢«å¤šå°‘äººé€£çµåˆ°ï¼Œæ­¸é›¶çš„æ™‚å€™é †ä¾¿å›æ”¶\nä¾‹å¦‚ï¼š\na = Person(\u0026#34;A\u0026#34;) // new ä¸€å€‹ Person çš„ instanceï¼Œé€™å€‹ instance çš„ ref count = 1\rb = a // b ä¹Ÿå»æŒ‡ç›¸åŒçš„æ±è¥¿ ref count å† +1\rb = None // ref count -1\ra = None // ref count -1 è®Šæˆ 0ï¼Œè¨˜æ†¶é«”é‡‹æ”¾ å•é¡Œï¼š\ncircular references\na = Person(\u0026#34;A\u0026#34;)\rb = Person(\u0026#34;B\u0026#34;)\ra.friend = b\rb.friend = a\ra = None\rb = None é›–ç„¶å·²ç¶“æ²’æœ‰ä»»ä½•è®Šæ•¸ç›´æ¥æŒ‡åˆ°æ–°å»ºçš„å…©å€‹ instanceï¼Œï¼Œä½†å¯¦éš›ä¸Šå…©å€‹ instance é‚„æ˜¯äº’ç›¸ referenceï¼Œè®“ ref count ä¸æœƒæ­¸é›¶ã€‚\næ‰€ä»¥åªçœ‹ ref count ä¾†å›æ”¶é‚„æ˜¯æœ‰å¯èƒ½ memory leak\nhttps://zhuanlan.zhihu.com/p/101781276\nä¸»è¦æœ‰å…©ç¨®è§£æ±ºæ³•\nè®“å¯«ç¨‹å¼çš„äººè™•ç†\nè­¬å¦‚åœ¨ a.friend = b æ™‚ï¼ŒæŒ‡å®šé€™å€‹æ˜¯ weak pointerï¼Œè®“å®ƒä¸åˆ—å…¥ ref count çš„è¨ˆç®—ã€‚\nå¥½è™•æ˜¯ç¨‹å¼èªè¨€é™¤äº† reference counting å°±ä¸ç”¨åšå…¶ä»–äº‹äº†\nå£è™•æ˜¯ç¢¼è¾²å€‘æ²’å¯«å¥½é‚„æ˜¯æœƒ mem leak\nè®“é›»è…¦åš\nåŠ å…¥ä¸€äº› tracing GC ä¾†è¼”åŠ©è™•ç†é€™äº› circular references çš„å•é¡Œ\nä¸‹é¢æœƒå†è¬›é€™æ˜¯å•¥ï½\nå¥½å£è™•å°±å’Œä¸Šé¢ç›¸å\nç¸½çµè¨ˆæ•¸çš„æ–¹æ³•\nå„ªé»ï¼šå¥½åšï¼Œè¨ˆæ•¸æ­¸é›¶å°±é‡‹æ”¾ï¼Œä¸æœƒåƒ tracing GC ä¸€æ¨£ï¼Œè¦æ‰¾å€‹æ™‚é–“ä¾†åš GC è®“ç¨‹å¼æš«åœä¸€é™£å­ï¼Œ\nç¼ºé»ï¼šæ¯æ¬¡éƒ½å¢åŠ æ¸›å°‘ count ä¹Ÿæœƒæœ‰æ•ˆèƒ½å•é¡Œï¼Œä¸”æ˜¯ä¸èƒ½å‡ºéŒ¯çš„æ±è¥¿ï¼Œç”šè‡³è¦ç”¨é–ä¹‹é¡çš„æ–¹æ³•ä¾†ç¢ºä¿ä¸æœƒæœ‰ race condition\nä¸”è¦é¡å¤–è™•ç†è¿´åœˆå¼•ç”¨çš„å•é¡Œ\näºŒ. Tracing: GC å•Ÿå‹•æ™‚å¾ roots å‡ºç™¼ï¼Œå†ä¾†æ‰¾å‡ºæ²’åœ¨ç”¨çš„æ±è¥¿ç„¶å¾Œå›æ”¶\nå¯ä»¥æƒ³åƒæˆä¸€å€‹ graphï¼Œè£¡é¢çš„ node æ˜¯ä¸€å¡Šä¸€å¡Šçš„è¨˜æ†¶é«”ï¼Œè¢«ç¨‹å¼ allocate ä¾†ä½¿ç”¨ï¼Œedge å°±æ˜¯ reference\nroots å°±æ˜¯é‚£äº›æˆ‘å€‘å¯ä»¥ç›´æ¥å­˜å–åˆ°çš„æ±è¥¿ (åƒæ˜¯å…¨åŸŸè®Šæ•¸æˆ–æ˜¯ goroutine stack)ï¼Œç”±é€™äº› roots é–‹å§‹å»åšåœ–çš„ traverseï¼Œæ‰€æœ‰å¯ä»¥å¾é€™äº› roots\né€£æ¥åˆ°çš„æ±è¥¿éƒ½æ˜¯é‚„åœ¨ä½¿ç”¨çš„ï¼Œåˆ°é”ä¸äº†çš„ node å°±æ˜¯åƒåœ¾\nåœ¨é€™é‚Šä¹Ÿæœ‰ä¸€ç¨® weak pointer ä½†å’Œ reference counting çš„ç”¨æ³•ä¸åŒï¼Œé€™ç¨® edge æ˜¯å¯ä»¥å­˜å–ä¸€å€‹ç‰©ä»¶ï¼Œä½†ä¸ä¿è­·é€™å€‹ç‰©ä»¶ä¸è¢«å›æ”¶\nå¸¸è¦‹åè©ï¼š\nMutator: æ”¹è®Šé‚£äº›è¨˜æ†¶é«”referenceçš„æ±è¥¿ï¼Œåƒæ˜¯æˆ‘å€‘çš„ç¨‹å¼å°±æ˜¯\nMutator roots: root set, root objectsï¼Œå¯ä»¥ç›´æ¥è¢«å­˜å–çš„ç‰©ä»¶ï¼Œåƒæ˜¯éœæ…‹æˆ–å…¨åŸŸè®Šæ•¸ã€åƒæ•¸ã€Goroutine stackçš„å…¶ä»–æ±è¥¿\nCollector: è² è²¬å›æ”¶åƒåœ¾çš„ç¨‹å¼\nCopy GC æœ€åŸå§‹çš„åƒåœ¾å›æ”¶\næŠŠå…¨éƒ¨çš„è¨˜æ†¶é«”åˆ‡æˆå…©ä»½ï¼Œä¸€èˆ¬æ™‚å€™éƒ½æ˜¯ç”¨åŒä¸€ä»½\nç•¶è¦æ”¶åƒåœ¾çš„æ™‚å€™å°±æ˜¯å¾ roots å‡ºç™¼ traverseï¼ŒæŠŠä¸æ˜¯åƒåœ¾çš„æ±è¥¿è¤‡è£½åˆ°å¦ä¸€ä»½ï¼Œç„¶å¾ŒåŸæœ¬çš„é‚£ä¸€ä»½å°±å¯ä»¥æ¸…ç©ºäº†ï¼ˆç•¶ä½œåƒåœ¾ï¼Œä¸ç”¨çœŸçš„æ¸…ï¼‰\næ–‡ç« å¯ä»¥åƒè€ƒé€™å€‹ï¼šhttps://zhuanlan.zhihu.com/p/28197216\nTraverse å’Œè¤‡è£½æ™‚è¦æ³¨æ„çš„å°±æ˜¯æŒ‡æ¨™çš„å€¼ä¹Ÿè¦é †ä¾¿æ›´æ–°\nç¼ºé»æ˜¯ç©ºé–“è¦ç”¨å¾ˆå¤š\nä¸éè¤‡è£½çš„æ™‚å€™å¯ä»¥é †ä¾¿è®“è¨˜æ†¶é«”æ›´ compact æ˜¯å¥½è™•\nåŸºæœ¬çš„ Mark and Sweep https://liujiacai.net/blog/2018/07/08/mark-sweep/\nå°±æ˜¯ç°¡å–®çš„æ”¶åƒåœ¾XD\nç¶²è·¯ä¸Šå¾ˆå¤š pseudo code å¯ä»¥çœ‹\nå…ˆæŠŠå…¶ä»–åœ¨åšçš„äº‹æƒ…éƒ½åœä½ (Stop the world) å¾ roots å‡ºç™¼æŠŠæœ‰ç”¨åˆ°çš„æ±è¥¿ mark èµ·ä¾† æƒé heap æ‰€æœ‰çš„ç‰©ä»¶ï¼ŒæŠŠæ²’ç”¨çš„æ¸…é™¤ æ¢å¾©é‹ä½œ ç°¡å–®å¯ä»¥ç™¼ç¾å•é¡Œé»ï¼Œæœ‰è¨˜æ†¶é«”ç¢ç‰‡ã€æƒéæ•´å€‹ heap å¾ˆæ…¢ã€è¦åœæ­¢æ‰€æœ‰æ±è¥¿\nhttps://stackoverflow.com/questions/23057531/what-are-the-advantages-and-disadvantages-of-having-mark-bits-together-and-separ\nå„ªåŒ–\nBitmap markingï¼š ç”¨ bitmap ä¾†ç´€éŒ„å“ªäº› object æ˜¯è¢« mark ä½çš„\nLazy sweepï¼šallocate æ™‚æ‰å»åšæ¸…åƒåœ¾ï¼Œè€Œä¸”åªæ¸…å‰›å¥½éœ€è¦çš„ç©ºé–“å°±å¥½ï¼Œå¹³å¸¸åªåšæ¨™è¨˜\nMark-Compact å…ˆæŠŠé‚„æœ‰åœ¨ç”¨çš„æ¨™è¨˜èµ·ä¾†ç„¶å¾Œ compact\nhttps://en.wikipedia.org/wiki/Mark-compact_algorithm\nç›®çš„å°±æ˜¯è¦æŠŠé‚„åœ¨ä½¿ç”¨çš„è¨˜æ†¶é«”èšé›†åœ¨ä¸€èµ·ï¼Œæ¸›å°‘è¨˜æ†¶é«”ç¢ç‰‡ï¼Œç¢ç‰‡å¤šå°±æ˜¯æ¯æ¹¯\nå¸¸è¦‹çš„åšæ³•å°±æ˜¯æƒé heapï¼Œç„¶å¾ŒæŠŠæ¯å€‹ obj å¾€é‚Šé‚Šç§»å‹•å°±å¥½\nwikipediaè£¡é¢ä»‹ç´¹äº†å…©ç¨®æ–¹æ³•\nTable-based æ˜¯éœ€è¦æƒéè¨˜æ†¶é«”å…©æ¬¡ï¼Œç¬¬ä¸€æ¬¡æƒéæ™‚è¦ç”¨ä¸€å€‹ break table è¨˜ä½æ¯å€‹ obj åŸæœ¬çš„ä½ç½®é‚„æœ‰é è¨ˆè¦ç§»å‹•åˆ°çš„ä½ç½®ï¼Œç„¶å¾Œå°±å°‡è©² obj ç§»å‹•\nç¬¬äºŒå€‹ pass æ˜¯è¦ç”¨ break table èª¿æ•´é€™äº› obj è£¡é¢çš„ pointer\nBreak table ä¹Ÿæ˜¯å­˜åœ¨åŒä¸€å€‹ heap å…§ï¼Œæ¬ç§»çš„æ™‚å€™å¯èƒ½æœƒå¡åˆ°ï¼Œtable æ‰“æ•£è¦é‡æ–°æ’åº(???)\nLISP2 algorithm æ˜¯ä¸€å€‹ç°¡å–®å¤šçš„æ¼”ç®—æ³•\nè¦ 3 å€‹ pass\nç®—å‡ºä¾†æ¯å€‹ obj é è¨ˆæœƒåˆ°å“ª æ›´æ–°æ¯å€‹ obj æŒ‡å‡ºå»çš„ pointer ç§»å‹•~\nå…¶ä¸­ç¬¬ä¸€æ­¥é è¨ˆè¦ç§»å‹•å»å“ªçš„è³‡è¨Šæœƒå­˜åœ¨å„è‡ª obj ä¸­ Incremental GC https://liujiacai.net/blog/2018/08/04/incremental-gc/#%E5%A2%9E%E9%87%8F%E5%BC%8F-GC-%E6%80%9D%E8%B7%AF\nhttps://segmentfault.com/a/1190000022030353\nhttps://titanwolf.org/Network/Articles/Article?AID=786c12ef-88b2-42da-984a-41ef4b5669d1#gsc.tab=0\nä¸ä¸€æ¬¡åšå®Œæ•´å€‹åƒåœ¾å›æ”¶çš„å‹•ä½œ (å…¶å¯¦ ref counting å°±é¡ä¼¼ï¼Œä½†ç¼ºé»ä¸å°‘)ï¼Œæ¯æ¬¡åœé “å°(æœ€é‡è¦çš„å„ªé»)ï¼Œä½† throughpu æœƒé™ä½å°±æ˜¯äº†\nmark çš„éšæ®µæœƒè¢«åˆ†æˆå¾ˆå¤šæ¬¡\nä¸‰è‰²æ¨™è¨˜æ³•ï¼ˆtricolor markingï¼‰ ä¸€æ¨£å¾ roots å‡ºç™¼å» traverse æ•´å€‹ obj graphï¼Œéç¨‹ä¸­æœƒå°‡ obj å€‘æ¨™æˆä¸åŒé¡è‰²\nä¸€é–‹å§‹ roots éƒ½æ˜¯ç°è‰²ï¼Œå…¶é¤˜ç™½è‰²\né»‘ï¼šå¯ä»¥åˆ°é”ï¼Œä¸”è©²ç¯€é»çš„å­ç¯€é»éƒ½çœ‹éäº†\nç°ï¼šå¯ä»¥åˆ°é”ï¼Œé‚„æ²’å»æª¢æŸ¥è©²ç¯€é»çš„å­ç¯€é»å€‘\nç™½ï¼šé‚„æ²’åˆ°é”ï¼Œå¦‚æœ mark çµæŸéƒ½é‚„æ˜¯ç™½è‰²å°±æœƒè¢«ç•¶ä½œåƒåœ¾\næ¨™è¨˜éšæ®µå¯ä»¥è¢«ä¸­æ–·ï¼Œä¸‹æ¬¡è¦é–‹å§‹æ™‚å¯ä»¥å¾ç°è‰²çš„å­ç¯€é»é–‹å§‹æª¢æŸ¥\nç›´åˆ°æ²’æœ‰ç°è‰²ç¯€é»æ™‚å°±å®Œæˆ mark éšæ®µ\nç°è‰²æ˜¯ç”¨ä¾†è¨˜éŒ„ mark ä¸­æ–·å¾Œï¼Œåˆè¢« mutator æ”¹è®Šç‹€æ…‹çš„ç¯€é»\næ–°å»ºçš„ obj ä¾ç…§ä¸åŒçš„æ–¹æ³•æœƒè¨­ç‚ºä¸åŒé¡è‰²\nç„¶è€Œåœ¨æ¨™è¨˜éšæ®µä¸­æ–·å¾Œå†æ¬¡é–‹å§‹å‰ï¼Œæˆ‘å€‘çš„ç¨‹å¼(mutator)å¯èƒ½æœƒå»æ”¹è®Šé€™äº› obj ä¹‹é–“çš„ referenceï¼Œä»¥ä¸‹åœ–ç‚ºä¾‹ (å¾ä¸Šé¢ç¶²ç«™æŠ“ä¾†çš„)\næ”¹è®Šå¾Œå¯èƒ½é€ æˆé»‘Aç›´æ¥ ref åˆ°ç™½Dï¼Œä¸‹æ¬¡ mark å†é–‹å§‹å¾Œå› ç‚º A æ˜¯é»‘è‰²ï¼Œå°è‡´ D ä¸æœƒè¢«æƒåˆ°ï¼Œèª¤ç•¶æˆåƒåœ¾\nTricolor invvariant ç‚ºäº†é¿å…ä¸Šè¿°çš„æƒ…æ³ç™¼ç”Ÿï¼Œä¸‰è‰²æ¨™è¨˜æ³•é™åˆ¶äº†ç¯€é»çš„é¡è‰²èˆ‡ reference çš„é—œä¿‚\nä¸‹é¢å…©ç¨®åªè¦å…¶ä¸­ä¸€ç¨®æ»¿è¶³å³å¯\nStrong Invariant: é»‘è‰²ä¸å¯ç›´æ¥æŒ‡åˆ°ç™½è‰²ï¼Œä¸Šé¢é‚£ç¨®æƒ…æ³æˆ‘å€‘ä¸æœƒå†å»æª¢æŸ¥é»‘é»çš„å­ç¯€é»ï¼Œå°è‡´æˆŠæ”¶åƒåœ¾\nWeak Invariant: é»‘å¯ä»¥ç›´æ¥æŒ‡åˆ°ç™½è‰²ï¼Œä½†é€™å€‹ç™½è‰²å¿…é ˆæ˜¯æŸå€‹ç°è‰²ç¯€é»çš„ç›´æ¥æˆ–é–“æ¥å¾Œä»£\nåƒè€ƒåœ– https://draveness.me/golang/docs/part3-runtime/ch07-memory/golang-garbage-collector/\nD åœ¨å³åœ–æ˜¯ B çš„å¾Œä»£ï¼Œæ‰€ä»¥å…è¨± A ç›´æ¥ reference\næ¥ä¸‹ä¾†å°±æ˜¯ç•¶ mutator åœ¨é‹ä½œæ™‚ï¼Œæˆ‘å€‘å¦‚ä½•ç¶­æŒä¸Šè¿°å…¶ä¸­ä¸€ç¨® invariant äº†\nåœ¨æˆ‘å€‘çš„ç¨‹å¼ (mutator) åšäº‹æƒ…æ™‚ï¼Œéœ€è¦æ’å…¥ä¸€äº› collector çš„å‹•ä½œ\nread barrier\né¡§åæ€ç¾©è®€è³‡æ–™çš„æ™‚å€™æ’å…¥å‹•ä½œï¼Œé˜²æ­¢ mutator å»è®€ç™½è‰²çš„ obj\nè®€ç™½è‰² obj æ™‚å°±æŠŠå®ƒæ¨™æˆç°è‰²\nä¾‹ï¼šä¸Šé¢é‚£å€‹ Figure 7 åœ¨è®€ D çš„æ™‚å€™å°±æŠŠ D å¡—æˆç°è‰²\nå¯ä»¥ä¿è­‰ä¸Šé¢çš„ strong invariant\nwrite barrier\nhttps://www.mdeditor.tw/pl/prRu/zh-tw\nhttps://www.mdeditor.tw/pl/pFz3/zh-tw\nå¯«è³‡æ–™æ™‚æ’å…¥å‹•ä½œï¼ŒåŸºæœ¬çš„æœ‰å…©ç¨®\nstackå¤ªå¤šï¼Œå¦‚æœé–‹write barrieræœƒå¾ˆæ…¢ï¼Œé€šå¸¸åªé–‹heapï¼Œæ‰€ä»¥ä»¥ä¸‹å…©ç¨®æ–¹æ³•éœ€è¦å†é–‹å§‹æˆ–çµæŸæ™‚æƒä¸€æ¬¡stackä¾†è™•ç†ï¼Œé é˜²æœ‰ç™½è‰²è¢«å·²æƒéçš„stackæŒ‡åˆ°\na. insert write barrier (dijkstra)\rç•¶ mutator æŠŠé»‘è‰²æŒ‡å‘ç™½è‰²æ™‚ï¼Œæœƒå°‡ç™½è‰²è®Šæˆç°è‰²ï¼Œæˆ–è€…æŠŠé»‘è‰²è®Šæˆç°è‰² (å‰è€…å¥½åƒæ¯”è¼ƒå¸¸è¦‹)\rå¦‚æ­¤ä¸€ä¾†å°±ç¬¦åˆ strong invariant äº†ï½\rmarkçµæŸå¾Œè¦å†æƒä¸€æ¬¡stackï¼Œå› ç‚ºstackæ²’é–‹wbï¼ŒæŒ‡åˆ°çš„æ±è¥¿å¯èƒ½æ˜¯ç™½è‰²å»éœ€è¦å­˜æ´»\rb. delete write barrier (Yuasa)\rè‹¥æœ‰ä¸€å€‹æŒ‡é‡æŒ‡å‘ä¸€å€‹ obj ä¸”è©² obj ç‚ºç™½æˆ–ç°\rç•¶ mutator æ­¤æŒ‡é‡æ‹¿æ‰æ™‚ï¼Œè©² obj è¦è¢«å¡—æˆç°è‰²\rä¸€é–‹å§‹éœ€è¦æƒrootsï¼ŒæŠŠrootsç›´æ¥æŒ‡åˆ°çš„éƒ½å¡—ç°\rç‚ºä½•éœ€è¦é–‹å§‹æ™‚æƒstack-\rhttp://www.yuasa.kuis.kyoto-u.ac.jp/~yuasa/ilc2002/slide.pdf\rå› ç‚ºstackæ²’é–‹rbï¼Œå¦‚æœæœ‰ä¸€å€‹rootåœ¨stackä¸Šï¼Œè‹¥ä»–ç›´æ¥æŒ‡åˆ°æŸå€‹objï¼Œä¸”é€™å€‹pointeråœ¨é€™å€‹objè¢«çœ‹åˆ°å‰ï¼Œå°±è¢«ç§»é™¤ï¼Œé‚£æ­¤objå¯èƒ½è¢«å¦å¤–çš„é»‘è‰²æŒ‡åˆ°ï¼Œå°±é‚„æ˜¯ç™½è‰²å»éœ€è¦å­˜æ´»\rä¸€èˆ¬ä¾†èªª write barrier çš„æ•ˆç‡æœƒæ¯”è¼ƒå¥½ï¼Œå› ç‚º heap è®€æ¯”å¯«å¤šå¾ˆå¤š\nGenerational GC https://liujiacai.net/blog/2018/08/18/generational-gc/\nåˆ†ä»£ï¼Œå¤§éƒ¨åˆ†çš„æ±è¥¿å‰›å‰µå»ºä¸ä¹…å°±æœƒè®Šæˆåƒåœ¾ï¼Œæ‰€ä»¥æŠŠå¹´è¼•å’Œè€çš„ç‰©ä»¶åˆ†é–‹å­˜\nå¹´è¼•çš„éƒ¨åˆ†å¸¸å¸¸åšï¼§ï¼£ï¼Œè€çš„å¶çˆ¾åš\né€šå¸¸å¹´è¼•çš„ obj å¤šï¼Œè€çš„å°‘\nyoung -\u0026gt; old çš„ pointer æ¯” old -\u0026gt; young å¤š\nä¸å‹•åˆ° oldï¼Œç¨ç«‹å›æ”¶ young éƒ¨åˆ†\nè€ƒæ…®åˆ° old -\u0026gt; young çš„ pointer\nå¯ä»¥æ–°å¢ write barrier åšä¸€äº›æ“ä½œï¼Œç•¶ old æŒ‡åˆ° young æ™‚å°±è¨˜ä½ï¼ŒæŠŠè¢«æŒ‡åˆ°çš„ young ç•¶ä½œ young gc æ™‚çš„ root è‹¥è©² old æ˜¯è®Šæˆåƒåœ¾ï¼Œå‰‡ young æœƒæš«æ™‚æˆç‚ºå¯¦éš›ä¸Šæ˜¯åƒåœ¾çš„ root\næ‰€ä»¥ä¸‹æ¬¡è€ gc æ™‚è¦æ¸…æ‰\nç¨ç«‹å›æ”¶ old\nè¦è€ƒæ…®åˆ° young -\u0026gt; old çš„ pointer\nå¯ä»¥ä¾ç…§ä¸Šé¢çš„æ–¹æ³•ä¾†åšï¼Œä½†é€šå¸¸ young -\u0026gt; old çš„ pointer æ•¸é‡è¼ƒå¤š\nè¦è¨˜éŒ„çš„æ±è¥¿æœƒå¾ˆå¤šï¼Œå¯ä»¥ç›´æ¥æŠŠæ‰€æœ‰ young ç•¶ä½œ root setï¼Œåæ­£ä¸å¤š Go GC ä¸€é–‹å§‹é©ç”¨æ’å…¥å±éšœå¾Œä¾†æ”¹ç”¨æ··åˆå‹ï¼Œçµåˆæ’å…¥å’Œåˆªé™¤å¯«å±éšœï¼Œå»é™¤äº†é–‹é ­æˆ–çµæŸæ™‚çš„ scan\nä»‹ç´¹æ€éº¼è®“ Go gc æ›´æœ‰æ•ˆç‡\nhttps://www.ardanlabs.com/blog/2018/12/garbage-collection-in-go-part1-semantics.html\nhttps://golangpiter.com/system/attachments/files/000/001/718/original/GP_2019_-_An_Insight_Into_Go_Garbage_Collection.pdf?1572419303\nhttps://www.mdeditor.tw/pl/prRu/zh-tw\nhttps://www.mdeditor.tw/pl/pFz3/zh-tw\n\u0026quot;\u0026quot; å¼•ç”¨ä¸Šé¢æ–‡ç« çš„æ®µè½\nåœ¨Go èªè¨€ v1.7 ç‰ˆæœ¬ä¹‹å‰ï¼Œä½¿ç”¨çš„æ˜¯ Dijkstra æ’å…¥å¯«å±éšœä¿è­‰å¼·ä¸‰è‰²ä¸è®Šæ€§ï¼Œä½†æ˜¯åŸ·è¡Œæ™‚ä¸¦æ²’æœ‰åœ¨æ‰€æœ‰çš„åƒåœ¾æ”¶é›†æ ¹ç‰©ä»¶ä¸Šé–‹å•Ÿæ’å…¥å¯«å±éšœã€‚å› ç‚º Go èªè¨€çš„æ‡‰ç”¨ç¨‹å¼å¯èƒ½åŒ…å«æˆç™¾ä¸Šåƒçš„ goroutineï¼Œè€Œåƒåœ¾æ”¶é›†çš„æ ¹ç‰©ä»¶ä¸€èˆ¬åŒ…æ‹¬å…¨åŸŸæ€§è®Šæ•¸å’Œæ£§ç‰©ä»¶ï¼Œå¦‚æœåŸ·è¡Œæ™‚éœ€è¦åœ¨å¹¾ç™¾å€‹ goroutine çš„æ£§ä¸Šéƒ½é–‹å•Ÿå¯«å±éšœï¼Œæœƒå¸¶ä¾†å·¨å¤§çš„é¡å¤–é–‹éŠ·ï¼Œæ‰€ä»¥ Go åœ˜éšŠåœ¨å¯¦ç¾ä¸Šé¸æ“‡äº†åœ¨æ¨™è¨˜éšæ®µå®Œæˆæ™‚æš«åœç¨‹å¼ã€å°‡æ‰€æœ‰æ£§ç‰©ä»¶æ¨™è¨˜ç‚ºç°è‰²ä¸¦é‡æ–°æƒæï¼Œåœ¨æ´»èº goroutine éå¸¸å¤šçš„ç¨‹å¼ä¸­ï¼Œé‡æ–°æƒæçš„éç¨‹éœ€è¦ä½”ç”¨ 10 ~ 100ms çš„æ™‚é–“\n\u0026quot;\u0026quot;\nhttps://studygolang.com/articles/27243\nHybrid write barrier https://github.com/golang/proposal/blob/master/design/17503-eliminate-rescan.md\nå¯ä»¥çœ‹ Proposal å’Œ Reasoningï¼Œæœ‰ä»‹ç´¹ç‚ºä½•ä»–å€‘å¯ä»¥æ¶ˆé™¤é–‹é ­æˆ–çµå°¾çš„æƒæ\nwritePointer(slot, ptr):\rshade(*slot)\rif current stack is grey: shade(ptr)\r*slot = ptr å¥‡æ€ªçš„ä¾‹å­\rA-\u0026gt;B\rC-\u0026gt;nil\réƒ½åœ¨ AC éƒ½åœ¨ stack ä¸Šï¼Œè‹¥Cé»‘ï¼ŒABç™½\rç•¶è®Šæˆ\rA -\u0026gt; nil\rC -\u0026gt; B\ræ™‚ï¼Œå› ç‚ºæ˜¯stack æ‰€ä»¥wbéƒ½ä¸æœƒå•Ÿå‹•ï¼Ÿ\rBæœƒè¢«èª¤åˆªå— é€™è£¡èªªç•¶æ··åˆå¯«å±éšœæ™‚ï¼Œåœ¨æƒæç‰¹å®šä¸€å€‹goroutineä¸Šçš„stackæ™‚é‚„æ˜¯è¦æš«åœï¼Œä¸€æ¬¡æƒå®Œ(æ‰€ä»¥ä¸Šé¢é‚£ç¨®æƒ…æ³ä¸æœƒå‡ºç¾)\nä½†ä¸ç”¨åƒYuasaä¸€é–‹å§‹æŠŠå…¨éƒ¨stackæƒå®Œæˆ–æ˜¯Dijkstraæœ€å¾Œé‡æƒ\nhttps://liqingqiya.github.io/golang/gc/%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/%E5%86%99%E5%B1%8F%E9%9A%9C/2020/07/24/gc5.html\nå…¶é¤˜é€£çµ\nhttps://mcll.top/2020/04/14/gc-write-barrier/\nhttps://www.bookstack.cn/read/qcrao-Go-Questions/spilt.3.GC-GC.md\nåŸå§‹ç¢¼\nhttps://go.googlesource.com/go/+/go1.7beta2/src/runtime/mbarrier.go\n","description":"è®€åƒåœ¾å›æ”¶çš„ç­†è¨˜ï¼Œæ‡¶çš„æ•´ç†RR","id":23,"section":"posts","tags":["Go","Garbage collection"],"title":"åƒåœ¾å›æ”¶ï¼","uri":"https://markogoodman.github.io/posts/gc/"},{"content":"ç­†è¨˜ä¸€ä¸‹ç ”ç©¶ csrf æŸ¥åˆ°çš„è³‡æ–™ï¼Œæœ‰äº›å°åœ°æ–¹ç¶²è·¯ä¸Šçš„è³‡æ–™éƒ½æ»¿æ¨¡ç³Šçš„çœŸçš„æŸ¥æœ‰å¤ ä¹… XD\nCSRF (Cross-site request forgery) åŸºæœ¬åŸç† åŸºæœ¬åŸç†å°±æ˜¯ä½¿ç”¨è€…åœ¨æŸå€‹ A ç¶²ç«™èªè­‰(ç™»å…¥å¸³è™Ÿä¹‹é¡çš„)å¾Œç€è¦½å™¨æŠŠ cookie å­˜ä¸‹ä¾†ï¼Œæ”»æ“Šè€…åˆ©ç”¨ç™¼é€ request æœƒè‡ªå‹•å¸¶ä¸Š cookie çš„é€™å€‹å‹•ä½œä¾†è®“ä½¿ç”¨è€…èª¤ç™¼ä¸€äº›å¥‡æ€ªçš„ request å»æŸ A ç¶²ç«™ã€‚\nèˆ‰å€‹ç°¡å–®çš„ç¯„ä¾‹\nåƒæ˜¯ä¸€å€‹ç¶²ç«™ XXX æä¾› API å¯ä»¥åˆªé™¤æ–‡ç« \n/posts/delete?id=12\nä½†éœ€è¦ä½¿ç”¨è€…ç”¨å¸³è™Ÿå¯†ç¢¼ç™»å…¥å¾Œï¼Œæ‰“é€™å€‹ API æ™‚åœ¨ cookie ä¸­å¸¶è‘—ä¸Š session id æ‰å¯ä»¥åˆªé™¤\né‚£å£å£çš„ç¶²ç«™å¯èƒ½æœƒæœ‰é€™æ¨£çš„æ±è¥¿\n\u0026lt;a href='http://XXX/posts/delete?id=12'\u0026gt;hi\u0026lt;/a\u0026gt;\nå¦‚æœä½ ä¹‹å‰ç™»å…¥éXXXç¶²ç«™ï¼Œè€Œä¸”è©²ç¶²ç«™åˆæ²’æœ‰åšå¥½é˜²è­·ï¼Œé»ä¸‹å»æ–‡ç« å°±æœƒè¢«ç æ‰æ‹‰\næ³¨æ„çš„æ˜¯æ”»æ“Šè€…çœ‹ä¸åˆ° cookie çš„å…§å®¹ï¼Œåªæ˜¯è®“å—å®³è€…ç„¡æ„é–“ä½¿ç”¨äº†ã€‚\nç¶²è·¯ä¸Šæœ‰æ›´è©³ç´°çš„ä»‹ç´¹é€™é‚Šå°±ä¸å¤šè¬›ï¼Œç¸½ä¹‹æ”»æ“Šçš„æ–¹å¼äº”èŠ±å…«é–€ï¼Œä¸ç®¡æ˜¯æ›æˆPOSTï¼Œæˆ–æ˜¯å¾Œç«¯åªæ”¶ json ä¹‹é¡çš„æ–¹æ³•éƒ½æ˜¯æœ‰è¾¦æ³•ç ´è§£ (ä½†æˆ‘ä¸æœƒ\né€™ç¯‡ä¸»è¦æƒ³è¨˜éŒ„ä¸€äº›æ¯”è¼ƒå¸¸ç”¨çš„é˜²ç¦¦æ–¹æ³•çš„é‹ä½œ\nåœ–å½¢é©—è­‰ç¢¼æˆ–ç°¡è¨Šå¯†ç¢¼ å¾ˆå¤šæ¯”è¼ƒæ•æ„Ÿçš„æ“ä½œéƒ½æœƒè¦æ±‚é€™äº›ï¼Œå› ç‚ºé€™é¡çš„æ”»æ“Šç„¡æ³•å¾—åˆ°é©—è­‰ç¢¼è³‡è¨Šæ‰€ä»¥é˜²ç¦¦æˆåŠŸ\nä½†å°ä½¿ç”¨è€…ä¾†èªªé€™æ˜¯ä¸€å€‹éº»ç…©\nSamesite cookie æ˜¯ä¸€ç¨®è¨­å®š http cookie å¯ä»¥è¨­å®šçš„å±¬æ€§\né•·å¾—åƒé€™æ¨£\nSet-Cookie: session_id=123; SameSite=Strict\nåŸºæœ¬ä¸Šå¯ä»¥å»è¨­å®šç€è¦½å™¨åœ¨è·¨ç«™çš„ request æ˜¯å¦æœƒè‡ªå‹•å¸¶ cookieã€‚\nè¨­å®šæˆä¸æœƒè‡ªå‹•å¸¶çš„æ™‚å€™å°±é˜²ä½äº† csrf\nè©³ç´°è«‹åƒè€ƒä¸‹é¢é€£çµï¼Œè£¡é¢æœ‰èªªæ˜äº†æ€æ¨£ç®—æ˜¯è·¨ç«™ä»¥åŠä¸åŒ SameSite è¨­å®šçš„å½±éŸ¿\nhttps://medium.com/@azure820529/chrome-80-%E5%BE%8C%E9%87%9D%E5%B0%8D%E7%AC%AC%E4%B8%89%E6%96%B9-cookie-%E7%9A%84%E8%A6%8F%E5%89%87%E8%AA%BF%E6%95%B4-default-samesite-lax-aaba0bc785a3\nç›®å‰å¾ˆå¤šæ±è¥¿éƒ½æ˜¯å‰å¾Œç«¯åˆ†é›¢æ¶åœ¨ä¸åŒåœ°æ–¹ï¼Œé€™äº›éƒ½æ˜¯è·¨ç«™çš„ requestã€‚\nå› ç‚º samesite å’Œ same-origin policy åå­—å¤ªåƒäº†æˆ‘å°±é †ä¾¿çœ‹äº†ä¸€ä¸‹åŒæºæ”¿ç­–ï¼Œçµæœæ ¹æœ¬æ˜¯ä¸åŒçš„æ±æ±ã€‚\nåŒæºæ”¿ç­–æ˜¯ç€è¦½å™¨ä¸Šçš„åŠŸèƒ½ï¼Œä¸»è¦åšçš„æ˜¯ cross-origin ç™¼å‡ºè«‹æ±‚å¾Œï¼Œæ”¶åˆ°å›æ‡‰æ™‚ç€è¦½å™¨æœƒçœ‹çœ‹åŒæºæ”¿ç­–çš„è¨­å®šæ˜¯å¦ OKï¼Œä¸ OK çš„è©±æœƒæŠŠå›æ‡‰æ“‹æ‰ã€‚\nä¸éå¯¦éš›ä¸Š request é‚„æ˜¯æœ‰ç™¼å‡ºå»ï¼Œæ‰€ä»¥è¦æ˜¯åƒå‰é¢é‚£ç¨®æ”»æ“Šä¾‹å­ä¹Ÿæ“‹ä¸ä½\nè©³ç´°è«‹åƒè€ƒï¼šhttps://blog.techbridge.cc/2017/05/20/api-ajax-cors-and-jsonp/\né‚„æœ‰Jå€‹ youtube.com/watch?v=KaEj_qZgiKY\u0026amp;ab_channel=LiveOverflow\nSynchronizer Token Pattern å› ç‚º Samesite cookie ä¸æ˜¯æ¯å€‹ç€è¦½å™¨éƒ½æ”¯æ´\næˆ‘å€‘é‚„æ˜¯éœ€è¦åˆ¥çš„æ–¹æ³•ä¾†åˆ¤åˆ¥é€ req çš„åˆ°åº•æ˜¯ä¸æ˜¯ä½¿ç”¨è€…\nSynchronizer Token Pattern å°±æ˜¯ç•¶ç€è¦½å™¨è·Ÿ server è¦ç¶²é çš„æ™‚å€™ï¼Œserver å·å·åœ¨è¡¨å–®ä¸­å¡ä¸€å€‹éš¨æ©Ÿç”¢ç”Ÿä¸”éš±è—çš„ csrf tokenï¼Œä¸¦è‡ªå·±å­˜ä¸€ä»½ã€‚server æ”¶åˆ° request æ™‚æœƒæ¯”å°è‡ªå·±å­˜çš„èˆ‡æ”¶åˆ°çš„æ˜¯å¦ç›¸åŒã€‚\nè©³ç´°è«‹åƒè€ƒï¼šhttps://medium.com/cross-site-request-forgery-csrf/synchronizer-token-pattern-63871b4c83ad\næä¸€ä¸‹å¦‚æœæ²’æœ‰åŒæºæ”¿ç­–å¼„å¥½ï¼Œå—å®³è€…åœ¨æƒ¡æ„ç¶²ç«™ç™¼äº† requestï¼Œæƒ¡æ„ç¶²ç«™å¯ä»¥çœ‹åˆ°å›ä¾†çš„ responseï¼Œcsrf token å°±è¢«çœ‹åˆ°åš•\nå‰å¾Œç«¯åˆ†é›¢çš„ç‹€æ³ä¸‹å¯èƒ½è¦æŠŠåŒæºæ”¿ç­–è¨­å¥½ï¼Œåªè®“åˆæ³•å‰ç«¯çœ‹åˆ° tokenï¼Œå‰ç«¯å†é€ req æ™‚é †ä¾¿å¸¶ä¸Š\ndouble submit cookie é€™å€‹æ±è¥¿æ˜¯æˆ‘æŸ¥æ¯”è¼ƒä¹…æ‰ææ¸…æ¥šçš„\né‹ä½œæµç¨‹æ˜¯\nserver æŠŠ csrf token è¨­åˆ°ç€è¦½å™¨çš„ cookie å…§ï¼Œç€è¦½å™¨åœ¨é€ request æ™‚å¯ä»¥æŠŠé€™å€‹ token å¾ cookie æ‹¿å‡ºä¾†ï¼Œæ”¾åˆ° header (æˆ–æ˜¯ form è£¡é¢éƒ½å¯ä»¥) è£¡é¢ä¸€èµ·é€çµ¦ serverã€‚\né€™æ™‚é€²è¡Œäº† csrf æ”»æ“Šï¼Œé€™å€‹æ”»æ“Š request å…¶å¯¦é‚„æ˜¯æœƒå¸¶è‘— cookie çš„ (å¦‚æœæ²’è¨­ samesite çš„è©±æ‹‰)ï¼Œä½† csrf æ”»æ“Šè€…æ˜¯çœ‹ä¸åˆ° cookie çš„ï¼Œè‡ªç„¶ä¹Ÿå°±ä¸çŸ¥é“è¦æ”¾ä»€éº¼ token åˆ° header è£¡é¢ï¼Œèªè­‰å¤±æ•—ã€‚\nè©³ç´°ï¼šhttps://medium.com/cross-site-request-forgery-csrf/double-submit-cookie-pattern-65bb71d80d9f\né‚„æœ‰å…¶ä»–çš„è®Šå½¢åƒæ˜¯è®“å‰ç«¯è‡ªå·±ç”¢ç”Ÿ token æ”¾åˆ° cookie è£¡é¢ä¹Ÿè¡Œ (é€reqæ™‚æ”¾åˆ° header ä¸€èµ·å¸¶å» server)\nç¸½ä¹‹åªè¦æ”»æ“Šè€…ç„¡æ³•è®€åˆ° cookieï¼Œä»–å°±ç„¡æ³•åœ¨ header æ”¾å…¥ä¸€æ¨£çš„æ±è¥¿\né€™ç¨®æ–¹æ³• server ä¸ç”¨å­˜ token\nå‰å¾Œç«¯åˆ†é›¢ä¸”åœ¨å®Œå…¨ä¸åŒç¶²åŸŸçš„æƒ…æ³ä¸‹ï¼ŒæŠŠ token å¾ cookie æ‹¿å‡ºä¾†é€™æ®µå¯èƒ½æœƒæœ‰å›°é›£ï¼Œæˆ–è¨±å¯ä»¥åœ¨ç¬¬ä¸€æ¬¡æ”¶åˆ° token æ™‚å°±å­˜åœ¨ local storage ä¹‹é¡çš„åœ°æ–¹ï¼Œä½†ä¹Ÿæ„Ÿè¦ºå¾ˆå®¹æ˜“è¢«ç›œ\nå·®ä¸å¤šå¯«å®Œäº†ï¼Œæˆ‘ä¹Ÿä¸çŸ¥é“ç‚ºå•¥æˆ‘æ²’åœ¨å¯«ç¶²é é‚„ç ”ç©¶é€™å€‹\n","description":"ç­†è¨˜ä¸€ä¸‹ csrf","id":24,"section":"posts","tags":["csrf"],"title":"Csrf","uri":"https://markogoodman.github.io/posts/csrf/"},{"content":"Part III: Examples Goroutine çš„é‹ä½œåŸç†å…¶å¯¦åœ¨å‰é¢å…©ç¯‡å°±æœ‰å¾ˆå¥½çš„è§£é‡‹æ‹‰\né€™å€‹éƒ¨åˆ†ä¸»è¦æ˜¯çµ¦ä¸€äº›å¯¦éš›çš„ä¾‹å­ï¼Œæœƒä»‹ç´¹ä¸€ä¸‹å¹³è¡Œèˆ‡ä¸¦è¡Œé©åˆçš„æ˜¯å“ªäº›æƒ…æ³ï¼ŒGoroutine åˆ°åº•ä»€éº¼æ™‚å€™é–‹å¤šæ‰å¯ä»¥è®“è™•ç†äº‹æƒ…çš„æ•ˆç‡å¢åŠ \næ¥ä¸‹ä¾†ç°¡çŸ­å›æ†¶ä¸€ä¸‹ Part I å¯«éçš„é€™å…©å€‹é‡é»\n1. Parallelism vs Concurrency Parallelism å¹³è¡Œ\næŠŠä¸åŒçš„ä»»å‹™æ”¾åˆ°ä¸åŒçš„ core ä¸ŠåŸ·è¡Œï¼ŒåŒä¸€å€‹æ™‚é–“é»åŒæ™‚åŸ·è¡Œä¸åŒçš„ä»»å‹™ï¼Œéœ€è¦æœ‰å¤šæ–¼ä¸€å€‹çš„ core æ‰å¯è¾¦åˆ°ï¼ŒåŸºæœ¬ä¸Šæ•ˆèƒ½æœƒæ¯”åªä½¿ç”¨ä¸€å€‹ core å¥½ï¼Œé™¤éæœ‰ä»€éº¼äº’ç›¸å¡è³‡æºçš„å•é¡Œï¼Œç­‰ç­‰çš„ç¯„ä¾‹æœƒä»‹ç´¹ä¸€äº›ä¾‹å¤– -\u0026gt; å¦‚ä¸‹åœ–çš„ G1ã€G2 å°±æ˜¯å¹³è¡ŒåŸ·è¡Œ\nConcurrency ä¸¦è¡Œ\nåŒä¸€æ™‚é–“é»åŸ·è¡Œä¸€å€‹ä»»å‹™ï¼Œä¸åŒçš„ä»»å‹™å¿…é ˆè¼ªæµ(é †åºä¸ç¢ºå®š)ï¼Œä¸”çµæœèˆ‡ä¾åº(sequential)åŸ·è¡Œæ‰€æœ‰ä»»å‹™ç›¸åŒï¼Œç„¶å¾Œå¸Œæœ›æ•ˆèƒ½æœƒæ¯”ä¾åºåŸ·è¡Œä¾†å¾—å¥½ -\u0026gt; å¦‚ä¸‹åœ–çš„ G1 G4 G6 èˆ‡ G2 G3 G5\n2. CPU Bound èˆ‡ I/O Bound çš„ä»»å‹™é¡å‹ CPU Bound:\nI/O è¨­å‚™æ•ˆèƒ½ç›¸å°å¥½ã€‚éœ€è¦ core çš„è¨ˆç®—èƒ½åŠ›æ›´å¼·ï¼Œæˆ–è‘—æ›´å¤š core æ‰å¯ä»¥æœ‰æ•ˆåŠ é€Ÿé€™ä¸€äº›ä»»å‹™å€‘çš„åŸ·è¡Œ\næ­¤ç¨®é¡å‹å¤§éƒ¨åˆ† CPU ä½¿ç”¨ç‡éƒ½æ¥è¿‘æ»¿è¼‰\nI/O Bound:\nä»»å‹™å€‘è¢« CPU åŸ·è¡Œåˆ°ä¸€åŠå¸¸å¸¸éœ€è¦ç­‰å¾…ä¸€äº›æ±è¥¿ (è®€æª”æ¡ˆã€ç¶²è·¯å‚³è¼¸è³‡æ–™)ï¼Œæ‰èƒ½å†å›ä¾†è®“ CPU ç¹¼çºŒè¨ˆç®—ï¼Œå¦‚æœç¶²è·¯å‚³è¼¸é€Ÿåº¦æˆ–æ˜¯ç¡¬ç¢Ÿè®€å–é€Ÿåº¦åŠ å¿«ï¼Œå¯ä»¥å¤§å¹…åŠ é€Ÿé€™äº›ä»»å‹™\nCPU çš„ Loading å¤§éƒ¨åˆ†ä¸é«˜\nåœ¨ Part I è¬›è§£äº† context switch åœ¨ I/O Bound çš„ä»»å‹™ä¸Šæ˜¯å¥½çš„ï¼Œéœ€è¦ç­‰å¾… I/O æ™‚å…ˆæŠŠ CPU è®“çµ¦å…¶ä»–äººä½¿ç”¨ï¼Œç­‰åˆ° I/O çµæœæ™‚å†å›åˆ°ä½‡åˆ—ä¸­ç­‰å¾…è¢« CPU è¨ˆç®—ï¼Œé¿å… CPU ç©ºé–’æ²’äº‹åšã€‚\nåœ¨ Part II æ™‚æˆ‘å€‘è¬›è§£äº† Goroutine ç›¸æ¯”æ™®é€šçš„ OS thread å„ªå‹¢æ˜¯åœ¨å®ƒçš„è¨˜æ†¶é«”ç”¨é‡èˆ‡ context switch çš„é€Ÿåº¦ã€‚\næ‰€ä»¥æˆ‘å€‘çŸ¥é“ Goroutine æ‡‰è©²æœƒé©åˆç”¨åœ¨ I/O Bound çš„ä»»å‹™ä¸Šï¼Œ\næ–‡ç« å…§ä¹Ÿèˆ‰äº†å¹¾å€‹å¯¦éš›çš„ä¾‹å­ï¼Œæˆ‘å°±ä¸æŠŠå…¨éƒ¨éƒ½ copy éä¾†äº†ï¼Œä¸‹é¢ç°¡å–®çš„ä»‹ç´¹ä¸€ä¸‹\nAdding numbers ç¨‹å¼ç¢¼åœ¨ Listing 1 å…§ï¼Œç›®çš„æ˜¯è¦æŠŠä¸€å€‹é™£åˆ—è£¡çš„æ•¸å­—å…¨éƒ¨åŠ èµ·ä¾†ï¼Œä»»å‹™éƒ½æ˜¯éœ€è¦åšè¨ˆç®—ï¼Œæ²’æœ‰ç­‰å¾… I/O\nåˆ†ç‚ºå…©ç¨®åšæ³•\nä¸€ç¨®æ˜¯ sequential çš„æ–¹æ³•ï¼Œç”¨ä¸€å€‹ Gorutine æŠŠå…¨éƒ¨åŠ èµ·ä¾† ç¬¬äºŒç¨®æ˜¯ concurrentï¼Œæœ‰å…«å€‹ Goroutine å„è‡ªæŠŠå…«åˆ†ä¹‹ä¸€çš„é™£åˆ—åŠ ç¸½ï¼Œæœ€å¾Œå†åŠ åœ¨ä¸€èµ· Listing 4 åˆ—å‡ºä¾†ä½¿ç”¨ä¸€å€‹ core çš„çµæœï¼Œé¡¯ç„¶ sequential æ–¹æ³•è¼ƒå¿«ï¼Œ\nåœ¨åªæœ‰ä¸€å€‹ core çš„æƒ…æ³ä¸‹ï¼Œé€™ç¨® CPU Bound çš„ä»»å‹™ï¼Œå¤šäº†ä¸€äº› Goroutine åªæ˜¯æœƒç™¼ç”Ÿå¤šé¤˜çš„ context switch å°è‡´ç¸½æ™‚é–“æ‹‰é•·è€Œå·²ã€‚\nListing 5 åˆ—å‡ºäº†ä½¿ç”¨å…«å€‹ core çš„çµæœï¼Œæ¯å€‹ core ä¸Šå„æœ‰ä¸€å€‹ Goroutineï¼Œè¨ˆç®—èƒ½åŠ›å¤§å¹…å¢åŠ ï¼Œé€Ÿåº¦æ‡‰è©²æœƒæå‡\nå¯¦éš›ä¸Šé€Ÿåº¦å¿«äº† 40% å·¦å³ï¼Œç‚ºä»€éº¼ä¸æ˜¯å…«å€å‘¢?\nå¤§æ¦‚æ˜¯ç¨‹å¼ä¸€é–‹å§‹åªæœ‰ä¸€å€‹ threadï¼Œè¦å»é–‹å•Ÿå‰©ä¸‹ä¸ƒå€‹ os thread è·‘åœ¨ä¸åŒçš„ core ä¸Šé€ æˆçš„å»¶é²\nå¯ä»¥çœ‹åˆ° BenchmarkConcurrent-8 3362643 ns/opï¼Œæ¯åŠ ç¸½ä¸€æ¬¡ä¹Ÿæ‰èŠ±äº† 3ms å·¦å³ï¼Œthread çš„å‰µå»ºæä¸å¥½å°±ä½”äº†å¾ˆå¤§ä¸€éƒ¨åˆ†ï¼Œå¦‚æœæŠŠæ•¸å­—é™£åˆ—çš„é•·åº¦æ‹‰å¤§ï¼Œè¨ˆç®—æ™‚é–“æ›´ä¹…ï¼Œæ•ˆèƒ½æ‡‰è©²æœƒæ›´æ¥è¿‘å…«å€æ‰å°\nReading Files æ–‡ç« ä¸­åœ¨é€™éƒ¨åˆ†çµ¦çš„ç¯„ä¾‹æˆ‘è¦ºå¾—æ»¿å¥‡æ€ªçš„\nåœ¨ä¸€å€‹ Core ä¸Šä½¿ç”¨å¤šå€‹ Goroutine (thread) çš„å„ªå‹¢æ˜¯ç™¼ç¾ G è¢« block ä½æ™‚å¯ä»¥è®“å‡º CPUï¼Œç›¡å¯èƒ½ä½¿ç”¨ CPUï¼Œä½¿ I/O ç­‰å¾…èˆ‡ CPU é‹ç®—å¯ä»¥åŒæ™‚é€²è¡Œ\nä½†ç¯„ä¾‹ä¸­ä½¿ç”¨ time.Sleep ä¾†æ¨¡æ“¬è®€æª”æ¡ˆ\nä»–é€™æ¨£çš„åšæ³•æ‡‰è©²å¯ä»¥ä½¿ CPU é‹ç®—éƒ¨åˆ† (strings.Contains èˆ‡å…¶ä»– overhead) å’Œ sleep éƒ¨åˆ†åŒæ™‚é€²è¡Œæ²’éŒ¯ï¼Œå¯èƒ½æœ‰é”åˆ°ä¸€äº›åŠ é€Ÿçš„æ•ˆæœ\nä½†æ­£å¸¸ä¾†èªªè®€æª”æ¡ˆæ˜¯æœƒäº’ç›¸å¹²æ“¾çš„ï¼Œä¾‹å¦‚åœ¨åªæœ‰ä¸€å€‹ç¡¬ç¢Ÿçš„ç‹€æ³ä¸‹ï¼ŒGoroutine å†å¤šï¼Œç¡¬ç¢Ÿçš„æ•ˆèƒ½ä¹Ÿæ˜¯ç›¸åŒï¼Œå¤§å®¶æ‡‰è©²è¦æ’éšŠè®€ï¼Œä½† Sleep çš„ç‹€æ³å»æ˜¯é€™äº› Goroutine å¯ä»¥ä¸€èµ·åœ¨ç¡è‘—çš„ç‹€æ…‹(æ¨¡æ“¬äº†åŒæ™‚è®€æª”æ¡ˆ)\nListing 14 ä½¿ç”¨äº† 1 å€‹ core å‡ºä¾†çš„çµæœï¼Œå¤§éƒ¨åˆ†å…¶å¯¦å°±æ˜¯ 8 å€‹ Goroutine å¯ä»¥åŒæ™‚ç¡çœ çš„åŠ é€Ÿè€Œå·²\nListing 15 ç™¼ç¾ 8 core + 8 G å‡ºä¾†ç™¼ç¾æ²’æœ‰åŠ é€Ÿ(ç›¸æ¯” 1C 8G)ï¼Œæˆ‘æ¨æ¸¬æ‡‰è©²æ˜¯åŸæœ¬é‹ç®—çš„åœ°æ–¹å°±ä½”æ¯”ä¸é«˜äº†ï¼Œä¸€å€‹ core å°±å¤ è™•ç†é‹ç®—éƒ¨åˆ†ï¼Œå¤§éƒ¨åˆ†éƒ½åœ¨ç­‰ sleepï¼Œæ‰€ä»¥å¤šäº†å¹¾å€‹ coreï¼Œåªç”¨äº† 8 å€‹ Goroutineï¼Œèƒ½åŒæ™‚ç¡è‘—çš„ G ä¹Ÿåªæœ‰ 8 å€‹ï¼Œç­‰çš„æ™‚é–“é‚„æ˜¯å·®ä¸å¤š\nä¸‹é¢ç”¨ä¸€å¼µåœ–ä¾†è§£é‡‹åœ¨ä½•ç¨®æƒ…æ³ä¸‹é–‹å¤šå€‹ Goroutine æˆ–è€…ä½¿ç”¨æ›´å¤š Core èƒ½å¤ å¢åŠ æ•ˆèƒ½ï¼Œç¸®çŸ­ä»»å‹™å®Œæˆæ™‚é–“ã€‚\nä¸‹åœ–å‡è¨­\nå››ç¨®æƒ…æ³éƒ½æœ‰ä¸‰çµ„ä»»å‹™éœ€è¦åŸ·è¡Œã€‚æ¯çµ„éƒ½éœ€è¦ core è¨ˆç®— 10 ç§’ï¼Œæ¥è‘— I/O 5 ç§’ï¼Œå…©è€…é †åºä¸èƒ½èª¿æ› ä¸è¨ˆç®— context switch æ‰€èŠ±è²»çš„æ™‚é–“ ä¸åŒ Core å¯ä»¥åŒæ™‚åŸ·è¡Œè¨ˆç®— (CPU - 10 é‚£å€‹éƒ¨åˆ†) I/O æ˜¯å¤§å®¶å…±ç”¨ï¼ŒåŒæ™‚åªèƒ½æœ‰ä¸€çµ„ I/O åŸ·è¡Œï¼Œåœ¨åšå®Œä¸€çµ„ I/O ä¹‹å‰ä¸æœƒåˆ‡åˆ°å¦ä¸€çµ„ ç¬¬ (1) çµ„æ˜¯åºåˆ—åŸ·è¡Œï¼Œæ²’æœ‰ context switch ï¼ŒI/O æ™‚å®Œå…¨ç„¡æ³•åˆ©ç”¨ core ä¾†åšäº‹ï¼Œå¾ˆæ…¢\nç¬¬ (2) çµ„è®“ä¸€å€‹ core ä¸Šè·‘äº† 3 å€‹ Gï¼ŒG1 è¢« I/O block ä½æ™‚ï¼ŒG2çš„è¨ˆç®—å¯ä»¥å…ˆé–‹å§‹ï¼Œæ¯” (1) çš„æ•ˆç‡å¥½é»ï¼Œä½† I/O é‚„æ˜¯æœ‰ç©ºçª—æœŸ\nç¬¬ (3) çµ„å°±æ˜¯å¤šäº†ä¸€å€‹ coreï¼Œå¯ä»¥çœ‹åˆ°åœ¨ 10 ç§’ä¹‹å¾Œ I/O éƒ½è¢«æ’æ»¿äº†ï¼Œéƒ½æœ‰æœ‰æ•ˆåˆ©ç”¨\nç¬¬ (4) çµ„å†å¤šäº†ä¸€å€‹ core åŸ·è¡Œæ™‚é–“ä¸¦ç„¡ç¸®çŸ­ï¼Œå› ç‚º 10 ä¹‹å¾Œ I/O éƒ½æ’æ»¿äº†ï¼Œè€Œä¸”å¤šå¹¾å€‹ core ä¹Ÿç„¡æ³•ç¸®çŸ­ä¸€é–‹å§‹çš„è¨ˆç®—æ™‚é–“ 10 ç§’ (é™¤éå¯ä»¥æŠŠè¨ˆç®—æ‹†å°ä½†æ­¤è™•ä¸è€ƒæ…®)\nä¸Šåœ–å…¶å¯¦æ¯”è¼ƒåƒæ˜¯åœ¨è§£é‡‹å¹³è¡Œèˆ‡ä¸¦è¡Œåœ¨é€™ç¨®ä»»å‹™é¡å‹ä¸‹çš„è¡¨ç¾ï¼Œå› ç‚ºå…¶å¯¦æŠŠ Goroutine çœ‹æˆ thread ä¹Ÿèªªå¾—é€šã€‚åœ¨ Part II æ™‚æœ€å¾Œæœ‰èªªéï¼Œå…¶å¯¦ä»–å€‘åˆ‡æ›çš„æµç¨‹çœ‹èµ·ä¾†æ˜¯é¡ä¼¼çš„ï¼Œåªæ˜¯ Goroutine context switch çš„é€Ÿåº¦å¿«å¤šäº†ï¼Œè³‡æºæ¶ˆè€—ä¹Ÿå°‘é»ã€‚\né€™ç³»åˆ—çš„æ–‡ç« çš„å…§å®¹å·®ä¸å¤šå°±æ˜¯é€™æ¨£äº†\nç¸½çµä¸€ä¸‹ç¬¬ä¸€ç« ä»‹ç´¹äº† Go scheduler éœ€è¦çš„åŸºæœ¬ OS çŸ¥è­˜\nç¬¬äºŒç« å†é€éç°¡å–®çš„åœ–ç‰‡ä¾†çœ‹çœ‹ Go scheduler é‹ä½œçš„æ–¹å¼\næœ€å¾Œä»¥ä¾‹å­ä¾†çœ‹çœ‹ä¸åŒçš„ä»»å‹™é¡å‹åœ¨ Concurrency èˆ‡ Parallelism ä¸Šé¢é‹ä½œæƒ…æ³\näº†è§£äº†é€™äº›ä¹‹å¾Œï¼Œå¦‚æœé‡åˆ°è‡ªå·±çš„ç¨‹å¼æœ‰æ•ˆèƒ½ä¸Šçš„å•é¡Œï¼Œæˆ–è¨±å°±èƒ½çŸ¥é“å¾å“ªè£¡è‘—æ‰‹åˆ†æï¼Œçœ‹æ˜¯è¦å¤šé–‹å¹¾å€‹ Goroutine é‚„æ˜¯å¤šç§Ÿå¹¾å€‹ CPU ä¾†ç”¨å•¦ï½\n","description":"ç³»åˆ—æ–‡ä¹‹ä¸‰ï¼Œ ä¸€äº›å¯¦éš›çš„ä¾‹å­ï¼Œé‚„æœ‰ä¸¦è¡Œèˆ‡å¹³è¡Œ~","id":25,"section":"posts","tags":["Go","Goroutine","scheduler"],"title":"Scheduling in Go Part III","uri":"https://markogoodman.github.io/posts/scheduling-in-go-part-iii/"},{"content":"https://www.ardanlabs.com/blog/2018/08/scheduling-in-go-part2.html\nä»¥ä¸‹æˆªåœ–éƒ½æ˜¯å¾é€™å€‹ç¶²ç«™ä¾†çš„\nPart II: Go Scheduler é€™éƒ¨åˆ†è¦é–‹å§‹ä»‹ç´¹ Go çš„ Scheduler æ˜¯æ€éº¼é‹ä½œçš„ï¼Œä»¥åŠå®ƒçš„å„ªå‹¢åœ¨å“ªè£¡\nåœ¨ Go è£¡é¢åŸ·è¡Œ runtime.NumCPU() å¯ä»¥çŸ¥é“ç›®å‰çš„é›»è…¦æœ‰å¹¾å€‹ virtual core (çœ‹æœ‰å¹¾å€‹cpuã€å„æœ‰å¹¾å€‹æ ¸å¿ƒã€æ ¸å¿ƒä¸Šæœ‰å¹¾å€‹hardware thread)ï¼Œé€™ä¹Ÿæ˜¯ä½ çš„é›»è…¦æœ€å¤šå¯ä»¥å¹³è¡ŒåŸ·è¡Œçš„ä»»å‹™æ•¸é‡ (Part I æåˆ°é)ã€‚\nç”¨ runtime.GOMAXPROCS(n) å¯ä»¥è¨­å®š Go çµ¦äºˆ n å€‹ \u0026lsquo;P\u0026rsquo;, logical processorï¼Œè¨­å®š Go å¯ä»¥\u0026rsquo;é‚è¼¯ä¸Š\u0026rsquo;å¹³è¡ŒåŸ·è¡Œçš„ä»»å‹™æ•¸é‡ (ä¹Ÿå°±æ˜¯è¦æœ‰å¹¾å€‹ active thread)ã€‚\nç•¶ P çš„æ•¸é‡å¤§æ–¼å‰é¢ runtime.NumCPU() æ•¸é‡ï¼Œé€™äº› P å°±å¯èƒ½è¦å¸¸å¸¸äº¤æ›ä½¿ç”¨ core é€ æˆ context switch è² æ“”ã€‚\nå¦‚Part Iæ‰€èªªï¼Œå¦‚æœåŸ·è¡Œä¸­çš„ thread å¤ªå°‘å°±ç„¡æ³•åˆ©ç”¨å…¨éƒ¨çš„ coreï¼Œå¤ªå¤šçš„è©±é€™äº› thread æœƒéœ€è¦åš context switch æ¸›æ…¢é€Ÿåº¦ã€‚æ‰€ä»¥ Go å°±æŠŠé è¨­å€¼è¨­ç‚º runtime.NumCPU()çš„æ•¸é‡ã€‚\nä½†åœ¨å¾ˆå°‘æ•¸çš„æƒ…æ³ä¸‹ GOMAXPROCS è¨­é«˜åè€Œå¯ä»¥å¢åŠ ä¸€é»æ•ˆèƒ½ï¼Œåƒè€ƒ https://colobu.com/2017/10/11/interesting-things-about-GOMAXPROCS/\nGo Scheduler æ˜¯ä½¿ç”¨ä¸€å€‹å«åš GMP model çš„æ±è¥¿åŒ…å«ä»¥ä¸‹ä¸‰å€‹å…ƒä»¶\nG: Goroutine, ä¸€äº›è¦åšçš„ä»»å‹™\nM: Machine thread, å°±æ˜¯ OS å±¤ç´šçš„ thread\nP: Logical processor, å¯ä»¥æŠŠä»–æƒ³æˆä»»å‹™åŸ·è¡Œå™¨ï¼Œç®¡ç†è‡ªå·±çš„ queue (Local run queue)ï¼Œè£¡é¢æœ‰å¾ˆå¤š G å¾…åš\né™¤æ­¤ä¹‹å¤–é‚„æœ‰ä¸€å€‹ Global run queue å­˜æ”¾å­¤å…’ Goroutine\nè¦åŸ·è¡Œä»»å‹™è¨ˆç®—(G)æ™‚ï¼ŒP å¿…é ˆèˆ‡ä¸€å€‹ M æ¥åœ¨ä¸€èµ·ï¼Œä¸¦ä½¿ç”¨ä¸€å€‹ core ä¾†åŸ·è¡Œå¦‚ä¸‹åœ– (å¤¾åœ¨ M å’Œ P ä¸­é–“çš„å°±æ˜¯åŸ·è¡Œä¸­çš„ G)\nGoroutine states, context switch èˆ‡ thread ç›¸åŒï¼Œä¹Ÿæœ‰ ç­‰å¾…(ä¾‹å¦‚ç­‰IO)ã€å¯åŸ·è¡Œã€åŸ·è¡Œä¸­ä¸‰å€‹ç‹€æ…‹\nåŸ·è¡Œä¸­ä»£è¡¨ä¸Šåœ–ä¸­ G åœ¨ M èˆ‡ P ä¹‹é–“\nå¯åŸ·è¡Œçš„ G å°±æœƒåœ¨ local run queue æˆ– global run queue æ’éšŠç­‰è‘—è¢«åŸ·è¡Œ\nç­‰å¾…ç‹€æ…‹çš„ G éœ€è¦ç­‰å¾…æŸäº›è³‡æºæ‰èƒ½ç¹¼çºŒè¢«åŸ·è¡Œï¼Œå¯èƒ½æœƒåœ¨ Network poller ä¸­ç­‰å¾…éåŒæ­¥çš„å‹•ä½œï¼Œæˆ–è‘—èˆ‡ M ä¸€èµ·è¢« block ä½å¾Œå…©å€‹ä¸€èµ·å»æ—é‚Šç­‰å¾…ï¼Œ ä¸‹é¢çš„ 3. 4é»å°±æœƒå‡ºç¾é€™å€‹ç‹€æ…‹çš„ G\nGoroutine çš„ context switch å°‡ G å¾åŸ·è¡Œä¸­æ›ä¸‹ä¾†, æŠŠå…¶ä»– G æ›ä¸Šä¾†åŸ·è¡Œï¼Œä½†é€™åªç™¼ç”Ÿåœ¨å¿…è¦çš„æ™‚åˆ»ï¼Œç¶“å¸¸åšåªæœƒå¤šèŠ±æ™‚é–“\nå¯èƒ½ç™¼ç”Ÿçš„æƒ…æ³æœ‰å¹¾ç¨®\nç”¢ç”Ÿæ–°çš„ goroutine\ngo func()\u0026hellip; æœ‰å¯èƒ½æœƒc ontext switchï¼Œä½†ä¸ä¸€å®š\nGarbage collection\nGC æœ‰è‡ªå·±çš„ Goroutine è¦åšä¹Ÿéœ€è¦ M, æ‰€ä»¥è¦æŠŠå…¶ä»–Gæ›ä¸‹ä¾†ä¾†åŸ·è¡Œæ”¶åƒåœ¾å‹•ä½œ\nSynchronization and Orchestration\nä¾‹å¦‚ç­‰å¾… channel çš„è³‡æ–™è¢« block çš„æ™‚å€™, æˆ–è€…æ˜¯ mutext æœƒæŠŠ goroutine å¡ä½çš„å‹•ä½œéƒ½å¯èƒ½æœƒæœ‰ context switch\nsystem call\nåˆ†ç‚º asynchronous èˆ‡ synchronous system call\néåŒæ­¥çš„ç‹€æ³ï¼Œä¾‹å¦‚å¤§éƒ¨åˆ† OS ä¸­ Networking-based system callsï¼Œé€™ç¨®æƒ…æ³ G å¯ä»¥å¾ M å’Œ P ä¸Šæ‹”ä¸‹ä¾†ï¼Œå» Network poller ä¸­ç­‰å¾…çµæœ (ä¾é  OS çš„éåŒæ­¥ IO é”æˆï¼Œä¾‹å¦‚ epoll)ï¼Œéç¨‹å¯ä»¥åƒè€ƒç¶²é å…§ Figure 3,4,5 ï¼ŒG å¾—åˆ°çµæœä¹‹å¾Œå†æŠŠ G å¡å› queue ä¸­ç­‰å¾…åŸ·è¡Œã€‚æœŸé–“ M èˆ‡ P å¯ä»¥ç¹¼çºŒæ¶ˆåŒ–å…¶ä»– Gã€‚\nåŒæ­¥çš„ system call ä¾‹å¦‚æŸäº› File-based system callsï¼ŒæœƒæŠŠæ•´å€‹ M block ä½ (OS ç„¡æ³•éåŒæ­¥çš„è™•ç†é€™é¡å‹çš„ system call)ï¼Œé€™æ™‚åšé€™å€‹å‘¼å«çš„ G æœƒå’Œ M ä¸€èµ·è¢«æ”¾å»æ—é‚Šç­‰å¾…çµæœ (thread M æœƒè¢«å¾ core ä¸Š context switch ä¸‹ä¾†ï¼Œæ•ˆç‡æ¯”å‰ä¸€ç¨®å·®)ï¼Œä¸ä½”ç”¨ cpu è³‡æºï¼Œæµç¨‹åƒè€ƒç¶²é å…§ Figure 6,7,8ï¼Œè€Œ P æœƒå–å¾—ä¸€æ¢æ–°çš„ M (æ‰¾ idle çš„æˆ–æ–°å‰µä¸€æ¢) ä¾†åŸ·è¡Œå…¶ä»– Gã€‚ç•¶æ—é‚Šç­‰å¾…çš„ GM å¾—åˆ°çµæœå¾Œ G æœƒè¢«å¡å›åŸæœ¬çš„queueä¸­ï¼Œ M å‰‡æ˜¯è®Šæˆidelç­‰å…¶ä»–äººç”¨ï¼Œéœ€è¦æ™‚å°±ä¸å¿…æ–°å»º (æ­£ç¢ºä¾†èªªæ˜¯è®Šæˆ spinning threadï¼Œä¸»å‹•å»æ‰¾å­¤å…’Pé…å°ï¼Œä¹Ÿæœƒä½¿ç”¨åˆ° cpu è³‡æºï¼Œä½†é€šå¸¸æ¯”èµ·åˆªæ‰é‡å‰µä¾†çš„åˆ’ç®—ï¼Œåƒè€ƒ https://zhuanlan.zhihu.com/p/42057783)ã€‚\nWork Stealing ç°¡å–®ä¾†èªªå°±æ˜¯ P ç®¡ç†çš„ queue ä¸­çš„ G å¯ä»¥åœ¨ä¸åŒ P çš„ queue ä¹‹é–“ç§»å‹•\nç•¶ä¸€å€‹ P ç™¼ç¾è‡ªå·±æ²’æœ‰ G å¯ä»¥åšäº†ï¼Œæœ‰å¯èƒ½æœƒå» Global run queue æ’¿å·¥ä½œï¼Œä¹Ÿå¯èƒ½å»åˆ¥çš„ P æ¶å·¥ä½œä¾†åšã€‚\nç•¶ç„¶é€™ä¹Ÿè¦èŠ±æ™‚é–“ï¼Œå¤ªéé »ç¹çš„æ¬å‹• G ä¹Ÿä¸å¥½\næœ€å¾Œä½œè€…çµ¦äº†ä¸€å€‹ç¯„ä¾‹\nç¸½é«”ä¾†èªª goroutine åˆ‡æ›å’Œ thread ä¹‹é–“çš„åˆ‡æ›å¾ˆé¡ä¼¼ï¼Œä½† goroutine çš„ size å°ï¼Œæ‰€ä»¥å¯ä»¥å‰µé€ å¾ˆå¤šå€‹ï¼Œcontext switch é€Ÿåº¦ä¹Ÿå¿«å¾ˆå¤šï¼Œç›¸æ¯”ä»¥å¾€æ¯å€‹ä»»å‹™éƒ½é–‹å•Ÿä¸€æ¢ threadï¼Œä¹Ÿçœå»äº†è¨±å¤š thread çš„ç”¢ç”ŸéŠ·æ¯€è€—è²»ï¼Œæ‰€ä»¥é€Ÿåº¦èˆ‡è³‡æºä½¿ç”¨æ‰æœƒæ¯”è¼ƒå¥½\nä¸‹é¢é€™å¼µåœ–æ˜¯ä¸€å€‹éŸ“åœ‹äººçš„æŠ•å½±ç‰‡å…¶ä¸­çš„ä¸€é \nhttps://www.slideshare.net/Hyejong/golang-restful\nç¸½çµäº† Goroutine èˆ‡ thread è³‡æºçš„å·®è·\nPS. context switch æ™‚é–“ç´„æ˜¯ 200ns èˆ‡ 1000nsï¼Œ5å€çš„å·®è·\n","description":"ç³»åˆ—æ–‡ä¹‹äºŒï¼Œ Goroutine çš„æ˜¯æ€éº¼èª¿åº¦çš„èˆ‡ GMP model","id":26,"section":"posts","tags":["Go","Goroutine","scheduler"],"title":"Scheduling in Go Part II","uri":"https://markogoodman.github.io/posts/scheduling-in-go-part-ii/"},{"content":"ä¸€é–‹å§‹ç”¨ Go çš„ Map æ™‚å¸¸å¸¸æä¸æ¸…æ¥šåˆ°åº•è¦ä¸è¦å‚³æŒ‡æ¨™ï¼Œå¥½åƒå¤§éƒ¨åˆ†çš„æ™‚å€™éƒ½ä¸ç”¨ï¼Œä½†ç”¨åˆ° unmarshal ä¹‹é¡çš„ function å°±åˆè¦å‚³æŒ‡æ¨™é€²å»äº†ã€‚\né€™ç¯‡å°±ä¾†ç ”ç©¶ä¸€ä¸‹ Go çš„ Map åˆ°åº•æ˜¯ä»€éº¼ç”Ÿç‰©\nå…ˆçœ‹çœ‹ä¸‹é¢é€™æ®µç¨‹å¼ç¢¼\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 // mv = map value func ModifyMap(mv map[int]int) { mv[1] = 1 } // mp = map pointer func ModifyMapByPointer(mp *map[int]int) { (*mp)[1] = 1 } func main() { m1 := make(map[int]int) ModifyMap(m1) fmt.Println(m1) // map[1:1] m2 := make(map[int]int) ModifyMapByPointer(\u0026amp;m2) fmt.Println(m2) // map[1:1] } å…©å€‹ function éƒ½æ”¹åˆ° map è£¡é¢çš„å€¼äº†ï¼Œæ‰€ä»¥ç”¨ä¸ç”¨æŒ‡æ¨™åˆ°åº•æœ‰æ²’æœ‰å·®å‘¢?\nå†çœ‹çœ‹ä¸‹é¢é€™æ®µç¨‹å¼ç¢¼\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 func MakeMap(mv map[int]int) { mv = make(map[int]int) mv[1] = 1 } func MakeMapByPointer(mp *map[int]int) { (*mp) = make(map[int]int) (*mp)[1] = 1 } func main() { var m1 map[int]int MakeMap(m1) fmt.Println(m1) // map[] var m2 map[int]int MakeMapByPointer(\u0026amp;m2) fmt.Println(m2) // map[1:1] } é€™æ¬¡çš„ MakeMap çš„æ“ä½œå°±æ²’æœ‰åæ‡‰åˆ° main å‚³é€²å»çš„ m1 ä¸Šï¼Œé€™æ˜¯æ€éº¼å›äº‹å‘¢ï¼Ÿ\né¦–å…ˆç•¶æˆ‘å€‘ä½¿ç”¨ make ç”¢ç”Ÿ map æ™‚ï¼Œå®ƒå°±æ˜¯å›å‚³ä¸€å€‹ pointer çµ¦æˆ‘å€‘ã€‚ä¹Ÿå°±æ˜¯èªªç•¶æˆ‘å€‘å‘¼å«äº† m := make(map[int]int)ï¼Œm é€™å€‹è®Šæ•¸å…§å­˜çš„å…¶å¯¦æ˜¯ä¸€å€‹åœ°å€ï¼ŒæŒ‡åˆ°çœŸæ­£çš„ map structã€‚\nä¾†çœ‹çœ‹ç¬¬ä¸€çµ„ç¨‹å¼ç¢¼ç™¼ç”Ÿäº†ä»€éº¼äº‹\nç°¡å–®ä¾†èªªå°±æ˜¯ m1 æŠŠ map çš„åœ°å€ x å‚³é€²å» ModifyMapï¼Œmv å…§å°±å­˜è‘—ç›¸åŒçš„å€¼ xï¼Œæ‰€ä»¥å¯ä»¥æ”¹åˆ°çœŸæ­£çš„ map structã€‚\n1 2 3 4 5 6 7 func ModifyMap(mv map[int]int) { mv[1] = 1 } m1 := make(map[int]int) ModifyMap(m1) fmt.Println(m1) // map[1:1] ä¸‹é¢é€™éƒ¨åˆ†ï¼Œæ˜¯æŠŠ m2 æœ¬èº«çš„ä½ç½® y å‚³é€² ModifyMapByPointerï¼Œ mp å°±å­˜è‘— m2 çš„ä½ç½® yã€‚\næ¥è‘—é€éæŒ‡æ¨™æ”¹åˆ°äº† map struct\n1 2 3 4 5 6 7 func ModifyMapByPointer(mp *map[int]int) { (*mp)[1] = 1 } m2 := make(map[int]int) ModifyMapByPointer(\u0026amp;m2) fmt.Println(m2) // map[1:1] å†ä¾†çœ‹çœ‹åœ¨ function è£¡é¢ make map æœƒæ€éº¼æ¨£\né€™è£¡ m1 ä¸€é–‹å§‹æ˜¯ nilï¼Œå‚³é€² MakeMap çš„æ±è¥¿ä¹Ÿæ˜¯ nilï¼Œè‡ªç„¶ mv å…§ä¹Ÿæœƒå­˜è‘— nilã€‚\næ¥è‘—å‘¼å«äº† makeï¼Œmv = make(map[int]int)æŠŠçœŸæ­£ map struct çš„åœ°å€å­˜åˆ°äº† mv å…§ï¼Œmv[1] = 1ä¹Ÿæ˜¯çœŸçš„æœ‰æ”¹åˆ° map è£¡é¢çš„å€¼ï¼Œåªæ˜¯å¤–é¢çš„ m1 å…§å­˜çš„å€¼é‚„æ˜¯ nilï¼Œæ‰€ä»¥æˆ‘å€‘ print å‡ºä¾†çš„ä¹Ÿå°±æ˜¯ç©º map äº†ã€‚\n1 2 3 4 5 6 7 8 func MakeMap(mv map[int]int) { mv = make(map[int]int) mv[1] = 1 } var m1 map[int]int MakeMap(m1) fmt.Println(m1) // map[] æœ€å¾Œä¸€éƒ¨åˆ†çš„ç¯„ä¾‹ï¼Œm2 çš„åœ°å€ y å‚³é€²äº† MakeMapByPointerï¼Œmp å…§å­˜è‘—çš„æ˜¯ m2 çš„åœ°å€ï¼Œç•¶å‘¼å«(*mp) = make(map[int]int)æ™‚æ‰€ä»£è¡¨çš„æ˜¯ç”¢ç”Ÿä¸€å€‹ map structï¼Œä¸¦æŠŠè©²åœ°å€ x å­˜é€² mp æ‰€æŒ‡åˆ°çš„è®Šæ•¸å…§ï¼Œä¹Ÿå°±æ˜¯ m2 çš„å€¼ä¸­ï¼Œæ‰€ä»¥å¾ŒçºŒçš„æ›´æ”¹æˆ‘å€‘ä¹Ÿå¯ä»¥å¾ m2 çœ‹åˆ°æ‹‰\n1 2 3 4 5 6 7 8 func MakeMapByPointer(mp *map[int]int) { (*mp) = make(map[int]int) (*mp)[1] = 1 } var m2 map[int]int MakeMapByPointer(\u0026amp;m2) fmt.Println(m2) // map[1:1] è‡³æ–¼çœŸæ­£çš„ map struct æ˜¯ä¸€å€‹å«åš hmap çš„æ±è¥¿ï¼Œé€™é‚Šå°±ä¸è¬›é‚£éº¼ç´°ï¼Œå‰©ä¸‹çš„ä¸Šç¶²ä¼°ç‹— Go makemap hmap ä¹‹é¡çš„é—œéµå­—éƒ½å¯ä»¥æ‰¾åˆ°åš•\n","description":"ä¸€é–‹å§‹ç”¨ Go çš„ Map æ™‚å¸¸å¸¸æä¸æ¸…æ¥šåˆ°åº•è¦ä¸è¦å‚³æŒ‡æ¨™ï¼Œå¥½åƒå¤§éƒ¨åˆ†çš„æ™‚å€™éƒ½ä¸ç”¨ï¼Œä½†ç”¨åˆ° unmarshal ä¹‹é¡çš„ function å°±åˆè¦å‚³æŒ‡æ¨™é€²å»äº†??","id":27,"section":"posts","tags":["Go","map","pointer"],"title":"Go çš„ MAP è¦ä¸è¦ç”¨æŒ‡æ¨™","uri":"https://markogoodman.github.io/posts/go-map/"},{"content":"é—œæ–¼é€™ç³»åˆ—æ–‡ ä¹‹å‰çœ‹äº† Ardan labs å¯«çš„ä¸‹é¢é€™å€‹ç³»åˆ—æ–‡é‚„æ»¿ä¸éŒ¯çš„\nhttps://www.ardanlabs.com/blog/2018/08/scheduling-in-go-part1.html\nä¸»è¦æ˜¯åœ¨è¬› Goroutine å’Œä¸€èˆ¬æˆ‘å€‘çœ‹åˆ°çš„ thread æ¯”èµ·ä¾†åˆ°åº•å²å®³åœ¨å“ªè£¡ï¼Œä¹Ÿèˆ‰äº†ä¸€äº›ç¯„ä¾‹è®“è®€è€…çŸ¥é“ Goroutine ç”¨åœ¨å“ªè£¡æ‰æ˜¯æ­£ç¢ºçš„\né€™ç³»åˆ—æ–‡ç« å°±æ˜¯æ‹¿ä¾†è¨˜å€‹é‡é»XD\nä»–çš„ç³»åˆ—æ–‡åˆ†ç‚ºä¸‰ç¯‡ï¼Œæˆ‘ä¹Ÿå°±åˆ†ä¸‰ç¯‡è¨˜\nPart I: OS Scheduler é€™å€‹ç« ç¯€ä¸è¬› Goroutine è¬›ä¸€äº› OS è¦çŸ¥é“çš„é å‚™çŸ¥è­˜ï¼Œä¹Ÿä¸æœƒæ¶‰åŠå¤ªå¤šç´°ç¯€ã€‚\nProcessã€Threadã€Coroutine ä¸‹åœ–æ˜¯ Learning Concurrency in Kotlin é€™æœ¬æ›¸è£¡é¢çš„ä¸€å¼µåœ–ï¼Œè§£é‡‹äº† Processã€Threadã€Coroutine çš„é—œä¿‚ã€‚\nProcess Process æ˜¯ OS åˆ†é…è³‡æºçš„åŸºæœ¬å–®ä½ (è¨˜æ†¶é«”ä¹‹é¡çš„)\nç°¡å–®ä¾†èªªæŠŠä¸€å€‹ç¨‹å¼ (program) è·‘èµ·ä¾†å°±æ˜¯ä¸€å€‹ processï¼Œä¸€é–‹å§‹ process å…§æœƒæœ‰ä¸€æ¢åˆå§‹çš„ thread ä¾†è·‘ä¸»è¦ç¨‹å¼ï¼Œé€™æ¢ thread å¯ä»¥å»ºç«‹å‡ºæ›´å¤š threadï¼Œæ¯å€‹ process è£¡é¢å¯ä»¥è£ä¸€å † threadã€‚\nThread Thread (kernel thread) æ˜¯ OS åˆ†é… CPU åŸ·è¡Œæ™‚é–“çš„å–®ä½ï¼Œåªèƒ½å­˜åœ¨æ–¼ process å…§ï¼Œå¸¸è¢«å«åš light-weight processã€‚\nåœ¨å¤§å¤šæˆ‘å€‘ä½¿ç”¨çš„ä½œæ¥­ç³»çµ±ä¸­ï¼Œthread çš„æ’ç¨‹éƒ½æ˜¯ preemptive (å¯æ¶ä½”)\u0008ï¼Œä»£è¡¨è‘—ä¸€æ¢ thread å°±ç®—ç¾åœ¨åœ¨ CPU ä¸ŠåŸ·è¡Œï¼Œéš¨æ™‚ä¹Ÿå¯èƒ½è¢«å„ç¨®åŸå› æ›ä¸‹ä¾†ï¼ŒåŸºæœ¬ä¸Šéƒ½æ˜¯ç”± OS ä¾†ç®¡ç†çš„ã€‚\nCPU å¾æ­£åœ¨åŸ·è¡Œ thread A çš„ä»»å‹™é¾ï¼Œæ›åˆ°åŸ·è¡Œ thread B çš„ä»»å‹™ï¼Œé€™å€‹è¡Œç‚ºå«åš context switchã€‚ Thread ä¹‹é–“æœ‰å“ªäº›å…±ç”¨èˆ‡ä¸å…±ç”¨çš„æ±è¥¿é€™é‚Šå°±ä¸å¤šè¬›ç¶²è·¯ä¸Šå¾ˆå¤šæ–‡ç« å¯ä»¥æŸ¥åˆ°ã€‚\næä¾›å…©ç¯‡æ–‡ç« åƒè€ƒ\nhttps://medium.com/@yovan/os-process-thread-user-kernel-%E7%AD%86%E8%A8%98-aa6e04d35002\nhttps://www.itread01.com/content/1546525452.html\nå¤§å­¸ä¸Šçš„ OS èª²ç¨‹å¤§æ¦‚å°±æ˜¯ä»‹ç´¹äº†ä¸Šé¢é‚£äº›æ±è¥¿è€Œå·²ã€‚\nCoroutine å†ä¾†ä»‹ç´¹çš„ coroutine (goroutine å°±æ˜¯ä¸€ç¨®)ï¼ŒåŸºæœ¬ä¸Šä½œæ¥­ç³»çµ±ä¸çŸ¥é“æœ‰é€™å€‹æ±è¥¿çš„å­˜åœ¨ï¼ŒOS åªè² è²¬åŸ·è¡Œ thread ä¸Šé¢çš„ä¸€å †ä»»å‹™è€Œå·²ã€‚coroutine éƒ½æ˜¯ç”±æˆ‘å€‘ä½¿ç”¨çš„ç¨‹å¼èªè¨€ä¾†è™•ç†ï¼Œè€Œæ¯å€‹ç¨‹å¼èªè¨€æä¾›çš„ coroutine é‹ä½œæ–¹å¼éƒ½æœ‰äº›ä¸åŒã€‚\ncoroutine ä¹Ÿå«åš light-weight thread æˆ–è€…æ˜¯ user-level threadï¼Œæ˜¯è·‘åœ¨ kernel thread ä¸Šçš„ä¸€å †æ±è¥¿ã€‚\nåŸºæœ¬ä¸Š coroutine åšçš„äº‹æƒ…å°±æ˜¯å¯ä»¥è®“ function åŸ·è¡Œåˆ°ä¸€åŠä¸­æ–·ï¼ŒæŠŠ CPU æ™‚é–“è®“çµ¦åˆ¥çš„ coroutine ä¾†åŸ·è¡Œä»–å€‘çš„å·¥ä½œ\u0008\nèˆ‰å€‹ç°¡å–®çš„æ‡‰ç”¨ä¾‹å­ï¼Œç•¶ Coroutine A åšäº‹æƒ…åšåˆ°ä¸€åŠï¼Œç™¼ç¾è¦ç­‰å¾…è®€å–æª”æ¡ˆæˆ–æ˜¯ç­‰ä¸€äº›ç¶²è·¯å‚³è¼¸çš„è³‡æ–™æ‰å¯ä»¥åŸ·è¡Œä¸‹ä¸€æ­¥ï¼Œè€Œé€™äº›å·¥ä½œåˆæ˜¯ä¸éœ€è¦ CPU çš„ï¼Œé‚£ coroutine A å°±å¯ä»¥æŠŠ CPU çš„æ™‚é–“è®“çµ¦ä¸‹ä¸€å€‹ coroutine Bï¼Œç­‰å¾…éœ€è¦çš„æ±è¥¿å›ä¾†ä¹‹å¾Œå†å¾ä¸­æ–·é»ç¹¼çºŒå·¥ä½œã€‚\nèˆ‡ thread ç›¸æ¯”ï¼Œ coroutine çš„ size æ›´å°ï¼Œåƒæ˜¯åœ¨ Go å‰µå»ºä¸€å€‹æ–°çš„ goroutine å°±åªèŠ±è²»å¹¾ KBï¼Œä¸€æ¢ java thread å»è¦åˆ° 1~2 MBã€‚\nè€Œä¸Šé¢é‚£ç¨®åˆ‡æ› coroutine çš„è¡Œç‚ºå…¶å¯¦æ˜¯ç¨® coroutine context switchã€‚å¦‚æœ coroutine A èˆ‡ coroutine B æ˜¯åœ¨åŒä¸€å€‹ threadï¼Œåˆ‡æ›æ™‚æ™‚ OS ä¸¦ä¸æœƒç™¼ç¾ï¼Œä¹Ÿä¸æœƒå‡ºç¾ thread çš„ context switchã€‚\nCoroutine çš„ context switch èˆ‡ thread çš„ æ¯”èµ·ä¾†é€Ÿåº¦ä¹Ÿå¿«å¾ˆå¤šï¼Œè¦å„²å­˜èˆ‡è¼‰å…¥çš„è³‡æ–™é‡ç›¸å·®å¾ˆå¤§ã€‚\né€™éƒ¨åˆ†ä¹‹å¾Œè¬› goroutine æ™‚æœƒå†æåˆ°ã€‚\nè¶Šå¤š Thread çœŸçš„æœƒè®“ç¨‹å¼è·‘è¶Šå¿«å— ? ç­”æ¡ˆæ˜¯ä¸æœƒ\né€™éƒ¨åˆ†å…ˆä¸è¨è«– coroutineï¼Œå–®ç´”å°± multi-thread çš„ç¨‹å¼ä¾†èªªæ˜\né€²å…¥æ­£é¡Œå‰å¿…é ˆå…ˆç†è§£ï¼Œä¸€å€‹ thread æœƒåšçš„å·¥ä½œä¸»è¦åˆ†ç‚ºé€™å…©ç¨®\nCPU-bound\næŒ‡çš„æ˜¯ CPU å¤§éƒ¨åˆ†æ™‚é–“éƒ½å¾ˆå¿™çš„å·¥ä½œé¡å‹ã€‚è­¬å¦‚è¨ˆç®—ä¸€å€‹è¶…å¤§ int é™£åˆ—çš„ç¸½å’Œï¼ŒCPU å°±æ˜¯ä¸€ç›´åšåŠ æ³•ï¼Œè¶…å¿™ã€‚\nIO-bound\nCPU å¸¸å¸¸æœƒæ²’äº‹åšï¼Œå¯èƒ½éƒ½åœ¨ç­‰è‘—ç¡¬ç¢Ÿè®€å®Œæª”æ¡ˆçš„é€šçŸ¥ï¼Œæˆ–è€…ç¶²è·¯å‚³è¼¸çµæŸçš„é€šçŸ¥ç­‰ç­‰ã€‚\nç°¡å–®çš„ä¾‹å­åƒæ˜¯æŠŠä¸€å †æª”æ¡ˆä¸€å€‹ä¸€å€‹è®€é€²ä¾†ï¼Œåšä¸€é»é»ä¿®æ”¹å†å¯«å›å»ï¼Œå°±æœƒèŠ±å¾ˆå¤šæ™‚é–“åœ¨è®€å¯«æª”æ¡ˆï¼ŒCPU æ²’ä»€éº¼äº‹æƒ…å¥½åšã€‚\nåŸºæœ¬ä¸Š context switch åœ¨ IO-bound çš„å·¥ä½œä¸Šæ˜¯å¥½çš„ï¼Œç•¶ä¸€å€‹ä»»å‹™éœ€è¦ç­‰å¾… IO æ™‚ï¼Œä¾¿æ›ä¸‹ä¾†è®“éœ€è¦ CPU çš„äººç”¨ï¼Œé¿å…è®“ CPU idleã€‚\nåœ¨ CPU-bound çš„å·¥ä½œä¸Š context switch éœ€è¦å¤šèŠ±æ™‚é–“ï¼Œåªæœƒæ‹–æ…¢å®Œæˆå…¨éƒ¨ä»»å‹™çš„æ™‚é–“è€Œå·²ï¼Œä½†æœ‰æ™‚ç‚ºäº†è®“ä½¿ç”¨è€…è¦ºå¾—æ¯å€‹ä»»å‹™éƒ½æœ‰åœ¨é€²è¡Œï¼Œcontext switch æ˜¯å¿…é ˆçš„ã€‚\nå›ä¾†è¬› thread æ•¸é‡çš„å•é¡Œ\nç•¶æ©Ÿå™¨æœ‰ n å€‹ coreï¼Œä»£è¡¨åŒæ™‚æœ€å¤šä¹Ÿåªèƒ½åŸ·è¡Œ n å€‹ threadï¼Œè‹¥ thread æ•¸é‡å°‘æ–¼ n çš„è©±ï¼Œå¿…ç„¶æœƒæœ‰ core æ²’äº‹æƒ…åšï¼Œé¡¯ç„¶æ˜¯ä¸å¥½ã€‚\nå¦‚æœ thread æ•¸é‡å¤§æ–¼ n å¤ªå¤šï¼Œé‚£å°±æœƒå¸¸å¸¸åœ¨åŸ·è¡Œ context switch è€Œæµªè²»æ™‚é–“ï¼Œä¸” thread æœƒä½”ç”¨ä¸å°‘è¨˜æ†¶é«”ã€‚\nè¦å–å¾—å¹³è¡¡å¿…é ˆçŸ¥é“è‡ªå·±çš„ç³»çµ±æ˜¯åœ¨åš CPU-bound é‚„æ˜¯ IO-bound çš„ä»»å‹™å¤šï¼Œå‰è€… thread å°‘é» (ä½†é‚„æ˜¯è¦ \u0026gt;= n)ï¼Œå¾Œè€… thread å¤šé»ã€‚\nç•¶å¯«ä¸€å€‹æœ‰ database çš„ web serviceï¼Œæœ€å¸¸ä½¿ç”¨çš„ thread æ•¸é‡æ˜¯ n * 3ï¼Œå°±æ˜¯ä¸€å€‹å¤§å®¶çš„ç¶“é©—æ³•å‰‡è€Œå·²ã€‚\nç¸½çµï¼Œæˆ‘å€‘å¸Œæœ›æ¯å€‹ CPU ç„¡æ™‚ç„¡åˆ»éƒ½åœ¨å·¥ä½œï¼Œæ‰èƒ½æœ‰æœ€å¤§çš„ç”¢å‡º\nç•¶ä¸€å€‹ thread ç­‰å¾… IO æ™‚å°±æŠŠä»–æ›ä¸‹ä¾†ï¼Œè®“ CPU ç¹¼çºŒå·¥ä½œ\nç•¶ä¸€å€‹ thread æ­£åœ¨è¢« CPU åŸ·è¡Œæ™‚ï¼Œæˆ‘å€‘å°±ç›¡é‡ä¸è¦æ‰“æ“¾ä»–\næ¥è‘— Part II æœƒä¾†ä»‹ç´¹ Go çš„ scheduler æ˜¯æ€éº¼é‹ä½œçš„ï¼Œä»–ç‚ºä»€éº¼è®“ Goroutine æ¯” thread é‚„æœ‰æ•ˆç‡\n","description":"ç³»åˆ—æ–‡ä¹‹ä¸€ï¼ŒArdan labs çš„ Scheduling in Go ç³»åˆ—æ–‡èªªæ˜äº† Goroutine åˆ°åº•å“ªè£¡å²å®³ï¼Œä»¥åŠé©åˆçš„ä½¿ç”¨æƒ…å¢ƒï¼Œé€™ç¯‡æ–‡ç« å°±æ˜¯è¦è¨˜éŒ„ä¸€ä¸‹é‡é»ä¹‹å¾Œå¿˜è¨˜å°±å¯ä»¥ç›´æ¥çœ‹äº†","id":28,"section":"posts","tags":["Go","Goroutine","scheduler"],"title":"Goroutine ç‚ºå•¥é‚£éº¼å¿« (Scheduling in Go) Part I","uri":"https://markogoodman.github.io/posts/scheduling-in-go-part-i/"},{"content":"å‰å¹¾å¤©å¹«åŸæœ¬å·²ç¶“æœ‰è³‡æ–™çš„ collection æ–°å»º unique index çš„æ™‚å€™è®“ Server å•Ÿå‹•çˆ†æ‰äº†è¨˜éŒ„ä¸€ä¸‹\n1 2 3 db.coll.insert({\u0026#34;a\u0026#34;:1}) db.coll.insert({\u0026#34;a\u0026#34;:2}) db.coll.createIndex({\u0026#34;b\u0026#34;:1}, {unique: true}) // duplicate key error åœ¨ä¸€å€‹ä¹‹å‰è³‡æ–™éƒ½æ²’æœ‰çš„ field ä¸Šå»º unique indexï¼Œçµæœå™´å‡ºäº†ä¸‹é¢çš„éŒ¯èª¤\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 { \u0026#34;operationTime\u0026#34; : Timestamp(1609329527, 19822385), \u0026#34;ok\u0026#34; : 0, \u0026#34;errmsg\u0026#34; : \u0026#34;E11000 duplicate key error collection: test.coll index: b_1 dup key: { b: null }\u0026#34;, \u0026#34;code\u0026#34; : 11000, \u0026#34;codeName\u0026#34; : \u0026#34;DuplicateKey\u0026#34;, \u0026#34;keyPattern\u0026#34; : { \u0026#34;b\u0026#34; : 1 }, \u0026#34;keyValue\u0026#34; : { \u0026#34;b\u0026#34; : null }, \u0026#34;$clusterTime\u0026#34; : { \u0026#34;clusterTime\u0026#34; : Timestamp(1609329527, 19822385), \u0026#34;signature\u0026#34; : { \u0026#34;hash\u0026#34; : BinData(0,\u0026#34;AAAAAAAAAAAAAAAAAAAAAAAAAAA=\u0026#34;), \u0026#34;keyId\u0026#34; : NumberLong(0) } } } errmsgå…§å¤§è‡´æ˜¯åœ¨èªªåœ¨ b_1 é€™å€‹ index (å¹« b å»ºç«‹ index æ™‚å€™ MongoDB å¹«å–çš„åå­—)ä¸Šï¼Œç™¼ç”Ÿäº† b = null çš„ duplicate keyã€‚å› ç‚ºå‰é¢å¡é€²å»çš„å…©ç­†éƒ½æ²’æœ‰ b ï¼Œå»ºç«‹ index æ™‚ MongoDB è‡ªå‹•æŠŠä»–å€‘è¦–ç‚º null å€¼ï¼Œæ‰€ä»¥å…©ç­†è³‡æ–™å°±æ’åœ¨ä¸€èµ·äº†ã€‚\næ­¤æ™‚æ¯”è¼ƒæ­£å¸¸çš„è§£æ³•æ˜¯è·‘ç¨‹å¼åšè³‡æ–™åº«çš„ schema migrationï¼ŒæŠŠä¹‹å‰çš„è³‡æ–™éƒ½è£œä¸Šè©² field çš„å€¼ã€‚\nä½†å¦‚æœæ–°åŠ çš„ key æœ¬ä¾†å°±ä¸æƒ³èˆ‡ä»¥å‰è³‡æ–™ç›¸å®¹è©²æ€è¾¦å“©?\næœ‰ä¸‹é¢å…©å€‹è§£æ±ºæ–¹æ³•\nç¬¬ä¸€å€‹æ˜¯å·²ç¶“éæ™‚çš„ç”¨æ³•ï¼Œå®˜æ–¹å»ºè­° mongodb 3.2ç‰ˆä¹‹å¾Œå°±å»ºè­°ä½¿ç”¨ç¬¬äºŒç¨®æ–¹å¼å–ä»£ã€‚\nsparse: true å¯ä»¥è®“ MongoDB å»º index æ™‚ç›´æ¥å¿½ç•¥æ²’æœ‰é€™å€‹ field çš„è³‡æ–™(ä¸åƒä¸Šé¢æŠŠ field çš„å€¼ç•¶ä½œ null )ï¼Œæ‰€ä»¥å°±ä¸æœƒæœ‰ duplicate key erroräº†ã€‚ 1 db.coll.createIndex({\u0026#34;b\u0026#34;:1}, {unique: true, sparse: true}) ç¬¬äºŒç¨®æ˜¯ä½¿ç”¨ partial index\nPartial index æŒ‡çš„æ˜¯ç”¨æŸäº›æ¢ä»¶å»æ±ºå®šæ˜¯å¦è¦åœ¨è©²ç­†è³‡æ–™ä¸Šå»º indexï¼Œä¸‹é¢é€™å€‹ä¾‹å­å°±ä½¿ç”¨äº† $exists: true ä¾†éæ¿¾ï¼Œåªæœ‰è³‡æ–™å…§å­˜åœ¨ b é€™å€‹ field çš„è³‡æ–™ï¼Œæˆ‘å€‘æ‰åœ¨ b ä¸Šé¢å»ºç«‹ unique indexã€‚ 1 2 3 4 5 6 7 8 9 db.coll.createIndex( {\u0026#34;b\u0026#34;:1}, { unique: true, partialFilterExpression:{ \u0026#34;b\u0026#34;: {$exists: true} } } ) PartialFilterExpression å¾Œé¢ä¹Ÿå¯ä»¥æ¥å¾ˆå¤šä¸åŒçš„æ¢ä»¶\nä¾‹å¦‚ \u0026ldquo;b\u0026rdquo;: {$gt: 1} ï¼Œå°±å¯ä»¥éæ¿¾å‡ºé‚£äº› a field å¤§æ–¼ 1 çš„è³‡æ–™ä¸¦åœ¨é€™äº›è³‡æ–™ä¸Šå»º indexã€‚\nå·®ä¸å¤šå°±é˜¿æ\n","description":"å‰å¹¾å¤©å¹«åŸæœ¬å·²ç¶“æœ‰è³‡æ–™çš„ collection æ–°å»º unique index çš„æ™‚å€™è®“ Server å•Ÿå‹•çˆ†æ‰äº†è¨˜éŒ„ä¸€ä¸‹","id":29,"section":"posts","tags":["mongodb","index","database"],"title":"Mongodb Partial and Sparse Index","uri":"https://markogoodman.github.io/posts/mongodb-partial-sparse-index/"},{"content":"èª’\u0026hellip;\n","description":"","id":30,"section":"","tags":null,"title":"About","uri":"https://markogoodman.github.io/about/"},{"content":"æ±ª\n","description":"","id":31,"section":"posts","tags":null,"title":"My First Post","uri":"https://markogoodman.github.io/posts/my-first-post/"}]